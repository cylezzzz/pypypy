<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Model Hub – AndioMediaStudio</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <style>
    .layout{display:grid;grid-template-columns:300px 1fr;gap:12px}
    .card{background:#1112;border:1px solid #333;border-radius:12px;padding:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    .thumb{width:100%;aspect-ratio:16/10;object-fit:cover;border-radius:10px;border:1px solid #222;background:#000}
    .badge{padding:2px 6px;border-radius:8px;background:#222;border:1px solid #444;font-size:12px}
    .pill{border:1px solid #444;border-radius:999px;padding:4px 10px;font-size:12px}
    .muted{opacity:.8}
    .stat{font-size:12px;color:#bdbdbd}
    .k{display:inline-flex;gap:6px;align-items:center}
    .k img{width:24px;height:24px;border-radius:6px;border:1px solid #222;background:#000;object-fit:cover}
    .actions{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .progress{height:8px;background:#222;border:1px solid #333;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;width:0%;background:linear-gradient(90deg,#6af,#9cf)}
    .sticky{position:sticky;top:72px}
  </style>
</head>
<body>
  <script src="assets/app.js"></script>
  <!-- 1) Deine Originaldatei zuerst laden -->
  <script src="assets/presets.de.js"></script>
  <!-- 2) Normalizer/Bridge -->
  <script src="assets/presets.loader.js"></script>

  <script>if (window.Andio?.navbar) Andio.navbar('images');</script>

  <div class="container">
    <h1>Model Hub</h1>
    <div class="layout">
      <!-- Sidebar Filter -->
      <aside class="card sticky">
        <h3>Filter</h3>
        <div class="grid">
          <input id="q" placeholder="Suche (Name, Tag, Kategorie)"/>
          <label>Kategorie
            <select id="cat"></select>
          </label>
          <label>Tag
            <select id="tag"></select>
          </label>
          <label>Basis
            <select id="base">
              <option value="">alle</option>
              <option value="sdxl">SDXL</option>
              <option value="sd15">SD 1.5</option>
            </select>
          </label>
          <div class="row">
            <span class="pill">SFW <input type="checkbox" id="sfwOnly"></span>
            <span class="pill">NSFW <input type="checkbox" id="nsfwOnly"></span>
          </div>
          <div class="row">
            <button id="btnRandom">Random</button>
            <button id="btnRefresh">Aktualisieren</button>
          </div>

          <details class="card">
            <summary>Installationsziel</summary>
            <div class="grid">
              <label>Checkpoint-Verzeichnis
                <input id="dirCkpt" placeholder="/models/checkpoints"/>
              </label>
              <label>LoRA-Verzeichnis
                <input id="dirLora" placeholder="/models/lora"/>
              </label>
              <label>VAE-Verzeichnis
                <input id="dirVae" placeholder="/models/vae"/>
              </label>
            </div>
            <small class="muted">Diese Pfade gibt das Backend vor – hier nur UI-Wunsch; das Backend darf überschreiben.</small>
          </details>
        </div>
      </aside>

      <!-- Hauptbereich -->
      <main class="grid grid-4" id="models"></main>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Kategorien</h3>
      <div class="grid grid-3" id="cats"></div>
    </div>
  </div>

  <footer>© AndioMediaStudio</footer>

  <script>
  (()=>{
    const $ = s=>document.querySelector(s);
    const modelsHost = $('#models');
    const catsHost = $('#cats');

    // === Dropdowns befüllen ===
    function fillFilters(){
      const cats = Andio.presets.getCategories() || [];
      const tags = Andio.presets.getTags() || [];
      const selCat = $('#cat'); selCat.innerHTML = '<option value="">alle</option>';
      cats.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; selCat.appendChild(o); });
      const selTag = $('#tag'); selTag.innerHTML = '<option value="">alle</option>';
      tags.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTag.appendChild(o); });
    }

    // === Render: Modelle ===
    function renderModels(list){
      modelsHost.innerHTML='';
      if(!list.length){ modelsHost.innerHTML='<div class="card">Keine Modelle gefunden.</div>'; return; }
      list.forEach(m=>{
        const div = document.createElement('div');
        div.className='card';
        const sampleLine = (m.example || m.samples || m.examples || [])
          .slice?.(0,4)
          .map(s=>`<span class="k"><img src="${s}" alt="sample"/></span>`)
          .join('') || '';

        const size = m.size || m.files?.size || m.files?.ckpt_size || null;
        const sz = size ? `<span class="stat">• ${size}</span>` : '';

        div.innerHTML = `
          <img class="thumb" src="${m.img || m.example || 'assets/placeholders/model.jpg'}" alt="${m.name}"/>
          <h3>${m.name}</h3>
          <p class="muted">${m.desc || ''}</p>
          <div class="row">
            ${(m.tags||[]).slice(0,5).map(t=>`<span class="badge">${t}</span>`).join('')}
            ${m.base ? `<span class="badge">${m.base.toUpperCase()}</span>` : ''}
          </div>
          <div class="row" style="margin:6px 0">${sampleLine}</div>
          <div class="row stat">
            ${(m.categories||[]).slice(0,3).map(c=>`<span>${c}</span>`).join(' · ')} ${sz}
          </div>

          <div class="actions">
            <div class="row">
              <button data-act="details">Details</button>
              <button data-act="setDefault">Als Standard</button>
            </div>
            <div class="row">
              <button data-act="download" class="primary">Download</button>
              <button data-act="install">Installieren</button>
            </div>
          </div>

          <div class="progress" style="margin-top:8px;display:none"><div></div></div>
        `;

        // Button-Logik
        div.querySelector('[data-act="details"]').addEventListener('click', ()=>{
          const msg = [
            `ID: ${m.id}`,
            `Name: ${m.name}`,
            `Basis: ${m.base||'–'}`,
            `Tags: ${(m.tags||[]).join(', ') || '–'}`,
            `Kategorien: ${(m.categories||[]).join(', ') || '–'}`,
            `Dateien:`,
            `- Checkpoint: ${m.files?.ckpt || m.files?.url || '–'}`,
            `- VAE: ${m.files?.vae || '–'}`,
            `- LoRA: ${(m.files?.lora||[]).join(', ') || '–'}`
          ].join('\n');
          alert(msg);
        });

        div.querySelector('[data-act="setDefault"]').addEventListener('click', async ()=>{
          try{
            if(Andio.api?.models?.setDefault){
              await Andio.api.models.setDefault(m.id);
              alert('Standardmodell gesetzt: '+m.name);
            }else{
              alert('Demo: Standard gesetzt (UI).');
            }
          }catch(e){ console.error(e); alert('Fehler beim Setzen.'); }
        });

        const progressBar = div.querySelector('.progress');
        const progressFill = progressBar.querySelector('div');

        async function runWithHUD(actionLabel, startFn){
          const {hud, jobId} = await Andio.startJobWithHUD(actionLabel, startFn);
          // zusätzlich lokale Leiste animieren
          progressBar.style.display='';
          const poll = async(id)=> Andio.api?.jobStatus ? Andio.api.jobStatus(id) : {progress:1,stage:'fertig',status:'done',etaSec:0};
          const t = setInterval(async ()=>{
            try{
              const s = await poll(jobId);
              if (typeof s?.progress==='number') progressFill.style.width = (Math.max(0,Math.min(1,s.progress))*100)+'%';
              if (s?.status==='done' || s?.progress>=1) { clearInterval(t); progressFill.style.width='100%'; }
            }catch(e){ console.warn(e); }
          }, 600);
          return {hud, jobId};
        }

        div.querySelector('[data-act="download"]').addEventListener('click', async ()=>{
          // Erwartet: Andio.api.models.download({id, url, sha256?, size?})
          const payload = {
            id: m.id,
            url: m.files?.ckpt || m.files?.url || m.url, // URL zum Checkpoint/ggf. Safetensors
            vae: m.files?.vae || null,
            loras: m.files?.lora || [],
            sha256: m.files?.sha256 || null,
            size: m.size || null
          };
          try{
            await runWithHUD('Model: Download', async ()=>{
              if (Andio.api?.models?.download) return await Andio.api.models.download(payload);
              return {jobId:'demo_'+Date.now()};
            });
          }catch(e){ console.error(e); alert('Download fehlgeschlagen.'); }
        });

        div.querySelector('[data-act="install"]').addEventListener('click', async ()=>{
          const dirs = {
            ckpt: $('#dirCkpt').value || null,
            lora: $('#dirLora').value || null,
            vae:  $('#dirVae').value  || null
          };
          const payload = {
            id: m.id, dirs,
            files: {
              ckpt: m.files?.ckpt || m.files?.url || m.url,
              vae:  m.files?.vae || null,
              lora: m.files?.lora || []
            }
          };
          try{
            await runWithHUD('Model: Install', async ()=>{
              if (Andio.api?.models?.install) return await Andio.api.models.install(payload);
              return {jobId:'demo_'+Date.now()};
            });
          }catch(e){ console.error(e); alert('Installation fehlgeschlagen.'); }
        });

        modelsHost.appendChild(div);
      });
    }

    // === Render: Kategorien ===
    function renderCategories(){
      const cats = Andio.presets.getCategories() || [];
      catsHost.innerHTML='';
      cats.forEach(c=>{
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <img class="thumb" src="${c.thumb || 'assets/placeholders/category.jpg'}" alt="${c.name}"/>
          <h4>${c.name}</h4>
          ${c.genres?.length ? `<div class="row">${c.genres.slice(0,5).map(g=>`<span class="badge">${g}</span>`).join('')}</div>` : ''}
          <div class="row" style="justify-content:space-between">
            ${c.nsfw ? '<span class="badge">NSFW</span>' : '<span class="badge">SFW</span>'}
            <button data-id="${c.id}">Filtern</button>
          </div>
        `;
        div.querySelector('button').addEventListener('click', ()=>{
          $('#cat').value = c.id; applyFilters();
          window.scrollTo({top:0,behavior:'smooth'});
        });
        catsHost.appendChild(div);
      });
    }

    // === Filter anwenden ===
    function applyFilters(){
      const q = $('#q').value.trim();
      const cat = $('#cat').value || null;
      const tag = $('#tag').value || null;
      const base = $('#base').value || null;
      const sfw = $('#sfwOnly').checked;
      const nsfw = $('#nsfwOnly').checked;

      let list = q ? Andio.presets.search(q)
                   : Andio.presets.filter({ category: cat, tag, base, nsfw: nsfw?true:undefined, sfw: sfw?true:undefined });
      renderModels(list);
    }

    // === Random ===
    $('#btnRandom').addEventListener('click', ()=>{
      const cat = $('#cat').value || undefined;
      const nsfw = $('#nsfwOnly').checked ? true : undefined;
      const sfw  = $('#sfwOnly').checked  ? true : undefined;
      const m = Andio.presets.random({ category: cat, nsfw, sfw });
      if (!m) return alert('Keine passenden Modelle.');
      alert('Random: '+m.name);
    });

    $('#btnRefresh').addEventListener('click', ()=> applyFilters());
    ['q','cat','tag','base','sfwOnly','nsfwOnly'].forEach(id=>{
      document.getElementById(id).addEventListener('input', applyFilters);
      document.getElementById(id).addEventListener('change', applyFilters);
    });

    // === Init ===
    (function init(){
      // Filter-Listen
      fillFilters();
      // Startliste
      renderModels(Andio.presets.getModels());
      renderCategories();
      // Default-Installpfade (nur UI)
      $('#dirCkpt').value = '/models/checkpoints';
      $('#dirLora').value = '/models/lora';
      $('#dirVae').value  = '/models/vae';
    })();
  })();
  </script>

  <script>if (window.Andio?.polish) Andio.polish();</script>
</body>
</html>
