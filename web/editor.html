<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Editor – AndioMediaStudio</title>
<link rel="icon" href="assets/logo/logo.png"/>
<link rel="stylesheet" href="assets/styles.css"/>
<style>
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .canvas-wrap{position:relative;background:#111;border-radius:8px;overflow:hidden;min-height:420px;display:flex;align-items:center;justify-content:center}
  canvas{max-width:100%;max-height:65vh;background:#000}
  .badge{position:absolute;background:#2b5fd9;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px;transform:translate(-50%,-50%);pointer-events:none;border:1px solid rgba(255,255,255,.3)}
  .row{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
  .note{color:#888;font-size:.9em}
  .result-list{display:flex;flex-direction:column;gap:8px}
  .small{font-size:.9em;opacity:.85}
  .hud{font-size:.9em;opacity:.9}
  button[disabled]{opacity:.6;pointer-events:none}
</style>
</head>
<body>
<script src="assets/app.js"></script>
<script>window.Andio?.navbar?.('editor');</script>

<div class="container">
  <h1>Editor</h1>
  <p class="note">Bild laden → Bereiche (#1, #2, …) aufziehen → je Bereich Prompt → <strong>Generieren</strong>. Der Player öffnet nur bei generierten Ergebnissen.</p>

  <div class="grid">
    <div>
      <div class="toolbar card">
        <input id="ed-file" type="file" accept="image/*"/>
        <select id="ed-mode" title="Modus">
          <option value="inpaint">Generieren (Inpainting)</option>
          <option value="remove">Entfernen</option>
          <option value="filter">Filter/Variante</option>
          <option value="pose">Pose</option>
        </select>
        <button id="ed-clear" class="secondary">Markierungen löschen</button>
        <button id="ed-generate">Generieren</button>
        <span id="hud" class="hud"></span>
      </div>

      <div class="canvas-wrap card" id="ed-cwrap">
        <canvas id="ed-canvas" width="1024" height="1024"></canvas>
      </div>

      <p class="note">Rechteck ziehen: Maus drücken → ziehen → loslassen. Mehrere Bereiche sind möglich. Zum Entfernen: „Markierungen löschen“.</p>
    </div>

    <div>
      <div class="card">
        <h3>Globale Einstellungen</h3>
        <div class="row">
          <label>Negativ</label>
          <input id="ed-neg" type="text" placeholder="z. B. Unschärfe, Verzerrungen"/>
        </div>
        <div class="row">
          <label>Guidance</label><input id="ed-cfg" type="number" min="0" max="20" step="0.5" value="7.5" style="max-width:120px"/>
          <label>Steps</label><input id="ed-steps" type="number" min="1" max="150" value="30" style="max-width:120px"/>
          <label>Seed</label><input id="ed-seed" type="number" placeholder="leer=zufällig" style="max-width:140px"/>
        </div>
      </div>

      <div id="ed-regions" class="card">
        <h3>Bereiche (#)</h3>
        <div id="ed-fields" class="result-list"></div>
      </div>

      <div id="ed-history" class="card">
        <h3>Ergebnisse</h3>
        <div id="ed-results" class="result-list"></div>
      </div>
    </div>
  </div>
</div>

<footer>© AndioMediaStudio</footer>

<!-- Minimaler Overlay-Viewer nur für generierte Inhalte -->
<div id="ov" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000">
  <div style="background:#111;max-width:90vw;max-height:90vh;border-radius:12px;padding:12px;border:1px solid #222;display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Player</strong>
      <button id="ov-close">✕</button>
    </div>
    <img id="ov-img" alt="Bild" style="max-width:86vw;max-height:72vh;border-radius:8px"/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <a id="ov-dl" class="secondary" download>Download</a>
      <button id="ov-close2">Schließen</button>
    </div>
  </div>
</div>

<script>
(()=> {
  const $=s=>document.querySelector(s);
  const hud = $('#hud');
  const c = $('#ed-canvas'), ctx = c.getContext('2d'), cwrap = $('#ed-cwrap');
  let img=null, dragging=false, start=null;
  const regions=[]; // {id,x,y,w,h,form:{what,style}}

  function nextId(){ return regions.length? Math.max(...regions.map(r=>r.id))+1 : 1; }
  function draw(){
    ctx.clearRect(0,0,c.width,c.height);
    if (img) ctx.drawImage(img,0,0,c.width,c.height);
    ctx.strokeStyle='#2b5fd9'; ctx.setLineDash([6,4]); ctx.lineWidth=2;
    regions.forEach(r=> ctx.strokeRect(r.x,r.y,r.w,r.h));
    rebuildBadges();
  }
  function rebuildBadges(){
    [...cwrap.querySelectorAll('.badge')].forEach(b=>b.remove());
    regions.forEach(r=>{
      const b=document.createElement('div'); b.className='badge'; b.textContent='#'+r.id;
      b.style.left=(r.x+r.w/2)+'px'; b.style.top=(r.y+r.h/2)+'px';
      cwrap.appendChild(b);
    });
  }

  $('#ed-file').addEventListener('change', ()=>{
    const f=$('#ed-file').files?.[0]; if(!f) return;
    const im=new Image(); im.onload=()=>{
      img=im;
      const ratio=Math.min(1024/im.width,1024/im.height,1);
      c.width=Math.floor(im.width*ratio); c.height=Math.floor(im.height*ratio);
      draw();
    };
    im.src=URL.createObjectURL(f);
  });

  c.addEventListener('mousedown', e=>{
    if(!img) return;
    dragging=true;
    const r=c.getBoundingClientRect(); start={x:e.clientX-r.left,y:e.clientY-r.top};
  });
  c.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const r=c.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
    draw(); ctx.strokeStyle='#2b5fd9'; ctx.setLineDash([6,4]); ctx.strokeRect(start.x,start.y,x-start.x,y-start.y);
  });
  c.addEventListener('mouseup', e=>{
    if(!dragging) return; dragging=false;
    const r=c.getBoundingClientRect(); const x1=Math.min(start.x,e.clientX-r.left), y1=Math.min(start.y,e.clientY-r.top);
    const w=Math.abs(e.clientX-r.left-start.x), h=Math.abs(e.clientY-r.top-start.y); if(w<6||h<6) return;
    const item={id:nextId(),x:x1,y:y1,w,h,form:{what:'',style:''}}; regions.push(item); draw(); addField(item);
  });

  $('#ed-clear').addEventListener('click', ()=>{ regions.splice(0,regions.length); draw(); $('#ed-fields').innerHTML=''; });

  function addField(r){
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`
      <strong>#${r.id}</strong>
      <div class="row"><input data-k="what" placeholder="Was? z. B. BH-Träger entfernen / Satinband hinzufügen" style="width:100%"></div>
      <div class="row"><input data-k="style" placeholder="Stil/Hinweise (Studio-Licht, realistisch …)" style="width:100%"></div>
    `;
    ['what','style'].forEach(k=>{
      const input=el.querySelector(`[data-k="${k}"]`);
      input.value=r.form[k]||'';
      input.addEventListener('input',()=>{ r.form[k]=input.value; });
    });
    $('#ed-fields').appendChild(el);
  }

  // ------- API helpers (echte Calls, Polling) -------
  const pickUrl = (obj)=> obj?.url || obj?.result?.url || obj?.data?.url || null;

  async function postMultipart(endpoint, payload, files){
    const fd=new FormData();
    fd.append('payload', new Blob([JSON.stringify(payload)], {type:'application/json'}));
    for(const [name,file] of Object.entries(files||{})){ if(file) fd.append(name, file, file.name||name); }
    const res=await fetch(endpoint,{method:'POST', body:fd});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }
  async function pollJob(jobId, {interval=1000, timeout=10*60*1000}={}){
    const t0=Date.now();
    while(true){
      const r=await fetch(`/api/jobs/${jobId}`); if(!r.ok) throw new Error(`Job ${jobId}: HTTP ${r.status}`);
      const data=await r.json();
      const st=(data.status||data.state||'').toLowerCase();
      if(['succeeded','success','done','finished','ok'].includes(st)){ return data; }
      if(['failed','error'].includes(st)){ const msg=data.error||'Job fehlgeschlagen'; throw new Error(msg); }
      if(Date.now()-t0>timeout) throw new Error('Timeout beim Warten auf das Ergebnis.');
      await new Promise(r=>setTimeout(r, interval));
    }
  }

  async function generate(){
    if(!img){ alert('Bitte erst ein Bild laden.'); return; }
    const file=$('#ed-file').files?.[0];
    const payload={
      mode: $('#ed-mode').value,
      neg: $('#ed-neg').value.trim(),
      cfg: +$('#ed-cfg').value,
      steps: +$('#ed-steps').value,
      seed: $('#ed-seed').value? +$('#ed-seed').value : null,
      // Koordinaten im Canvasmaßstab (0..width/height)
      regions: regions.map(r=>({id:r.id,x:r.x,y:r.y,w:r.w,h:r.h,form:r.form||{}})),
      canvas_size: {w:c.width,h:c.height}
    };
    try{
      setBusy(true,'Starte Job …');
      const startResp = await postMultipart('/api/editor/run', payload, {image:file});
      const directUrl = pickUrl(startResp);
      if(directUrl){
        pushResult(directUrl); setBusy(false,'Fertig (Direkt)');
        return;
      }
      const jobId = startResp.jobId || startResp.id || startResp.job || null;
      if(!jobId) throw new Error('Kein jobId im API-Response.');
      setBusy(true,`Warte auf Ergebnis… (Job ${jobId})`);
      const jobResp = await pollJob(jobId);
      const url = pickUrl(jobResp);
      if(!url) throw new Error('Kein Ergebnis-URL im Job-Response.');
      pushResult(url);
      setBusy(false,'Fertig');
    }catch(err){
      console.error(err);
      setBusy(false,'Fehler');
      alert('Editor-Fehler: '+(err?.message||err));
    }
  }

  function setBusy(b,msg){ $('#ed-generate').disabled=b; $('#ed-clear').disabled=b; hud.textContent=msg||''; }
  function pushResult(url){
    const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Result '+new Date().toLocaleTimeString();
    const item={url,generated:true};
    btn.addEventListener('click', ()=> openOverlay(item));
    $('#ed-results').prepend(btn);
  }

  // Overlay (nur generated)
  function openOverlay(item){
    if(!item.generated) return;
    $('#ov-img').src=item.url; $('#ov-dl').href=item.url; $('#ov-dl').download='output.png';
    $('#ov').style.display='flex';
  }
  $('#ov-close').onclick=()=> $('#ov').style.display='none';
  $('#ov-close2').onclick=()=> $('#ov').style.display='none';
  $('#ed-generate').addEventListener('click', generate);
})();
</script>
</body>
</html>
