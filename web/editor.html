<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Editor · AndioMediaStudio</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <style>
    :root{
      --bg:#0b1220;--card:#0f172a;--muted:#8ca0d2;--accent:#7aa2ff;--accent2:#9fbaff;
      --border:rgba(140,160,210,.25);--border-strong:rgba(120,160,255,.7);
    }
    .page{display:grid;grid-template-columns:340px 1fr;gap:16px;align-items:start}
    @media(max-width:1080px){.page{grid-template-columns:1fr}}
    .preview-wrap{position:relative}
    .preview{position:relative;width:100%;min-height:560px;border:1px solid rgba(140,160,210,.2);
      border-radius:14px;background:var(--bg);overflow:hidden;user-select:none}
    .preview img{display:block;max-width:100%;height:auto;margin:auto}
    .overlay{position:absolute;inset:0;pointer-events:none}
    .region{position:absolute;border:2px dashed var(--border-strong);background:rgba(120,160,255,.15);pointer-events:auto}
    .region.ellipse{border-radius:9999px}
    .region .label{position:absolute;top:-18px;left:0;background:rgba(20,28,48,.8);padding:2px 6px;border-radius:6px;
      font-size:12px;color:#fff}
    .handle{position:absolute;width:10px;height:10px;background:#d6e1ff;border:2px solid #3f5bd1;border-radius:50%;
      cursor:nwse-resize}
    .handle.br{right:-6px;bottom:-6px}
    .handle.tr{right:-6px;top:-6px;cursor:nesw-resize}
    .handle.bl{left:-6px;bottom:-6px;cursor:nesw-resize}
    .handle.tl{left:-6px;top:-6px}
    .lasso-path{position:absolute;border:2px dashed var(--border-strong);background:rgba(120,160,255,.12);pointer-events:none}
    .under-preview{margin-top:12px}
    textarea.input{min-height:72px;resize:vertical}
    .prompt-list{display:flex;flex-direction:column;gap:10px}
    .prompt-item{border:1px solid var(--border);border-radius:10px;padding:8px}
    .prompt-item h5{margin:0 0 8px;font-size:14px;color:var(--accent2)}
    .prompt-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .prompt-grid .col{display:flex;flex-direction:column;gap:6px}
    .toolbar .btn{margin:2px}
    .progress{position:absolute;inset:0;display:none;place-content:center;background:rgba(8,12,22,.45);z-index:5}
    .progress>div{width:56px;height:56px;border-radius:50%;border:4px solid rgba(120,160,255,.25);
      border-top-color:rgba(120,160,255,.95);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill, minmax(88px,1fr));gap:8px}
    .thumbs .thumb{border:1px solid var(--border);border-radius:8px;overflow:hidden;cursor:pointer}
    .thumb img{display:block;width:100%;height:auto}
    .layerbar{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px}
    .pose-point{position:absolute;width:10px;height:10px;border:2px solid #fff;border-radius:50%;background:#2b5fd9;
      box-shadow:0 0 0 2px rgba(43,95,217,.3);cursor:grab}
    .pose-line{position:absolute;height:2px;background:#8fb0ff;transform-origin:0 0;pointer-events:none}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;border:1px solid var(--border);
      padding:.1rem .35rem;border-radius:6px;background:#0e1630}
    .hint{color:#a9b7e6;font-size:12px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  </style>
</head>
<body>
<script src="assets/app.js"></script>
<script>
  if(window.Andio?.injectNavbar) Andio.injectNavbar('editor');
  else if(window.Andio?.navbar) Andio.navbar('editor');
</script>

<div class="container">
  <h1>Editor</h1>
  <div class="page">
    <!-- LINKS: Werkzeugwahl -->
    <aside class="card">
      <h3>Werkzeuge</h3>

      <div class="toolbar" style="margin-bottom:10px">
        <button class="btn mode primary" data-mode="generate">🞧 Generieren</button>
        <button class="btn mode" data-mode="remove">✖ Entfernen</button>
        <button class="btn mode" data-mode="filter">🎨 Filter</button>
        <button class="btn mode" data-mode="pose">👤 Pose</button>
      </div>

      <!-- Auswahlformen -->
      <div id="selectionBar" class="toolbar" style="margin-bottom:12px">
        <span class="hint">Auswahl:</span>
        <button class="btn sel primary" data-sel="rect">▭ Rechteck</button>
        <button class="btn sel" data-sel="ellipse">⬭ Ellipse</button>
        <button class="btn sel" data-sel="lasso">🔗 Lasso</button>
        <button class="btn sel" data-sel="smart">✨ Smart</button>
      </div>

      <!-- Einstellungen pro Modus -->
      <section data-pane="generate">
        <h4>Generierung</h4>
        <label>Modell<select id="modelGen" class="input">
          <option>sdxl-real</option><option>realvis</option><option>juggernaut</option>
        </select></label>
        <label>Steps<input id="stepsGen" type="number" class="input" value="28"/></label>
        <label>Guidance<input id="guidanceGen" type="number" step="0.1" class="input" value="7.5"/></label>
        <label><input type="checkbox" id="edgeKeepGen" checked/> Kanten bewahren</label>
        <label><input type="checkbox" id="relightGen" /> Licht anpassen</label>
        <label><input type="checkbox" id="shadowGen" /> Schatten einblenden</label>
        <small class="help">Bereiche markieren → Eingaben unter dem Bild (Was/Wo/Stil).</small>
      </section>

      <section data-pane="remove" style="display:none">
        <h4>Entfernen</h4>
        <label>Stärke<input id="strengthRem" type="range" min="0" max="100" value="80"/></label>
        <label><input type="checkbox" id="edgeCleanRem" checked/> Kanten säubern</label>
        <label><input type="checkbox" id="skinToneRem" checked/> Hautton angleichen</label>
        <small class="help">Bereiche markieren → Eingaben „Was entfernen?“ unter dem Bild.</small>
      </section>

      <section data-pane="filter" style="display:none">
        <h4>Filter (global)</h4>
        <label>Farbe/Temperatur<select id="colorFilter" class="input">
          <option value="neutral">Neutral</option><option value="warm">Warm</option><option value="kalt">Kalt</option>
          <option value="bw">S/W</option><option value="teal">Teal&Orange</option>
        </select></label>
        <label>Kontrast<input id="contrastFilter" type="range" min="-50" max="50" value="0"/></label>
        <label>Kurven (Gamma)<input id="gammaFilter" type="range" min="50" max="200" value="100"/></label>
        <label>Skin-Unify<input id="skinFilter" type="range" min="0" max="100" value="0"/></label>
        <label>Glanz reduzieren<input id="shineFilter" type="range" min="0" max="100" value="0"/></label>
        <label>Körnung<input id="grainFilter" type="range" min="0" max="100" value="20"/></label>
        <label>Vignette<input id="vignetteFilter" type="range" min="0" max="100" value="0"/></label>
        <label>Schärfen<input id="sharpFilter" type="range" min="0" max="100" value="0"/></label>
        <label>DeNoise<input id="denoiseFilter" type="range" min="0" max="100" value="0"/></label>
        <div style="margin-top:8px">
          <button id="btn-generateVariants" class="btn">🔁 Varianten erzeugen</button>
        </div>
        <div id="variantGrid" class="thumbs" style="margin-top:8px"></div>
        <small class="help">Klick auf Miniatur = anwenden.</small>
      </section>

      <section data-pane="pose" style="display:none">
        <h4>Pose</h4>
        <button id="btn-detectPose" class="btn">Pose erkennen</button>
        <label>Steifigkeit (Soft-IK)<input id="stiffPose" type="range" min="0" max="1" step="0.1" value="0.5"/></label>
        <label>Pose-Prompt<input id="posePrompt" class="input" placeholder="z. B. „Arme hoch“, „doggy“"/></label>
        <label><input type="checkbox" id="anatomyGuard" checked/> Anatomie-Guard</label>
        <small class="help">Punkte ziehen, Linien folgen. Demo-Overlay, keine echte KI-Berechnung.</small>
      </section>

      <hr/>
      <h4>Layer & Aktionen</h4>
      <div class="layerbar" id="layerBar"></div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btn-open" class="btn">📂 Bild öffnen</button>
        <button id="btn-apply" class="btn primary">G Anwenden</button>
        <button id="btn-undo" class="btn">Z Undo</button>
        <button id="btn-redo" class="btn">Y Redo</button>
        <button id="btn-save" class="btn ok">S Download</button>
        <button id="btn-clear" class="btn">Clear</button>
      </div>
      <p class="hint" style="margin-top:8px">
        Shortcuts: <span class="kbd">V</span> Auswahl · <span class="kbd">B</span> Pinsel ·
        <span class="kbd">E</span> Radierer · <span class="kbd">Z</span>/<span class="kbd">Y</span> Undo/Redo ·
        <span class="kbd">G</span> Anwenden · <span class="kbd">S</span> Download · <span class="kbd">Ctrl+0</span>/<span class="kbd">Ctrl+1</span> Fit/100% ·
        <span class="kbd">Strg+V</span> Bild aus Zwischenablage
      </p>
      <!-- Versteckter Datei-Input -->
      <input id="fileOpen" type="file" accept="image/*" style="display:none"/>
    </aside>

    <!-- RECHTS: Bild-Canvas -->
    <main class="card">
      <div class="row" style="justify-content:space-between">
        <h3>Vorschau</h3>
        <div class="row">
          <button id="btn-open-top" class="btn">📂 Bild öffnen</button>
          <span class="hint">oder per Drag&Drop hierher ziehen</span>
        </div>
      </div>
      <div class="preview-wrap">
        <div id="preview" class="preview" tabindex="0">
          <div class="progress"><div></div></div>
          <!-- Bild -->
          <div class="overlay" id="overlay"></div>
        </div>
      </div>

      <!-- Dynamische Eingabefelder -->
      <div class="under-preview">
        <h4>Eingaben für markierte Bereiche</h4>
        <div id="promptList" class="prompt-list"></div>
      </div>
    </main>
  </div>
</div>

<footer>© AndioMediaStudio</footer>

<script>
/* ---------- Mini-Helpers ---------- */
const $=(q,r=document)=>r.querySelector(q);const $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
const preview=$('#preview');const overlay=$('#overlay');
const fileInput=$('#fileOpen'); const btnOpen=$('#btn-open'); const btnOpenTop=$('#btn-open-top');
let mode='generate';let selection='rect';let regionCount=0;let dirtySelections=false;
const regions=[];const history=[];let histIndex=-1;
let baseImg=null; // HTMLImageElement
let posePoints=[];let poseLines=[];

/* ---------- Mode handling with confirm ---------- */
function confirmDiscardIfDirty(){
  if(!dirtySelections) return Promise.resolve(true);
  return new Promise(res=>{
    const ok=confirm('Nicht angewendete Markierungen verwerfen?'); if(ok){clearPrompts();} res(ok);
  });
}
function setMode(m){
  confirmDiscardIfDirty().then(ok=>{
    if(!ok) return;
    mode=m; dirtySelections=false;
    $$('.mode').forEach(b=>b.classList.toggle('primary', b.dataset.mode===m));
    $$('[data-pane]').forEach(p=>p.style.display=(p.dataset.pane===m)?'block':'none');
    if(m==='filter'){ $('#selectionBar').style.display='none'; } else { $('#selectionBar').style.display='block'; }
    rebuildPromptUI();
    if(m!=='pose') clearPose();
  });
}
$$('.mode').forEach(b=>b.addEventListener('click',()=>setMode(b.dataset.mode)));

/* ---------- Selection tool ---------- */
function setSel(s){ selection=s; $$('.sel').forEach(b=>b.classList.toggle('primary', b.dataset.sel===s)); }
$$('.sel').forEach(b=>b.addEventListener('click',()=>setSel(b.dataset.sel)));

/* ---------- Prompt UI ---------- */
function rebuildPromptUI(){
  $('#promptList').innerHTML='';
  regions.forEach(reg=> addRegionPrompt(reg._id) );
}
function addRegionPrompt(id){
  const div=document.createElement('div');div.className='prompt-item';
  if(mode==='generate'){
    div.innerHTML=`<h5>Region #${id} · Generieren</h5>
      <div class="prompt-grid">
        <div class="col"><label>Was?<textarea class="input prompt-what" data-id="${id}" placeholder="Objekt/Motiv"></textarea></label></div>
        <div class="col"><label>Wo?<textarea class="input prompt-where" data-id="${id}" placeholder="z. B. „am rechten Rand“, „auf der Hand“"></textarea></label></div>
        <div class="col"><label>Stil/Material<textarea class="input prompt-style" data-id="${id}" placeholder="Fotorealistisch, Leder, Neon, …"></textarea></label></div>
      </div>`;
  } else if(mode==='remove'){
    div.innerHTML=`<h5>Region #${id} · Entfernen</h5>
      <label>Was entfernen?<textarea class="input prompt-remove" data-id="${id}" placeholder="z. B. „BH-Träger rechts“"></textarea></label>`;
  } else {
    div.innerHTML=`<h5>Region #${id}</h5><textarea class="input" placeholder="Hinweis/Notiz"></textarea>`;
  }
  $('#promptList').appendChild(div);
}
function clearPrompts(){ $('#promptList').innerHTML=''; regions.splice(0,regions.length); regionCount=0; overlay.innerHTML=''; dirtySelections=false; }

/* ---------- Datei öffnen (Button + Input) ---------- */
function triggerOpen(){ fileInput.click(); }
btnOpen.addEventListener('click', triggerOpen);
btnOpenTop.addEventListener('click', triggerOpen);

fileInput.addEventListener('change',()=>{
  const f=fileInput.files?.[0]; if(f && f.type.startsWith('image')) loadImageFile(f);
  fileInput.value=''; // reset für erneutes Öffnen derselben Datei
});

/* ---------- Drag & Drop + Clipboard ---------- */
preview.addEventListener('drop',e=>{
  e.preventDefault();const f=e.dataTransfer.files?.[0];
  if(f&&f.type.startsWith('image')){ loadImageFile(f); }
});
preview.addEventListener('dragover',e=>e.preventDefault());

// Strg+V: Bild aus Zwischenablage (PNG/JPEG)
document.addEventListener('paste',async (e)=>{
  if(!e.clipboardData) return;
  const item=[...e.clipboardData.items].find(i=>i.type.startsWith('image/'));
  if(!item) return;
  const blob=item.getAsFile(); if(!blob) return;
  const f=new File([blob],'clipboard.png',{type:blob.type});
  loadImageFile(f);
});

function loadImageFile(f){
  const url=URL.createObjectURL(f);
  let img=$('#preview img'); if(!img){ img=document.createElement('img'); preview.insertBefore(img, overlay); }
  img.onload=()=>{ baseImg=img; // reset history on new base
    history.length=0; histIndex=-1; pushHistory();
  };
  img.src=url;
}

/* ---------- Region creation (click & drag) ---------- */
let dragState=null;
preview.addEventListener('mousedown',e=>{
  if(!baseImg) return;
  if(e.target.classList.contains('handle') || e.target.classList.contains('pose-point')) return;
  if(mode==='filter' || mode==='pose') return;
  dirtySelections=true;
  const start={x:e.offsetX,y:e.offsetY};
  if(selection==='lasso'){ startLasso(start); return; }
  const r=document.createElement('div');r.className='region '+(selection==='ellipse'?'ellipse':'rect');
  r.style.left=start.x+'px'; r.style.top=start.y+'px'; r.style.width='1px'; r.style.height='1px';
  r._id=++regionCount;
  const lbl=document.createElement('div');lbl.className='label';lbl.textContent='#'+r._id; r.appendChild(lbl);
  addHandles(r);
  overlay.appendChild(r); regions.push(r); addRegionPrompt(r._id);

  dragState={type:'create',el:r,start};
  enableRegionDrag(r);
});
preview.addEventListener('mousemove',e=>{
  if(!dragState) return;
  if(dragState.type==='create'){
    const dx=e.offsetX-dragState.start.x; const dy=e.offsetY-dragState.start.y;
    const left=Math.min(dragState.start.x, e.offsetX);
    const top=Math.min(dragState.start.y, e.offsetY);
    const w=Math.abs(dx); const h=Math.abs(dy);
    const el=dragState.el; el.style.left=left+'px'; el.style.top=top+'px'; el.style.width=w+'px'; el.style.height=h+'px';
  } else if(dragState.type==='resize'){
    resizeFromHandle(dragState,e);
  }
});
window.addEventListener('mouseup',()=>{ dragState=null; });

/* ---------- Handles / Resize / Move ---------- */
function addHandles(r){
  ['tl','tr','bl','br'].forEach(pos=>{
    const h=document.createElement('div');h.className='handle '+pos; r.appendChild(h);
    h.addEventListener('mousedown',e=>{
      e.stopPropagation(); dragState={type:'resize',el:r,handle:pos,start:{x:e.offsetX,y:e.offsetY}};
    });
  });
}
function resizeFromHandle(state, e){
  const el=state.el;
  const rect=el.getBoundingClientRect();
  const pRect=preview.getBoundingClientRect();
  let left=parseFloat(el.style.left), top=parseFloat(el.style.top);
  let w=parseFloat(el.style.width), h=parseFloat(el.style.height);
  const mx=e.clientX-pRect.left, my=e.clientY-pRect.top;

  if(state.handle==='br'){ w=mx-left; h=my-top; }
  if(state.handle==='tr'){ w=mx-left; h=h+(top-my); top=my; }
  if(state.handle==='bl'){ w=w+(left-mx); left=mx; h=my-top; }
  if(state.handle==='tl'){ w=w+(left-mx); left=mx; h=h+(top-my); top=my; }
  if(w<6) w=6; if(h<6) h=6;
  el.style.left=left+'px'; el.style.top=top+'px'; el.style.width=w+'px'; el.style.height=h+'px';
}
function enableRegionDrag(r){
  r.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('handle')) return;
    const offX=e.offsetX, offY=e.offsetY;
    function mm(ev){
      r.style.left=(ev.offsetX-offX)+'px';
      r.style.top=(ev.offsetY-offY)+'px';
    }
    function up(){ preview.removeEventListener('mousemove',mm); window.removeEventListener('mouseup',up); }
    preview.addEventListener('mousemove',mm); window.addEventListener('mouseup',up);
  });
}

/* ---------- Lasso (simple polygon box) ---------- */
let lassoPoints=null, lassoBox=null;
function startLasso(p){
  lassoPoints=[p];
  if(lassoBox){ lassoBox.remove(); }
  lassoBox=document.createElement('div'); lassoBox.className='lasso-path';
  lassoBox.style.left=p.x+'px'; lassoBox.style.top=p.y+'px'; lassoBox.style.width='1px'; lassoBox.style.height='1px';
  overlay.appendChild(lassoBox);

  function move(e){
    const last={x:e.offsetX,y:e.offsetY}; lassoPoints.push(last);
    const xs=lassoPoints.map(pt=>pt.x), ys=lassoPoints.map(pt=>pt.y);
    const left=Math.min(...xs), top=Math.min(...ys), w=Math.max(...xs)-left, h=Math.max(...ys)-top;
    lassoBox.style.left=left+'px'; lassoBox.style.top=top+'px'; lassoBox.style.width=w+'px'; lassoBox.style.height=h+'px';
  }
  function up(){
    preview.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up);
    const r=document.createElement('div');r.className='region rect'; r._id=++regionCount;
    r.style.left=lassoBox.style.left; r.style.top=lassoBox.style.top; r.style.width=lassoBox.style.width; r.style.height=lassoBox.style.height;
    const lbl=document.createElement('div');lbl.className='label';lbl.textContent='#'+r._id; r.appendChild(lbl);
    addHandles(r); overlay.appendChild(r); regions.push(r); addRegionPrompt(r._id); enableRegionDrag(r);
    lassoBox.remove(); lassoBox=null;
  }
  preview.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
}

/* ---------- Smart Select (placeholder) ---------- */
function smartSelectCenter(){
  const rect=preview.getBoundingClientRect();
  const w=rect.width*0.3, h=rect.height*0.3, left=rect.width*0.35, top=rect.height*0.35;
  const r=document.createElement('div');r.className='region rect'; r._id=++regionCount;
  Object.assign(r.style,{left:left+'px',top:top+'px',width:w+'px',height:h+'px'});
  const lbl=document.createElement('div');lbl.className='label';lbl.textContent='#'+r._id; r.appendChild(lbl);
  addHandles(r); overlay.appendChild(r); regions.push(r); addRegionPrompt(r._id); enableRegionDrag(r);
  dirtySelections=true;
}
$('#selectionBar').addEventListener('click',e=>{
  const b=e.target.closest('.sel'); if(!b) return;
  if(b.dataset.sel==='smart'){ smartSelectCenter(); return; }
});

/* ---------- Apply / Download / History ---------- */
function collectPayload(){
  const payload={mode, regions:[], settings:{}};
  if(mode==='generate'){
    payload.settings={model:$('#modelGen').value,steps:+$('#stepsGen').value,guidance:+$('#guidanceGen').value,
      edgeKeep:$('#edgeKeepGen').checked,relight:$('#relightGen').checked,shadow:$('#shadowGen').checked};
    $$('.prompt-item').forEach(div=>{
      const id=+div.querySelector('[data-id]').dataset.id;
      payload.regions.push({id,
        what:div.querySelector('.prompt-what')?.value||'',
        where:div.querySelector('.prompt-where')?.value||'',
        style:div.querySelector('.prompt-style')?.value||''});
    });
  } else if(mode==='remove'){
    payload.settings={strength:+$('#strengthRem').value,edgeClean:$('#edgeCleanRem').checked,skinTone:$('#skinToneRem').checked};
    $$('.prompt-remove').forEach(t=>payload.regions.push({id:+t.dataset.id, remove:t.value}));
  } else if(mode==='filter'){
    payload.settings={
      color:$('#colorFilter').value, contrast:+$('#contrastFilter').value, gamma:+$('#gammaFilter').value/100,
      skin:+$('#skinFilter').value, shine:+$('#shineFilter').value, grain:+$('#grainFilter').value,
      vignette:+$('#vignetteFilter').value, sharp:+$('#sharpFilter').value, denoise:+$('#denoiseFilter').value
    };
  } else if(mode==='pose'){
    payload.settings={stiff:+$('#stiffPose').value, prompt:$('#posePrompt').value, anatomy:$('#anatomyGuard').checked};
    payload.regions=[];
  }
  return payload;
}

function pushHistory(){
  const data=renderToCanvas(); if(!data) return;
  history.splice(histIndex+1);
  history.push(data); histIndex=history.length-1; renderLayerBar();
}
function undo(){ if(histIndex>0){ histIndex--; setFromDataURL(history[histIndex]); renderLayerBar(); } }
function redo(){ if(histIndex<history.length-1){ histIndex++; setFromDataURL(history[histIndex]); renderLayerBar(); } }

function setFromDataURL(url){
  if(!url) return;
  let img=$('#preview img'); if(!img){ img=document.createElement('img'); preview.insertBefore(img, overlay); }
  img.src=url; baseImg=img;
}

function renderToCanvas(){
  const img=$('#preview img'); if(!img) return null;
  const w=img.naturalWidth||img.width; const h=img.naturalHeight||img.height;
  const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');
  ctx.drawImage(img,0,0,w,h);
  return c.toDataURL('image/png');
}

function applyOperation(){
  const payload=collectPayload();
  console.log('APPLY payload', payload);
  showSpinner(true);
  setTimeout(()=>{
    pushHistory();
    dirtySelections=false;
    alert(`Demo: ${mode} angewendet (${payload.regions.length} Bereich(e)).`);
    showSpinner(false);
  }, 300);
}
function downloadMerged(){
  const data=renderToCanvas(); if(!data) return alert('Kein Bild.');
  const a=document.createElement('a'); a.href=data; a.download='andio-edit.png'; a.click();
}
function renderLayerBar(){
  const bar=$('#layerBar'); bar.innerHTML='';
  history.forEach((_,i)=>{
    const chip=document.createElement('div'); chip.className='chip'; chip.textContent=i===0?'Basis':`Layer ${i}`;
    if(i===histIndex) chip.style.background='rgba(120,160,255,.15)';
    chip.addEventListener('click',()=>{ histIndex=i; setFromDataURL(history[i]); renderLayerBar(); });
    bar.appendChild(chip);
  });
}

/* ---------- Spinner ---------- */
function showSpinner(v){ $('.progress').style.display=v?'grid':'none'; }

/* ---------- Filter Variants (client-side preview) ---------- */
$('#btn-generateVariants')?.addEventListener('click',()=>{
  const grid=$('#variantGrid'); grid.innerHTML='';
  const variants=[
    {name:'Kontrast +20', css:'contrast(1.2)'},
    {name:'Warm', css:'saturate(1.1) sepia(.15)'},
    {name:'Kalt', css:'saturate(1.05) hue-rotate(180deg)'},
    {name:'S/W + Körnung', css:'grayscale(1) contrast(1.1)'},
    {name:'Teal&Orange', css:'saturate(1.1) contrast(1.08) hue-rotate(-18deg)'},
  ];
  const src=$('#preview img'); if(!src) return alert('Bitte zuerst ein Bild öffnen.');
  variants.forEach(v=>{
    const wrap=document.createElement('div'); wrap.className='thumb';
    const img=src.cloneNode(); img.style.filter=v.css; img.removeAttribute('id');
    wrap.appendChild(img); grid.appendChild(wrap);
    wrap.title=v.name;
    wrap.addEventListener('click',()=>{ $('#preview img').style.filter=v.css; pushHistory(); });
  });
});

/* ---------- Pose demo (simple skeleton) ---------- */
const defaultSkeleton=[
  {name:'head',x:.5,y:.2},{name:'neck',x:.5,y:.28},
  {name:'r_sh',x:.42,y:.3},{name:'l_sh',x:.58,y:.3},
  {name:'r_el',x:.36,y:.42},{name:'l_el',x:.64,y:.42},
  {name:'r_wr',x:.32,y:.54},{name:'l_wr',x:.68,y:.54},
  {name:'hip',x:.5,y:.52},
  {name:'r_kn',x:.46,y:.68},{name:'l_kn',x:.54,y:.68},
  {name:'r_an',x:.44,y:.86},{name:'l_an',x:.56,y:.86},
];
const bones=[['head','neck'],['neck','r_sh'],['neck','l_sh'],['r_sh','r_el'],['r_el','r_wr'],['l_sh','l_el'],['l_el','l_wr'],['neck','hip'],['hip','r_kn'],['hip','l_kn'],['r_kn','r_an'],['l_kn','l_an']];
function clearPose(){
  posePoints.forEach(p=>p.remove()); poseLines.forEach(l=>l.remove());
  posePoints=[]; poseLines=[];
}
function detectPoseDemo(){
  if(!baseImg) return alert('Bitte zuerst ein Bild laden.');
  clearPose();
  const imgRect=preview.getBoundingClientRect();
  defaultSkeleton.forEach(pt=>{
    const el=document.createElement('div'); el.className='pose-point'; el.dataset.name=pt.name;
    el.style.left=(pt.x*imgRect.width-5)+'px'; el.style.top=(pt.y*imgRect.height-5)+'px';
    overlay.appendChild(el); posePoints.push(el);
    makePointDraggable(el);
  });
  redrawBones();
}
function redrawBones(){
  poseLines.forEach(l=>l.remove()); poseLines=[];
  bones.forEach(([a,b])=>{
    const A=posePoints.find(p=>p.dataset.name===a), B=posePoints.find(p=>p.dataset.name===b);
    if(!A||!B) return;
    const ax=A.offsetLeft+5, ay=A.offsetTop+5, bx=B.offsetLeft+5, by=B.offsetTop+5;
    const dx=bx-ax, dy=by-ay, len=Math.hypot(dx,dy), ang=Math.atan2(dy,dx)*180/Math.PI;
    const line=document.createElement('div'); line.className='pose-line';
    line.style.left=ax+'px'; line.style.top=ay+'px'; line.style.width=len+'px'; line.style.transform=`rotate(${ang}deg)`;
    overlay.appendChild(line); poseLines.push(line);
  });
}
function makePointDraggable(p){
  let md=false, offX=0, offY=0;
  p.addEventListener('mousedown',e=>{ md=true; offX=e.offsetX; offY=e.offsetY; p.style.cursor='grabbing'; });
  window.addEventListener('mouseup',()=>{ md=false; p.style.cursor='grab'; });
  preview.addEventListener('mousemove',e=>{
    if(!md) return;
    p.style.left=(e.offsetX-offX)+'px'; p.style.top=(e.offsetY-offY)+'px'; redrawBones();
  });
}
$('#btn-detectPose')?.addEventListener('click',detectPoseDemo);

/* ---------- Buttons ---------- */
$('#btn-apply').addEventListener('click',applyOperation);
$('#btn-save').addEventListener('click',downloadMerged);
$('#btn-clear').addEventListener('click',()=>{ clearPrompts(); });
$('#btn-undo').addEventListener('click',undo);
$('#btn-redo').addEventListener('click',redo);

/* ---------- Keyboard Shortcuts ---------- */
document.addEventListener('keydown',e=>{
  if(e.ctrlKey && e.key==='0'){ e.preventDefault(); preview.scrollIntoView({block:'center'}); return; }
  if(e.ctrlKey && e.key==='1'){ e.preventDefault(); $('#preview img')?.scrollIntoView({block:'center'}); return; }
  if(e.key.toLowerCase()==='g'){ e.preventDefault(); applyOperation(); }
  if(e.key.toLowerCase()==='s'){ e.preventDefault(); downloadMerged(); }
  if(e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); }
  if(e.key.toLowerCase()==='y'){ e.preventDefault(); redo(); }
  if(e.key.toLowerCase()==='v'){ setSel('rect'); }
  if(e.key.toLowerCase()==='b'){ setSel('lasso'); }
  if(e.key.toLowerCase()==='e'){ setSel('ellipse'); }
});

/* ---------- Init ---------- */
function init(){
  const img=$('#preview img'); if(img){ baseImg=img; pushHistory(); }
}
init();
</script>
</body>
</html>
