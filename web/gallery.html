<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gallery Â· AndioMediaStudio</title>
  <link rel="icon" type="image/png" href="assets/logo/logo.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <!-- Globale UI (fixe Navbar Styles etc.) -->
  <link rel="stylesheet" href="assets/ui.css"/>

  <style>
    /* ===== Theme (angepasst an Editor) ===== */
    *{box-sizing:border-box}
    :root{
      --pri1:#667eea; --pri2:#764ba2;
      --ink:#222; --muted:#666;
      --panel:rgba(255,255,255,.95);
      --bd:rgba(255,255,255,.22);
      --glow:rgba(0,0,0,.12);
      --bd2:#e8e8e8;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      color:var(--ink);
      background:linear-gradient(135deg,var(--pri1) 0%, var(--pri2) 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* ===== Shell ===== */
    .container{max-width:1400px;margin:0 auto;padding:16px}

    h1{
      font-size:1.6rem; margin:10px 0 14px;
      background:linear-gradient(135deg,var(--pri1),var(--pri2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }

    .card{
      background:var(--panel); border:1px solid var(--bd);
      border-radius:14px; box-shadow:0 4px 20px var(--glow);
      padding:12px 14px; margin-bottom:12px;
    }

    /* ===== Toolbar ===== */
    .toolbar{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .input,.select,.btn{
      height:38px; border-radius:10px; border:1px solid var(--bd2); background:#fff;
      padding:0 10px; font-size:14px;
      box-shadow:0 1px 0 rgba(0,0,0,.02) inset;
    }
    .input{min-width:260px}
    .select{background:#fff}
    .btn{display:inline-flex; align-items:center; gap:8px; cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--pri1),var(--pri2)); color:#fff; border-color:transparent}
    .btn.danger{background:#B00020; color:#fff; border-color:#b00020}
    .btn.ghost{background:rgba(102,126,234,.08); color:var(--pri1); border:1px solid rgba(102,126,234,.25)}
    .grow{flex:1 1 280px}
    .muted{opacity:.75; font-size:12px}

    /* ===== Grid / Thumbs ===== */
    .grid{
      display:grid; gap:14px;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
    }
    .thumb{
      position:relative; cursor:pointer;
      background:var(--panel); border:1px solid var(--bd); border-radius:12px;
      box-shadow:0 4px 20px var(--glow); overflow:hidden; transition:.2s transform, .2s box-shadow;
    }
    .thumb:hover{ transform:translateY(-2px); box-shadow:0 8px 24px var(--glow) }
    .wrap{
      position:relative; aspect-ratio:1/1; background:#111;
      display:flex; align-items:center; justify-content:center;
    }
    .wrap img,.wrap video{ width:100%; height:100%; object-fit:cover; display:block }
    .wrap video{ position:absolute; inset:0; opacity:0; transition:.2s opacity; pointer-events:none }
    .thumb.video:hover .wrap video{ opacity:1 }

    .badge{
      position:absolute; top:8px; left:8px;
      padding:4px 8px; border-radius:999px;
      background:rgba(0,0,0,.55); color:#fff; border:1px solid rgba(255,255,255,.18);
      font-size:11px; font-weight:700;
    }
    .badge.right{ left:auto; right:8px }
    .play{
      position:absolute; right:8px; bottom:8px;
      width:36px;height:36px;border-radius:999px;
      background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.2);
      color:#fff; display:flex; align-items:center; justify-content:center;
    }
    .row-actions{
      position:absolute; top:8px; right:8px; display:flex; gap:8px;
    }
    .icon-btn{
      width:36px;height:36px;border-radius:999px; border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.55); color:#fff; display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .icon-btn:hover{ background:rgba(0,0,0,.7) }

    .meta{ padding:10px 12px; display:flex; flex-direction:column; gap:6px }
    .chips{ display:flex; gap:6px; flex-wrap:wrap }
    .chip{
      border:1px solid rgba(102,126,234,.25);
      background:rgba(102,126,234,.08);
      color:var(--pri1);
      padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700;
    }

    footer.page{ color:#fff; text-align:center; padding:30px 0; opacity:.9 }
    code{ background:rgba(255,255,255,.6); padding:2px 6px; border-radius:6px }
  </style>
</head>
<body data-page="gallery">`r`n  <div data-include="navbar"></div>
  <!-- Globale fixe Navbar -->
  <header class="andio-navbar" role="banner">
    <nav class="andio-nav" role="navigation" aria-label="Hauptnavigation">
      <!-- Brand -->
      <a href="index.html" class="brand-link" aria-label="Startseite">
        <img src="assets/logo/logo.png" alt="AndioMediaStudio Logo" />
        <span class="wordmark">Andio Media Studio</span>
      </a>

      <!-- Links -->
      <div class="nav-links" role="menubar">
        <a role="menuitem" href="index.html"      data-link="index">Ãœbersicht</a>
        <a role="menuitem" href="images.html"     data-link="images">Image Studio</a>
        <a role="menuitem" href="video-gen.html"  data-link="video-gen">Video Studio</a>
        <a role="menuitem" href="wandrobe.html"   data-link="wardrobe">Wardrobe</a>
        <a role="menuitem" href="avatar.html"     data-link="avatar">Avatar Studio</a>
        <a role="menuitem" href="motion.html"     data-link="motion" aria-current="page" class="active">Motion</a>
        <a role="menuitem" href="gallery.html"    data-link="gallery">Gallery</a>
        <a role="menuitem" href="catalog.html"    data-link="catalog">Store</a>
        <a role="menuitem" href="editor.html"     data-link="editor">Editor</a>
      </div>

      <!-- Rechts: globaler SFW/NSFW-Schalter -->
      <div class="nav-actions">
        <label class="modechip" title="SFW/NSFW umschalten">
          <span id="navModeLabel">SFW</span>
          <input id="navModeToggle" type="checkbox" />
          <span>NSFW</span>
        </label>
      </div>
    </nav>
  </header>

  <div class="container">
    <h1>Gallery</h1>

    <!-- Toolbar -->
    <div class="card">
      <div class="toolbar">
        <input id="q" class="input grow" placeholder="Suche nach Name, Tags â€¦"/>
        <select id="kind" class="select">
          <option value="">Alles</option>
          <option value="image">Nur Bilder</option>
          <option value="video">Nur Videos</option>
        </select>
        <select id="sfw" class="select">
          <option value="both">SFW + NSFW</option>
          <option value="sfw">Nur SFW</option>
        </select>
        <select id="sort" class="select">
          <option value="date_desc">Neueste</option>
          <option value="date_asc">Ã„lteste</option>
          <option value="name_asc">Name Aâ€“Z</option>
        </select>
      </div>
      <div class="muted">Quellen: <code>/api/outputs</code> (Server) oder <code>assets/outputs.json</code> (Fallback). Thumbnails werden automatisch genutzt.</div>
    </div>

    <!-- Grid -->
    <section id="grid" class="grid" aria-live="polite"></section>
    <div id="empty" class="muted" style="display:none">Keine Ergebnisse.</div>
  </div>

  <footer class="page">Â© Andio Media Studio</footer>

  <!-- Globaler Overlay-Player (einmalig, zentral) -->
  <script src="assets/overlay-player.js"></script>

  <script>
    // Navbar-Active kommt aus Markup-Klasse "active" (siehe Links)

    const $ = (q,r=document)=> r.querySelector(q);
    const el = {
      grid: $('#grid'), empty: $('#empty'),
      q: $('#q'), kind: $('#kind'), sfw: $('#sfw'), sort: $('#sort'),
    };

    // Demo-Fallback
    const demo = [
      { id:'demo-img', kind:'image', src:'assets/placeholders/demo.jpg', thumb:'assets/placeholders/demo.jpg', nsfw:false, name:'Demo Bild', tags:['demo'], date:'2025-08-20T10:00:00Z', format:'JPG' },
      { id:'demo-vid', kind:'video', src:'assets/placeholders/demo.mp4',  thumb:'assets/placeholders/demo.jpg', nsfw:false, name:'Demo Video', tags:['demo'], date:'2025-08-21T10:00:00Z', format:'MP4' },
    ];

    const state = { items:[], filtered:[] };

    async function fetchJson(url, init){
      const r = await fetch(url, Object.assign({ cache:'no-cache' }, init||{}));
      if(!r.ok) throw new Error('HTTP '+r.status);
      if(r.status===204) return null;
      const ct = r.headers.get('content-type')||'';
      return ct.includes('application/json') ? r.json() : r.text();
    }

    // Laden aus API oder Fallback
    async function loadOutputs(){
      try{
        const data = await fetchJson('/api/outputs');
        state.items = normalizeOutputs(data);
        apply(); return;
      }catch(_){}

      try{
        const data = await fetchJson('assets/outputs.json');
        state.items = normalizeOutputs(data);
        apply(); return;
      }catch(_){}

      state.items = demo;
      apply();
    }

    function normalizeOutputs(data){
      if(!Array.isArray(data)) return demo;
      return data.map((x,i)=>{
        const src = x.src || x.path || x.url;
        const ext = (x.format || fileExt(src) || '').toUpperCase();
        return {
          id: x.id || x.slug || ('it'+i),
          kind: x.kind || (/\.(mp4|webm|mov|mkv)$/i.test(src)?'video':'image'),
          src, thumb: x.thumb || x.preview || src,
          nsfw: !!x.nsfw,
          name: x.name || x.file || ('Output '+(i+1)),
          tags: x.tags || [],
          date: x.date || x.mtime || new Date().toISOString(),
          format: ext || (/\.(mp4|webm|mov|mkv)$/i.test(src)?'VIDEO':'IMG'),
          gen: x.model || x.generator || x.pipeline || null
        };
      }).filter(x=>!!x.src);
    }

    function fileExt(p){
      if(!p) return '';
      const m = p.split('?')[0].match(/\.([a-z0-9]+)$/i);
      return m ? m[1] : '';
    }

    // Filter + Sort
    function apply(){
      const q = el.q.value.trim().toLowerCase();
      const k = el.kind.value;
      const sfw = el.sfw.value;

      let arr = state.items.filter(it=>{
        if(k && it.kind!==k) return false;
        if(sfw==='sfw' && it.nsfw) return false;
        if(q){
          const hay = (it.name+' '+(it.gen||'')+' '+(it.tags||[]).join(' ')).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      const s = el.sort.value;
      arr.sort((a,b)=>{
        if(s==='date_desc') return new Date(b.date) - new Date(a.date);
        if(s==='date_asc')  return new Date(a.date) - new Date(b.date);
        if(s==='name_asc')  return a.name.localeCompare(b.name);
        return 0;
      });

      state.filtered = arr;
      renderGrid();
    }

    // Grid-Render mit Hover-Videovorschau & Actions
    function renderGrid(){
      el.grid.innerHTML = '';
      el.empty.style.display = state.filtered.length? 'none':'';
      state.filtered.forEach((it)=>{
        const card = document.createElement('div');
        card.className = 'thumb'+(it.kind==='video'?' video':'');
        const wrap = document.createElement('div');
        wrap.className = 'wrap';

        // Poster immer als IMG
        const poster = document.createElement('img');
        poster.loading='lazy'; poster.src = it.thumb || it.src; poster.alt = it.name;
        wrap.append(poster);

        // Video-Hover
        if(it.kind==='video'){
          const v = document.createElement('video');
          v.muted = true; v.playsInline = true; v.preload='metadata'; v.src = it.src;
          wrap.append(v);
          const play = document.createElement('div'); play.className='play'; play.innerHTML='<i class="fa fa-play"></i>'; wrap.append(play);
          card.addEventListener('mouseenter', ()=>{ v.currentTime=0; v.play().catch(()=>{}); });
          card.addEventListener('mouseleave', ()=>{ v.pause(); });
        }

        // Badges
        const badgeFmt = document.createElement('span'); badgeFmt.className='badge'; badgeFmt.textContent = it.format || (it.kind==='video'?'VIDEO':'IMG');
        const badgeMode = document.createElement('span'); badgeMode.className='badge right'; badgeMode.textContent = it.nsfw?'NSFW':'SFW';
        wrap.append(badgeFmt, badgeMode);

        // Quick Actions
        const actions = document.createElement('div'); actions.className='row-actions';
        const btnDl = document.createElement('a'); btnDl.className='icon-btn'; btnDl.title='Download'; btnDl.href=it.src; btnDl.download='';
        btnDl.innerHTML='<i class="fa fa-download"></i>'; btnDl.addEventListener('click',e=>e.stopPropagation());
        const btnDel = document.createElement('button'); btnDel.className='icon-btn'; btnDel.title='LÃ¶schen';
        btnDel.innerHTML='<i class="fa fa-trash"></i>'; btnDel.addEventListener('click', async (e)=>{ e.stopPropagation(); await deleteItem(it.id,it.src); });
        actions.append(btnDl, btnDel);
        wrap.append(actions);

        const meta = document.createElement('div'); meta.className='meta';
        const name = document.createElement('div'); name.textContent = it.name;
        const row = document.createElement('div'); row.className='chips';
        const cf=document.createElement('span'); cf.className='chip'; cf.textContent=it.format || (it.kind==='video'?'VIDEO':'IMG');
        row.append(cf);
        if(it.gen){ const cg=document.createElement('span'); cg.className='chip'; cg.textContent=it.gen; row.append(cg); }
        const dt = document.createElement('div'); dt.className='muted'; dt.textContent = new Date(it.date).toLocaleString();

        meta.append(name,row,dt);
        card.append(wrap, meta);

        // >>> Globaler Player: direkt Item Ã¼bergeben
        card.addEventListener('click', ()=> openOverlay(it));

        el.grid.append(card);
      });
    }

    // LÃ¶schen (mit klaren Fallbacks, keine Fake-Ergebnisse)
    async function deleteItem(id, src){
      if(!confirm('Datei wirklich lÃ¶schen?\n'+(src||''))) return;
      try{
        await fetchJson(`/api/outputs/${encodeURIComponent(id)}`, { method:'DELETE' });
        afterDelete(id); return;
      }catch(_){}
      try{
        await fetchJson('/api/outputs/delete', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, src })
        });
        afterDelete(id); return;
      }catch(_){}
      alert('Backend nicht erreichbar â€“ Eintrag wird nur aus der Anzeige entfernt.');
      afterDelete(id);
    }
    function afterDelete(id){
      state.items = state.items.filter(x=>x.id!==id);
      state.filtered = state.filtered.filter(x=>x.id!==id);
      renderGrid();
    }

    // Bindings
    [el.q, el.kind, el.sfw, el.sort].forEach(x=> x.addEventListener('input', apply));
    loadOutputs();
  </script>
  <script src="assets/include.js"></script>
</body>
</html>





