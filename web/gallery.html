<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gallery · AndioMediaStudio</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <link rel="icon" type="image/png" href="assets/logo/logo.png"/>
  <style>
    :root { --gap:12px; }
    .toolbar { display:flex; gap:var(--gap); flex-wrap:wrap; align-items:center; }
    .toolbar .grow { flex: 1 1 260px; }
    .grid { display:grid; gap:var(--gap); grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
    .thumb { border:1px solid #ffffff22; border-radius:10px; overflow:hidden; background:#0f0f0f; cursor:pointer; }
    .thumb .wrap { position:relative; aspect-ratio:1/1; background:#111; display:flex; align-items:center; justify-content:center; }
    .thumb img, .thumb video { width:100%; height:100%; object-fit:cover; display:block; }
    .thumb .badge { position:absolute; left:8px; top:8px; }
    .thumb .meta { padding:8px; display:flex; flex-direction:column; gap:6px; }
    .muted { opacity:.75; font-size:12px; }
    .chip { border:1px solid #ffffff22; padding:2px 8px; border-radius:999px; font-size:11px; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; }

    /* Overlay */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index:9999; }
    .overlay.active { display:flex; }
    .overlay .frame { width:min(92vw, 1200px); max-height:88vh; background:#0c0c0c; border-radius:14px; overflow:hidden; border:1px solid #ffffff22; display:flex; flex-direction:column; }
    .overlay header, .overlay footer { padding:10px 12px; background:#0f0f0f; border-bottom:1px solid #ffffff16; display:flex; align-items:center; gap:10px; }
    .overlay footer { border-top:1px solid #ffffff16; border-bottom:none; justify-content:space-between; }
    .overlay .content { padding:0; display:flex; align-items:center; justify-content:center; background:#000; }
    .overlay video, .overlay img { max-width:100%; max-height:74vh; display:block; }
    .links a.active { color:#2b57ff; }
  </style>
</head>
<body data-page="gallery">
  <!-- Player-Overlay -->
  <div id="player-overlay" class="overlay" role="dialog" aria-modal="true" aria-label="Preview">
    <div class="frame">
      <header>
        <strong id="ovTitle">Preview</strong>
        <span class="chips" id="ovBadges"></span>
        <span class="right muted" id="ovInfo"></span>
        <button id="ovClose" class="btn">Schließen</button>
      </header>
      <div class="content" id="ovContent"></div>
      <footer>
        <div class="row">
          <button id="ovPrev" class="btn">◀</button>
          <button id="ovNext" class="btn">▶</button>
        </div>
        <div class="row">
          <a href="catalog.html" class="btn">In Store öffnen</a>
          <a id="ovDownload" class="btn primary" download>Download</a>
        </div>
      </footer>
    </div>
  </div>

  <!-- Header / Navi -->
  <header class="header" role="banner">
    <nav role="navigation" aria-label="Hauptnavigation">
      <div class="brand">
        <a href="index.html" class="brand-link" aria-label="Zur Startseite">
          <img src="assets/logo/logo.png" alt="AndioMediaStudio Logo"/>
          <span class="wordmark">Andio Media Studio</span>
        </a>
      </div>
      <div class="spacer"></div>
      <div class="links" role="menubar">
        <a role="menuitem" href="index.html" data-link="index">Übersicht</a>
        <a role="menuitem" href="images.html" data-link="images">Image Studio</a>
        <a role="menuitem" href="video-gen.html" data-link="video-gen">Video Studio</a>
        <a role="menuitem" href="wandrobe.html" data-link="wardrobe">Wardrobe</a>
        <a role="menuitem" href="motion.html" data-link="motion">Motion</a>
        <a role="menuitem" href="gallery.html" data-link="gallery" aria-current="page">Gallery</a>
        <a role="menuitem" href="catalog.html" data-link="catalog">Store</a>
        <a role="menuitem" href="editor.html" data-link="editor">Editor</a>
      </div>
    </nav>
  </header>

  <div class="container">
    <h1>Gallery</h1>

    <!-- Toolbar -->
    <div class="card">
      <div class="toolbar">
        <input id="q" class="input grow" placeholder="Suche nach Name, Tags …"/>
        <select id="kind" class="select">
          <option value="">Alles</option>
          <option value="image">Nur Bilder</option>
          <option value="video">Nur Videos</option>
        </select>
        <select id="sfw" class="select">
          <option value="both">SFW + NSFW</option>
          <option value="sfw">Nur SFW</option>
        </select>
        <select id="sort" class="select">
          <option value="date_desc">Neueste</option>
          <option value="date_asc">Älteste</option>
          <option value="name_asc">Name A–Z</option>
        </select>
      </div>
      <div class="muted">Bilder/Videos aus <code>/outputs</code> (Server) oder <code>assets/outputs.json</code> (Fallback). Thumbnails werden angezeigt.</div>
    </div>

    <section id="grid" class="grid" aria-live="polite"></section>
    <div id="empty" class="muted" style="display:none">Keine Ergebnisse.</div>
  </div>

  <footer>© AndioMediaStudio</footer>

  <script src="assets/app.js"></script>
  <script>
    // Navbar active
    (function(){
      const a = document.querySelector('.links a[data-link="gallery"]');
      if(a){ a.classList.add('active'); a.setAttribute('aria-current','page'); }
    })();

    const $ = (q,r=document)=> r.querySelector(q);
    const el = {
      grid: $('#grid'), empty: $('#empty'),
      q: $('#q'), kind: $('#kind'), sfw: $('#sfw'), sort: $('#sort'),
      overlay: $('#player-overlay'), ovTitle: $('#ovTitle'), ovBadges: $('#ovBadges'),
      ovInfo: $('#ovInfo'), ovContent: $('#ovContent'), ovClose: $('#ovClose'),
      ovPrev: $('#ovPrev'), ovNext: $('#ovNext'), ovDownload: $('#ovDownload'),
    };

    const demo = [
      { id:'demo-img', kind:'image', src:'assets/placeholders/demo.jpg', thumb:'assets/placeholders/demo.jpg', nsfw:false, name:'Demo Bild', tags:['demo'], date:'2025-08-20T10:00:00Z' },
      { id:'demo-vid', kind:'video', src:'assets/placeholders/demo.mp4',  thumb:'assets/placeholders/demo.jpg', nsfw:false, name:'Demo Video', tags:['demo'], date:'2025-08-21T10:00:00Z' },
    ];

    const state = { items:[], filtered:[], idx:null };

    async function fetchJson(url){
      const r = await fetch(url, { cache: 'no-cache' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    async function loadOutputs(){
      try {
        // 1) Offizieller Endpoint aus deinem Backend
        const data = await fetchJson('/api/outputs');
        // Erwartetes Format (flexibel): Array von {kind:'image'|'video', src, thumb?, nsfw?, name?, tags?, date?}
        state.items = normalizeOutputs(data);
        apply();
        return;
      } catch(_){}

      try {
        // 2) Lokaler Fallback
        const data = await fetchJson('assets/outputs.json');
        state.items = normalizeOutputs(data);
        apply();
        return;
      } catch(_){}

      // 3) Demo
      state.items = demo;
      apply();
    }

    function normalizeOutputs(data){
      if(!Array.isArray(data)) return demo;
      return data.map((x,i)=>({
        id: x.id || ('it'+i),
        kind: x.kind || (/\.(mp4|webm|mov)$/i.test(x.src)?'video':'image'),
        src: x.src,
        thumb: x.thumb || x.src,
        nsfw: !!x.nsfw,
        name: x.name || x.file || ('Output '+(i+1)),
        tags: x.tags || [],
        date: x.date || new Date().toISOString(),
      })).filter(x=> !!x.src);
    }

    function apply(){
      const q = el.q.value.trim().toLowerCase();
      const k = el.kind.value;
      const sfw = el.sfw.value;

      let arr = state.items.filter(it=>{
        if(k && it.kind!==k) return false;
        if(sfw==='sfw' && it.nsfw) return false;
        if(q){
          const hay = (it.name+' '+(it.tags||[]).join(' ')).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      const s = el.sort.value;
      arr.sort((a,b)=>{
        if(s==='date_desc') return new Date(b.date)-new Date(a.date);
        if(s==='date_asc')  return new Date(a.date)-new Date(b.date);
        if(s==='name_asc')  return a.name.localeCompare(b.name);
        return 0;
      });

      state.filtered = arr;
      renderGrid();
    }

    function renderGrid(){
      el.grid.innerHTML = '';
      el.empty.style.display = state.filtered.length? 'none':'';
      state.filtered.forEach((it, idx)=>{
        const card = document.createElement('div');
        card.className = 'thumb';
        const wrap = document.createElement('div');
        wrap.className = 'wrap';

        if(it.kind==='video'){
          const v = document.createElement('video');
          v.muted = true; v.playsInline = true; v.preload='metadata';
          v.src = it.thumb || it.src;
          wrap.append(v);
          const badge = document.createElement('span'); badge.className='badge'; badge.textContent='Video';
          wrap.append(badge);
        } else {
          const img = document.createElement('img');
          img.loading='lazy'; img.src = it.thumb || it.src; img.alt = it.name;
          wrap.append(img);
          const badge = document.createElement('span'); badge.className='badge'; badge.textContent=it.nsfw?'NSFW':'SFW';
          wrap.append(badge);
        }

        const meta = document.createElement('div'); meta.className='meta';
        const name = document.createElement('div'); name.textContent = it.name;
        const row = document.createElement('div'); row.className='chips';
        (it.tags||[]).forEach(t=> { const c=document.createElement('span'); c.className='chip'; c.textContent=t; row.append(c); });
        const dt = document.createElement('div'); dt.className='muted'; dt.textContent = new Date(it.date).toLocaleString();

        meta.append(name, row, dt);
        card.append(wrap, meta);
        card.addEventListener('click', ()=> openOverlay(idx));
        el.grid.append(card);
      });
    }

    function openOverlay(idx){
      state.idx = idx;
      const it = state.filtered[idx];
      el.ovTitle.textContent = it.name;
      el.ovBadges.innerHTML = '';
      el.ovBadges.append(chip(it.kind==='video'?'Video':'Bild'), chip(it.nsfw?'NSFW':'SFW'));
      el.ovInfo.textContent = new Date(it.date).toLocaleString();
      el.ovDownload.href = it.src;
      el.ovContent.innerHTML = '';
      if(it.kind==='video'){
        const v=document.createElement('video'); v.controls=true; v.autoplay=true; v.src=it.src; el.ovContent.append(v);
      } else {
        const i=document.createElement('img'); i.src=it.src; i.alt=it.name; el.ovContent.append(i);
      }
      el.overlay.classList.add('active');
    }

    function chip(t){ const s=document.createElement('span'); s.className='chip'; s.textContent=t; return s; }

    el.ovClose.addEventListener('click', ()=> el.overlay.classList.remove('active'));
    el.overlay.addEventListener('click', (e)=> { if(e.target===el.overlay) el.overlay.classList.remove('active'); });
    el.ovPrev.addEventListener('click', ()=> { if(state.idx==null) return; openOverlay((state.idx-1+state.filtered.length)%state.filtered.length); });
    el.ovNext.addEventListener('click', ()=> { if(state.idx==null) return; openOverlay((state.idx+1)%state.filtered.length); });

    [el.q, el.kind, el.sfw, el.sort].forEach(x=> x.addEventListener('input', apply));
    loadOutputs();
  </script>
</body>
</html>
