<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Image Studio – AndioMediaStudio</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <style>
    .page-grid{display:grid;grid-template-columns:320px 1fr 380px;gap:12px;align-items:start}
    .card{background:#1112;border:1px solid #333;border-radius:12px;padding:12px}
    .grid{display:grid;gap:8px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{padding:2px 6px;border-radius:8px;background:#222;border:1px solid #444;font-size:12px}
    .pill{border:1px solid #444;border-radius:999px;padding:4px 10px;font-size:12px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:42vh;overflow:auto}
    .canvas-wrap{position:relative;aspect-ratio:1/1;background:#000;border-radius:12px;overflow:hidden}
    .canvas-wrap canvas{width:100%;height:100%;display:block}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .toolbar button.active{outline:2px solid #66f}
    .thumb{width:100%;aspect-ratio:16/10;object-fit:cover;border-radius:10px;border:1px solid #222;background:#000}
  </style>
</head>
<body>
  <script src="assets/app.js"></script>
  <!-- Optional: Preset-Modelle laden (wenn vorhanden) -->
  <script src="assets/presets.de.js"></script>
  <script src="assets/presets.loader.js"></script>
  <script>window.Andio?.navbar?.('images');</script>

  <div class="container">
    <h1>Image Studio</h1>

    <div class="page-grid">
      <!-- Links: Einstellungen -->
      <aside class="card">
        <h3>Einstellungen</h3>
        <div class="grid">
          <div class="grid grid-2">
            <label>Modus
              <select id="mode">
                <option value="txt2img">Text → Bild</option>
                <option value="img2img">Bild → Bild</option>
              </select>
            </label>
            <label>Inhalt
              <select id="content">
                <option value="sfw">SFW</option>
                <option value="nsfw">NSFW</option>
              </select>
            </label>
          </div>

          <details id="nsfwGate" class="card" style="border-style:solid;display:none">
            <summary>NSFW-Bestätigung</summary>
            <label><input type="checkbox" id="ageOk"/> Ich bin 18+.</label>
            <label><input type="checkbox" id="rightsOk"/> Rechte am Bild vorhanden.</label>
            <label><input type="checkbox" id="lawOk"/> Nutzung legal & privat.</label>
          </details>

          <label>Modell
            <select id="model"></select>
          </label>

          <div class="grid grid-2">
            <label>Auflösung
              <select id="size">
                <option value="512x512">512×512</option>
                <option value="768x768">768×768</option>
                <option value="1024x1024">1024×1024</option>
                <option value="1280x768">1280×768</option>
                <option value="1536x1024">1536×1024</option>
              </select>
            </label>
            <label>Guidance (CFG)
              <input type="number" id="cfg" min="1" max="20" step="0.5" value="7"/>
            </label>
          </div>

          <div class="grid grid-2">
            <label>Steps
              <input type="number" id="steps" min="1" max="100" step="1" value="28"/>
            </label>
            <label>Seed
              <input type="number" id="seed" placeholder="leer = zufällig"/>
            </label>
          </div>

          <details class="card">
            <summary>Erweiterte Optionen</summary>
            <div class="grid">
              <label>Sampler
                <select id="sampler">
                  <option value="euler">Euler</option>
                  <option value="dpmpp_2m">DPM++ 2M</option>
                  <option value="dpmpp_sde">DPM++ SDE</option>
                  <option value="ddim">DDIM</option>
                </select>
              </label>
              <label>VAE (optional)
                <input id="vae" placeholder="auto / name"/>
              </label>
            </div>
          </details>

          <div class="row">
            <button id="btnRandom">Random</button>
            <button id="btnGenerate" class="primary">Generieren</button>
          </div>
          <small class="pill">Job-HUD oben rechts zeigt **Stage / % / ETA**.</small>
        </div>
      </aside>

      <!-- Mitte: Canvas & evtl. Masken -->
      <main class="card">
        <div class="toolbar" id="tools" style="display:none">
          <button data-tool="rect" class="active">Rechteck</button>
          <button data-tool="ellipse">Ellipse</button>
          <button data-tool="lasso">Lasso</button>
          <button data-tool="brush">Pinsel</button>
          <button id="btnClearSel">Auswahlen löschen</button>
          <span class="badge">Kanten bewahren <input type="checkbox" id="edgeKeep" checked></span>
        </div>

        <div class="canvas-wrap">
          <canvas id="canvas" width="1024" height="1024" aria-label="Vorschau"></canvas>
          <canvas id="mask" width="1024" height="1024" style="position:absolute;inset:0;pointer-events:none"></canvas>
        </div>

        <div class="row" style="margin-top:8px">
          <label class="row">
            <span class="badge">Referenzbild</span>
            <input id="imgRef" type="file" accept="image/*"/>
          </label>
          <span id="refInfo" class="pill">–</span>
        </div>
      </main>

      <!-- Rechts: Prompts, Vorschläge & Ergebnisse -->
      <aside class="card">
        <h3>Prompts</h3>
        <div class="grid">
          <label>Positiver Prompt
            <textarea id="prompt" rows="5" placeholder="Beschreibe das gewünschte Bild (Stil, Motiv, Licht, Details)…"></textarea>
          </label>
          <label>Negativer Prompt
            <textarea id="neg" rows="3" placeholder="Was vermeiden? z. B. Artefakte, Verzerrungen, Extra-Finger…"></textarea>
          </label>
        </div>

        <div class="card" style="margin-top:10px">
          <h3>Vorschläge</h3>
          <div id="ideas" class="list"></div>
        </div>

        <div class="card" style="margin-top:10px">
          <h3>Ergebnisse</h3>
          <div id="results" class="list"></div>
        </div>
      </aside>
    </div>
  </div>

  <footer>© AndioMediaStudio</footer>

  <script>
  (()=> {
    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
    const canvas=$('#canvas'), mask=$('#mask'), ctx=canvas.getContext('2d');
    let img=null;

    // Preset-Modelle (falls Loader vorhanden)
    function fillModels(){
      const sel=$('#model'); sel.innerHTML='';
      const list = (window.Andio?.presets?.getModels?.()||[]).slice(0,200);
      if(!list.length){ sel.innerHTML='<option value="auto">auto</option>'; return; }
      list.forEach(m=>{
        const o=document.createElement('option'); o.value=m.id; o.textContent=m.name; sel.appendChild(o);
      });
    }
    fillModels();

    // Inhalt / NSFW
    const nsfwGate = $('#nsfwGate');
    $('#content').addEventListener('change', e=>{
      nsfwGate.style.display = e.target.value==='nsfw' ? 'block' : 'none';
    });
    const consentOk = ()=> $('#content').value!=='nsfw' || ($('#ageOk').checked && $('#rightsOk').checked && $('#lawOk').checked);

    // Modus: img2img blendet Tools ein
    const tools = $('#tools');
    $('#mode').addEventListener('change', ()=>{
      const m = $('#mode').value;
      tools.style.display = (m==='img2img') ? '' : 'none';
    });

    // Annotator
    const annot = Andio.tools.attachAnnotator(canvas, mask, ()=>{});
    $$('#tools button[data-tool]').forEach(b=>{
      b.addEventListener('click', ()=>{
        $$('#tools button[data-tool]').forEach(x=>x.classList.remove('active'));
        b.classList.add('active'); annot.setTool(b.dataset.tool);
      });
    });
    $('#btnClearSel').addEventListener('click', ()=> annot.reset());

    // Bild laden
    $('#imgRef').addEventListener('change', ()=>{
      const f = $('#imgRef').files?.[0]; if(!f) return;
      const im = new Image();
      im.onload=()=>{ img=im; ctx.drawImage(im,0,0,1024,1024); annot.markImageLoaded(); $('#refInfo').textContent=f.name; };
      im.src = URL.createObjectURL(f);
    });

    // Vorschläge initial
    function setIdeas(){
      const list=$('#ideas'); list.innerHTML='';
      const mode = $('#mode').value;
      const ideas = mode==='txt2img' ? [
        'Porträt, soft studio light, 85mm, ultrarealistisch',
        'Cinematic city at night, rain, reflections, bokeh',
        'Product shot, rim light, clean background, high detail',
        'Fantasy landscape, volumetric light, epic scale'
      ] : [
        'Stil-Transfer: „Filmlook 90s“, leichte Körnung, warmer Ton',
        'Objekt hinzufügen: „goldene Kette“, dezente Highlights',
        'Retusche: Hauttöne vereinheitlichen, weiches Licht',
        'Hintergrund vereinfachen, leichte Vignette'
      ];
      ideas.forEach(t=>{ const d=document.createElement('div'); d.className='card'; d.textContent=t; d.style.cursor='pointer'; d.onclick=()=>{$('#prompt').value+=($('#prompt').value?'\n':'')+t;}; list.appendChild(d); });
    }
    setIdeas();
    $('#mode').addEventListener('change', setIdeas);

    // Random
    $('#btnRandom').addEventListener('click', ()=>{
      const mode = $('#mode').value;
      const idea = Andio.randomPrompt('editor', mode==='txt2img'?'generate':'filter') || Andio.randomPrompt('wardrobe','sfw') || '';
      if (idea) $('#prompt').value = ($('#prompt').value?$('#prompt').value+'\n':'') + idea;
      // Seed leer lassen = zufällig
      $('#seed').value='';
    });

    // Generate
    $('#btnGenerate').addEventListener('click', async ()=>{
      if($('#content').value==='nsfw' && !consentOk()){ alert('Bitte NSFW-Bestätigungen setzen.'); return; }
      if($('#mode').value==='img2img' && !img){ alert('Bitte Referenzbild laden (Bild→Bild).'); return; }

      const payload = {
        mode: $('#mode').value,
        content: $('#content').value,
        model: $('#model').value || 'auto',
        size: $('#size').value,
        steps: parseInt($('#steps').value||28,10),
        cfg: parseFloat($('#cfg').value||7),
        sampler: $('#sampler').value,
        vae: $('#vae').value||null,
        seed: $('#seed').value? parseInt($('#seed').value,10): null,
        prompt: $('#prompt').value,
        negative: $('#neg').value,
        selections: annot.state.selections,
        options: { edgeKeep: $('#edgeKeep').checked }
      };

      const {hud} = await Andio.startJobWithHUD('Image: '+payload.mode, async ()=>{
        if (Andio.api?.image?.start) return await Andio.api.image.start(payload); // -> {jobId}
        return {jobId:'demo_'+Date.now()};
      });

      setTimeout(async ()=>{
        let out=null;
        try{
          if (Andio.api?.image?.finish) out = await Andio.api.image.finish(); // -> {files:[{url,type:'image',name,generated:true}]}
          else out = {files:[{url:'assets/placeholders/sample_result.jpg', type:'image', name:'image.jpg', generated:true}]};
          addResults(out.files||[]);
        }catch(e){ console.error(e); }
      }, 250);
    });

    function addResults(files){
      const host=$('#results');
      files.forEach(f=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML = `
          <img class="thumb" src="${f.url}" alt="${f.name||'Output'}"/>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <b>${f.name||'Output'}</b>
            <span class="badge">${(f.type||'image').toUpperCase()}</span>
          </div>`;
        host.prepend(card);
      });
    }
  })();
  </script>

  <script>window.Andio?.polish?.();</script>
</body>
</html>
