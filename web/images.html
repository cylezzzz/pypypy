<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Image Studio Â· AndioMediaStudio</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <style>
    :root { --gap: 10px; }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    @media(max-width:1024px){ .split{grid-template-columns:1fr} }
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{cursor:pointer} .chip.active{outline:2px solid var(--accent);border-radius:999px}
    .subtle{color:var(--muted);font-size:12px}
    .panel{display:grid;grid-template-columns:320px 1fr;gap:var(--gap)}
    @media(max-width:1200px){ .panel{grid-template-columns:1fr} }
    .preview-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    @media(max-width:1024px){ .preview-grid{grid-template-columns:1fr} }
    .preview-box{position:relative;min-height:420px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0b0f1a}
    .preview-box h4{position:absolute;top:8px;left:10px;margin:0;font-size:12px;color:#c6c9d4;background:#0f1628;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    .preview-box .pad{padding:48px 12px 12px}
    .preview-box img,.preview-box canvas{display:block;max-width:100%;max-height:100%;margin:auto}
    .drop{position:relative;border:1px dashed var(--border);border-radius:12px;padding:12px;text-align:center;background:#0f1628}
    .drop input{position:absolute;inset:0;opacity:0;cursor:pointer}
    .toast{position:fixed;bottom:26px;right:26px;background:linear-gradient(180deg,rgba(24,32,54,.95),rgba(14,20,36,.95));border:1px solid var(--border);padding:12px 14px;border-radius:14px;box-shadow:var(--shadow-md);z-index:80}
    /* Wippschalter SFW/NSFW (voll klickbar + tastaturfÃ¤hig) */
    .switch{position:relative;width:58px;height:28px;background:#1a2236;border:1px solid var(--border);border-radius:999px;cursor:pointer}
    .switch input{position:absolute;inset:0;opacity:0}
    .knob{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:linear-gradient(180deg,#fff,#cfd6ff);box-shadow:0 2px 8px rgba(0,0,0,.35);transition:left .18s}
    .switch input:checked ~ .knob{ left:32px }
    .switch .labels{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--muted);padding:0 8px;pointer-events:none}
    .progress{height:8px;background:#101626;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .progress>div{height:100%;width:0;background:var(--accent)}
    .toolbar .btn.ok{background:#1e8e3e;border-color:#176b2e}
  </style>
</head>
<body>
<script src="assets/data/registry.js"></script>
<script src="assets/app.js"></script>
<script>window.Andio=window.Andio||{}; Andio.injectNavbar?.('images');</script>

<div class="container">
  <h1>Image Studio</h1>

  <div class="panel">
    <!-- ====== STEUERUNG LINKS ====== -->
    <div class="card">
      <h3>1) Modus & Sicherheit</h3>
      <div class="row">
        <select id="mode" class="input">
          <option value="t2i">Text â†’ Bild</option>
          <option value="i2i">Bild â†’ Bild</option>
        </select>
        <label class="switch" title="SFW â†” NSFW" aria-label="SFW oder NSFW" role="switch" aria-checked="false" tabindex="0">
          <input id="nsfwToggle" type="checkbox"/>
          <div class="knob"></div>
          <div class="labels"><span>SFW</span><span>NSFW</span></div>
        </label>
        <span class="badge">assets: catalog/ Â· models/</span>
      </div>

      <h3 style="margin-top:14px">2) Genre & VorschlÃ¤ge</h3>
      <div class="split">
        <div>
          <label>Genre/Motiv</label>
          <select id="genre" class="input"><option value="">â€” Bitte Genre wÃ¤hlen â€”</option></select>
        </div>
        <div>
          <label>Format</label>
          <select id="format" class="input">
            <option value="1:1" selected>1:1 (Quadrat)</option>
            <option value="3:4">3:4 (Portrait)</option>
            <option value="4:3">4:3 (Landscape)</option>
            <option value="9:16">9:16 (Portrait)</option>
            <option value="16:9">16:9 (Landscape)</option>
          </select>
        </div>
      </div>
      <div class="subtle" style="margin-top:6px">Schnellstart: auf einen Vorschlag klicken</div>
      <div id="chips" class="chips"></div>

      <hr/>
      <h3>3) Look & Stil</h3>
      <div class="split">
        <div><label>Stil</label><select id="style" class="input"></select></div>
        <div><label>Licht</label><select id="light" class="input"></select></div>
        <div><label>Komposition</label><select id="comp" class="input"></select></div>
        <div><label>Farbpalette</label><select id="palette" class="input"></select></div>
      </div>

      <hr/>
      <h3>4) QualitÃ¤t</h3>
      <div class="split">
        <div><label>AuflÃ¶sung</label><select id="res" class="input"></select></div>
        <div><label>Seed</label><input id="seed" type="number" placeholder="leer = zufÃ¤llig" class="input"/></div>
      </div>
      <div class="split" style="margin-top:10px">
        <div><label>Steps</label><input id="steps" type="number" value="28" class="input"/></div>
        <div><label>Guidance (CFG)</label><input id="guidance" type="number" step="0.1" value="7.5" class="input"/></div>
      </div>
      <div id="i2iExtra" class="split" style="margin-top:10px; display:none">
        <div><label>StÃ¤rke (Denoise)</label><input id="strength" type="number" step="0.05" min="0" max="1" value="0.55" class="input"/></div>
        <div><label>Quellgewicht</label><input id="sourceWeight" type="number" step="0.05" min="0" max="1" value="0.85" class="input"/></div>
      </div>

      <hr/>
      <h3>5) Modell</h3>
      <div class="row">
        <label class="badge"><input id="smartModel" type="checkbox" checked> Smart Modell</label>
        <span class="subtle">aus <code>/models/manifest.json</code></span>
      </div>
      <select id="model" class="input" disabled></select>
      <div class="subtle" id="modelHint" style="margin-top:6px"></div>

      <hr/>
      <div class="toolbar">
        <button id="btnRandom" class="btn primary">ðŸŽ² Zufall</button>
        <button id="render" class="btn">Generieren</button>
        <button id="save" class="btn ok">Download</button>
        <button id="reset" class="btn">Reset</button>
      </div>
    </div>

    <!-- ====== VORSCHAU & PROMPT RECHTS ====== -->
    <div class="card">
      <h3>Vorschau</h3>

      <div class="preview-grid">
        <!-- Quelle -->
        <div class="preview-box">
          <h4>Quelle</h4>
          <div class="pad" id="sourceBox">
            <div id="dropzone" class="drop" aria-label="Bild hierher ziehen">
              <input id="fileInput" type="file" accept="image/*"/>
              <div class="subtle">Bild hier ablegen oder klicken, um auszuwÃ¤hlen</div>
            </div>
            <div class="subtle" style="margin-top:8px" id="srcInfo">Text â†’ Bild: kein Original nÃ¶tig</div>
          </div>
        </div>
        <!-- Ergebnis -->
        <div class="preview-box">
          <h4>Ergebnis</h4>
          <div class="pad" id="resultBox">
            <div class="progress"><div id="progBar"></div></div>
            <div id="resultWrap" style="margin-top:10px"></div>
          </div>
        </div>
      </div>

      <h3 style="margin-top:12px">Prompt</h3>
      <textarea id="promptBox" class="input" rows="4" placeholder="Zufall fÃ¼llt hier automatischâ€¦"></textarea>
      <label style="margin-top:8px;display:block">Negative</label>
      <textarea id="negative" class="input" rows="2" placeholder="Wird sinnvoll vorbelegtâ€¦"></textarea>
    </div>
  </div>
</div>

<footer>Â© AndioMediaStudio</footer>

<script>
/* ==== SHIMs (stabil, ohne AbhÃ¤ngigkeit auf app.js-Ladezeit) ==== */
const $ = (s,r=document)=>r.querySelector(s);
const $$= (s,r=document)=>Array.from(r.querySelectorAll(s));
const pm = { set:(p)=>{ const b=$('#progBar'); if(!b) return; b.style.transition='width .2s'; b.style.width=(p||0)+'%'; } };

/* ==== Daten ==== */
const RES_BY_FORMAT = {
  '1:1':['768Ã—768','1024Ã—1024','1536Ã—1536','2048Ã—2048'],
  '3:4':['768Ã—1024','1080Ã—1440','1200Ã—1600','1536Ã—2048'],
  '4:3':['1024Ã—768','1600Ã—1200','2048Ã—1536'],
  '9:16':['720Ã—1280','1080Ã—1920','1440Ã—2560'],
  '16:9':['1280Ã—720','1920Ã—1080','2560Ã—1440']
};
const pick=a=>a[Math.floor(Math.random()*a.length)];
let P, MODELS, SOURCE_IMG;

/* ==== Helpers ==== */
function setSel(el, items){ el.innerHTML=(items||[]).map(x=>`<option value="${x.id||x}">${x.name||x}</option>`).join(''); }
function setRes(fmt){ $('#format').value=fmt; setSel($('#res'), RES_BY_FORMAT[fmt]); $('#res').value=RES_BY_FORMAT[fmt][1]||RES_BY_FORMAT[fmt][0]; }
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 1800); }
function wipeResult(){ $('#resultWrap').innerHTML=''; pm.set(0); }
function showImage(target, url){ const img=new Image(); img.src=url; img.style.maxWidth='100%'; img.style.maxHeight='100%'; target.innerHTML=''; target.appendChild(img); }

/* ==== Switch voll klickbar + Tastatur ==== */
(function wireSwitch(){
  const sw = $('.switch'); const input = $('#nsfwToggle');
  const sync=()=> sw.setAttribute('aria-checked', input.checked?'true':'false');
  sw.addEventListener('click', e=>{ if(e.target!==input){ input.checked=!input.checked; input.dispatchEvent(new Event('change',{bubbles:true})); } sync();});
  sw.addEventListener('keydown', e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); input.checked=!input.checked; input.dispatchEvent(new Event('change',{bubbles:true})); sync();}});
  input.addEventListener('change', sync); sync();
})();

/* ==== Drag&Drop ==== */
(function wireDrop(){
  const dz = $('#dropzone'), fi = $('#fileInput');
  const handle = file=>{
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      SOURCE_IMG = e.target.result;
      const wrap = document.createElement('div');
      showImage(wrap, SOURCE_IMG);
      $('#sourceBox').innerHTML = ''; $('#sourceBox').appendChild(wrap);
      $('#srcInfo').textContent = file.name + ' ('+Math.round(file.size/1024)+' KB)';
    };
    reader.readAsDataURL(file);
  };
  fi.addEventListener('change', e=> handle(e.target.files[0]));
  ['dragenter','dragover'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.style.background='#12203c'; }));
  ;['dragleave','drop'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.style.background=''; }));
  dz.addEventListener('drop', e=> handle(e.dataTransfer.files[0]));
})();

/* ==== Boot ==== */
async function boot(){
  // Presets & Listen
  P = await AndioData.loadImagePresets();
  setSel($('#genre'), [{id:'',name:'â€” Bitte Genre wÃ¤hlen â€”'}, ...P.genres]);
  setSel($('#style'), P.styles); setSel($('#light'), P.lights);
  setSel($('#comp'),  P.comps);  setSel($('#palette'), P.palettes);
  setRes('1:1');

  const chips = AndioData.featuredChips(P.featured, {nsfw: $('#nsfwToggle').checked, n:16});
  $('#chips').innerHTML = chips.map(c=>`<span class="badge chip">${c}</span>`).join('');
  $$('.chip').forEach(el=>el.addEventListener('click',()=>{
    $$('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active');
    const g = P.genres.find(x=>x.name===el.textContent); if(g){ $('#genre').value=g.id; refreshModels(); }
  }));

  // Modelle
  MODELS = await AndioData.models('image', { nsfw: $('#nsfwToggle').checked });
  refreshModels();

  // Events
  $('#nsfwToggle').addEventListener('change', async ()=>{
    MODELS = await AndioData.models('image', { nsfw: $('#nsfwToggle').checked });
    refreshModels();
  });
  $('#mode').addEventListener('change', syncModeUI);
  $('#genre').addEventListener('change', refreshModels);
  $('#format').addEventListener('change', ()=> setRes($('#format').value));

  $('#btnRandom').addEventListener('click', randomAll);
  $('#render').addEventListener('click', doRender);
  $('#save').addEventListener('click', doSave);
  $('#reset').addEventListener('click', doReset);

  syncModeUI();
}

function syncModeUI(){
  const i2i = $('#mode').value==='i2i';
  $('#i2iExtra').style.display = i2i ? '' : 'none';
  $('#srcInfo').textContent = i2i ? 'Bild â†’ Bild: Quelle bestimmt Struktur & Farben' : 'Text â†’ Bild: kein Original nÃ¶tig';
}

function refreshModels(){
  const genreId = $('#genre').value;
  const smart = AndioData.smartPickModel(MODELS, genreId);
  setSel($('#model'), MODELS);
  $('#model').disabled = $('#smartModel').checked;
  $('#model').value = $('#smartModel').checked && smart ? smart.id : (MODELS[0]?.id||'');
  $('#modelHint').textContent = (MODELS.find(m=>m.id===$('#model').value)||{}).hint || '';
}

function randomAll(){
  const genreId = $('#genre').value;
  if(!genreId){ toast('Bitte zuerst ein Genre wÃ¤hlen.'); return; }
  const nsfw = $('#nsfwToggle').checked;

  // Format & Res (NSFW leicht Portrait-gewichtet)
  const fmtPool = nsfw ? ['3:4','9:16','1:1','16:9'] : ['1:1','16:9','4:3','3:4'];
  setRes(pick(fmtPool));

  // Look
  $('#style').value   = pick(P.styles).id;
  $('#light').value   = pick(P.lights).id;
  $('#comp').value    = pick(P.comps).id;
  $('#palette').value = pick(P.palettes).id;

  // QualitÃ¤t
  $('#steps').value = Math.floor(24 + Math.random()*12);
  $('#guidance').value = (6.5 + Math.random()*2.2).toFixed(1);
  $('#seed').value = '';

  // Prompt & Negative
  $('#promptBox').value = AndioData.randomImagePrompt(
    {genres:P.genres,styles:P.styles,lights:P.lights,comps:P.comps,palettes:P.palettes,templates:P.templates},
    {genreId, nsfw}
  );
  $('#negative').value = (P.negatives?.[nsfw?'nsfw':'sfw']) || 'Artefakte, Rauschen, falsche Proportionen, Verzerrungen';

  // Smart Modell
  refreshModels();
}

async function doRender(){
  const mode = $('#mode').value;
  const prompt = $('#promptBox').value.trim();
  if(!prompt){ toast('Bitte Prompt eingeben oder â€žðŸŽ² Zufallâ€œ nutzen.'); return; }

  const payload = {
    nsfw: $('#nsfwToggle').checked,
    genre: $('#genre').value,
    style: $('#style').value, light: $('#light').value, comp: $('#comp').value, palette: $('#palette').value,
    format: $('#format').value, res: $('#res').value,
    steps: +$('#steps').value, guidance: +$('#guidance').value,
    model: $('#model').value, smartModel: $('#smartModel').checked,
    prompt, negative: $('#negative').value
  };

  pm.set(8);

  try{
    let url;
    if(mode==='i2i'){
      if(!SOURCE_IMG){ toast('Bitte zuerst ein Quellbild hochladen.'); pm.set(0); return; }
      payload.strength = +$('#strength').value;
      payload.sourceWeight = +$('#sourceWeight').value;
      // bevorzugt native API, sonst Fallback
      if(Andio?.api?.imageImg2Img){
        Andio.Status?.start?.('Img2Img', {estMs: 2500});
        url = await Andio.api.imageImg2Img(payload, SOURCE_IMG);
      }else if(Andio?.api?.imageGenerate){ // einige Backends mappen i2i in imageGenerate
        payload.source = SOURCE_IMG;
        payload.mode = 'i2i';
        Andio.Status?.start?.('Img2Img', {estMs: 2500});
        url = await Andio.api.imageGenerate(payload);
      }else{
        url = await fallbackCanvas(payload, SOURCE_IMG);
      }
    }else{
      if(Andio?.api?.imageGenerate){
        Andio.Status?.start?.('Txt2Img', {estMs: 2200});
        url = await Andio.api.imageGenerate(payload);
      }else{
        url = await fallbackCanvas(payload);
      }
    }

    pm.set(85);
    // Ergebnis anzeigen (rechts), Quelle bleibt links sichtbar
    showImage($('#resultWrap'), url);
    pm.set(100);
    Andio.Status?.done?.('Fertig');
    setTimeout(()=>pm.set(0), 500);
  }catch(err){
    pm.set(0);
    Andio.Status?.error?.('Fehler bei der Generierung');
    toast('Fehler: ' + (err?.message||'unbekannt'));
  }
}

function doSave(){
  const img = $('#resultWrap img');
  if(!img) return toast('Nichts zu speichern.');
  const a=document.createElement('a'); a.href=img.src; a.download='image_result.png'; a.click();
}

function doReset(){
  $('#mode').value='t2i'; syncModeUI();
  SOURCE_IMG=null; $('#sourceBox').innerHTML = `
    <div id="dropzone" class="drop" aria-label="Bild hierher ziehen">
      <input id="fileInput" type="file" accept="image/*"/>
      <div class="subtle">Bild hier ablegen oder klicken, um auszuwÃ¤hlen</div>
    </div>
    <div class="subtle" style="margin-top:8px" id="srcInfo">Text â†’ Bild: kein Original nÃ¶tig</div>
  `;
  // re-wire drop handlers
  setTimeout(()=>{ (function(){ const old=$('#dropzone'); if(!old) return; /* reattach */ })(); },0);

  $('#nsfwToggle').checked=false; $('#genre').value=''; setRes('1:1');
  $('#seed').value=''; $('#steps').value=28; $('#guidance').value=7.5; $('#promptBox').value=''; $('#negative').value='';
  $('#smartModel').checked=true; $('#model').disabled=true; refreshModels(); wipeResult();
}

/* ==== Fallback Renderer (Canvas) fÃ¼r Demo ohne Backend) ==== */
async function fallbackCanvas(payload, source=null){
  // Simulierter Fortschritt
  for(const p of [18,32,47,63,78]){ await new Promise(r=>setTimeout(r,180)); pm.set(p); }

  // GrÃ¶ÃŸe grob aus Auswahl ableiten
  const [w,h] = pickSize(payload.format);
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  const ctx=c.getContext('2d');
  ctx.fillStyle='#0b1220'; ctx.fillRect(0,0,w,h);

  // Wenn i2i: Quelle einblenden
  if(source){
    const img = await loadImage(source);
    // skalieren, mittig
    const scale = Math.min(w/img.width, h/img.height);
    const nw = img.width*scale, nh = img.height*scale;
    ctx.globalAlpha=0.25;
    ctx.drawImage(img, (w-nw)/2, (h-nh)/2, nw, nh);
    ctx.globalAlpha=1;
  }

  ctx.fillStyle='rgba(255,255,255,.90)';
  ctx.font='bold 18px ui-monospace,monospace';
  ctx.fillText(`${payload.mode==='i2i'?'IMG2IMG':'TXT2IMG'} ${payload.format} ${payload.res}`, 16, 28);
  ctx.font='14px ui-monospace,monospace';
  ctx.fillText(`steps=${payload.steps} cfg=${payload.guidance} model=${payload.model}`, 16, 52);
  ctx.fillText((payload.prompt||'').slice(0,60)+'â€¦', 16, 76);

  return c.toDataURL('image/png');
}

function pickSize(fmt){
  if(fmt==='9:16') return [720,1280];
  if(fmt==='3:4')  return [960,1280];
  if(fmt==='16:9') return [1280,720];
  if(fmt==='4:3')  return [1024,768];
  return [1024,1024];
}
function loadImage(url){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=url; }); }

/* ==== MODELS & PRESETS ==== */
const AndioData = {
  async loadImagePresets(){ return await (window.Andio?.presets?.image?.() || mockPresets()); },
  async models(kind, {nsfw=false}={}){ return await (window.Andio?.models?.(kind,{nsfw}) || mockModels(nsfw)); },
  smartPickModel(list, genreId){
    const exact = list.find(m=> (m.genres||[]).includes(genreId));
    return exact || list.find(m=> m.tier==='base') || list[0];
  },
  featuredChips(all, {nsfw=false, n=16}={}){
    const pool = all.filter(x=> nsfw ? true : !/nsfw|nude|adult/i.test(x));
    return shuffle(pool).slice(0,n);
  },
  randomImagePrompt(db, {genreId, nsfw}){
    const g = db.genres.find(x=>x.id===genreId);
    const s = pick(db.styles).name, l=pick(db.lights).name, c=pick(db.comps).name, p=pick(db.palettes).name;
    const base = g?.name || 'Motiv';
    const safety = nsfw ? '' : ', safe, tasteful';
    return `${base}, ${s}, ${l}, ${c}, ${p}${safety}`;
  }
};
/* ==== MOCKS: ersetzen sich automatisch, wenn app.js echte liefert ==== */
function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
async function mockPresets(){
  return {
    genres:[{id:'portrait',name:'Portrait'},{id:'product',name:'Produkt'},{id:'anime',name:'Anime'},{id:'landscape',name:'Landschaft'}],
    styles:[{id:'real',name:'Realistisch'},{id:'photo',name:'Fotorealistisch'},{id:'anime',name:'Anime'},{id:'cin',name:'Cinematic'}],
    lights:[{id:'studio',name:'Studio'},{id:'soft',name:'Soft light'},{id:'hdr',name:'HDR'},{id:'sun',name:'Sonnenlicht'}],
    comps:[{id:'close',name:'Close-Up'},{id:'med',name:'Halbtotal'},{id:'wide',name:'Weitwinkel'}],
    palettes:[{id:'bw',name:'S/W'},{id:'warm',name:'Warm'},{id:'cool',name:'KÃ¼hl'},{id:'vivid',name:'Vivid'}],
    templates:{}, featured:['Portrait','Produkt','Anime','Landschaft','Cinematic','Close-Up','Studio','Warm','KÃ¼hl','Vivid'],
    negatives:{sfw:'Artefakte, Rauschen, falsche Proportionen, Verzerrungen', nsfw:'low quality, bad hands, artifacts'}
  };
}
async function mockModels(nsfw){
  return [
    {id:'sdxl-base', name:'SDXL Base', tier:'base', hint:'Allrounder fÃ¼r hohe AuflÃ¶sung', genres:['portrait','product','landscape']},
    {id:'sdxl-refiner', name:'SDXL Refiner', tier:'refine', hint:'SchÃ¤rft Details nach', genres:['portrait','product']},
    ...(nsfw ? [{id:'nsfw-plus', name:'NSFW+ Detail', tier:'addon', hint:'FreizÃ¼gigere Stile, Detailhaut', genres:['portrait','anime']}] : [])
  ];
}

/* ==== START ==== */
boot().then(()=>Andio?.polish&&Andio.polish?.());
</script>
</body>
</html>
