<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motion – AndioMediaStudio</title>
<link rel="stylesheet" href="assets/styles.css"/>
<style>
  .page-grid{display:grid;grid-template-columns:320px 1fr 380px;gap:12px}
  .card{background:#1112;border:1px solid #333;border-radius:12px;padding:12px}
  .grid{display:grid;gap:8px}
  .grid-2{grid-template-columns:1fr 1fr}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .canvas-wrap{position:relative;aspect-ratio:1/1;background:#000;border-radius:12px;overflow:hidden}
  .canvas-wrap canvas{width:100%;height:100%;display:block}
  .kp{position:absolute;width:12px;height:12px;border-radius:50%;border:2px solid #fff;background:#00aaff;cursor:grab;transform:translate(-6px,-6px)}
  .kp.drag{cursor:grabbing}
  .list{display:flex;flex-direction:column;gap:8px;max-height:42vh;overflow:auto}
  .hud{font-size:.9em;opacity:.9}
</style>
</head>
<body>
<script src="assets/app.js"></script>
<script>window.Andio?.navbar?.('motion');</script>

<div class="container">
  <h1>Motion</h1>
  <div class="page-grid">
    <aside class="card">
      <h3>Quelle & Modus</h3>
      <div class="grid">
        <label class="row"><span>Bild</span><input id="file" type="file" accept="image/*"/></label>
        <label class="row"><span>Audio (für Lip-Sync)</span><input id="audio" type="file" accept="audio/*"/></label>
        <div class="grid grid-2">
          <label>Modus
            <select id="mode"><option value="action">Aktion</option><option value="pose">Pose</option><option value="lipsync">Lip-Sync</option><option value="camera">Kamera</option></select>
          </label>
          <label>Preview
            <select id="preview"><option value="off">Aus</option><option value="low">Low-Res</option></select>
          </label>
        </div>
        <label>Prompt global <input id="prompt" placeholder="z. B. idle subtle sway"/></label>
        <div class="grid grid-2">
          <label>Dauer (s) <input id="dur" type="number" min="1" max="30" value="6"/></label>
          <label>FPS <input id="fps" type="number" min="6" max="30" value="12"/></label>
        </div>
        <div class="grid grid-2">
          <label>Geschw. <input id="speed" type="range" min="0.2" max="2" step="0.1" value="1"/></label>
          <label>Loop <select id="loop"><option value="true">An</option><option value="false">Aus</option></select></label>
        </div>
        <div class="row">
          <button id="random">Random</button>
          <button id="run" class="primary">Ausführen</button>
          <span id="hud" class="hud"></span>
        </div>
      </div>
    </aside>

    <main class="card">
      <div class="row" style="margin-bottom:6px">
        <button id="showKp" class="secondary">Keypoints umschalten</button>
        <button id="clear" class="secondary">Regionen löschen</button>
      </div>
      <div class="canvas-wrap" id="stage">
        <canvas id="canvas" width="1024" height="1024"></canvas>
      </div>
    </main>

    <aside class="card">
      <h3>Spuren & Ergebnisse</h3>
      <div class="list" id="results"></div>
    </aside>
  </div>
</div>

<footer>© AndioMediaStudio</footer>

<div id="ov" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000">
  <div style="background:#111;max-width:90vw;max-height:90vh;border-radius:12px;padding:12px;border:1px solid #222;display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Player</strong><button id="ov-close">✕</button></div>
    <video id="ov-video" controls playsinline style="max-width:86vw;max-height:72vh;border-radius:8px"></video>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><a id="ov-dl" class="secondary" download>Download</a><button id="ov-close2">Schließen</button></div>
  </div>
</div>

<script>
(()=> {
  const $=s=>document.querySelector(s);
  const hud=$('#hud');
  const canvas=$('#canvas'), ctx=canvas.getContext('2d'), stage=$('#stage');
  let img=null, showKp=true;
  const kp=[ // simple body rig
    {id:'head',x:512,y:220},{id:'l_shoulder',x:420,y:320},{id:'r_shoulder',x:604,y:320},
    {id:'l_elbow',x:370,y:420},{id:'r_elbow',x:654,y:420},{id:'hip',x:512,y:520},
    {id:'l_knee',x:470,y:680},{id:'r_knee',x:554,y:680},{id:'l_ankle',x:450,y:820},{id:'r_ankle',x:574,y:820}
  ];

  function draw(){
    ctx.clearRect(0,0,1024,1024);
    if(img) ctx.drawImage(img,0,0,1024,1024);
    if(showKp){
      ctx.strokeStyle='#0ff'; ctx.lineWidth=2;
      const J=id=>kp.find(k=>k.id===id);
      [['head','l_shoulder'],['head','r_shoulder'],['l_shoulder','l_elbow'],['r_shoulder','r_elbow'],['l_shoulder','hip'],['r_shoulder','hip'],['hip','l_knee'],['hip','r_knee'],['l_knee','l_ankle'],['r_knee','r_ankle']]
        .forEach(([a,b])=>{const A=J(a),B=J(b); if(A&&B){ctx.beginPath();ctx.moveTo(A.x,A.y);ctx.lineTo(B.x,B.y);ctx.stroke();}});
    }
  }
  function placeKp(){
    [...stage.querySelectorAll('.kp')].forEach(e=>e.remove());
    if(!showKp) return;
    kp.forEach(k=>{
      const dot=document.createElement('div'); dot.className='kp'; dot.style.left=k.x+'px'; dot.style.top=k.y+'px';
      let drag=false;
      dot.addEventListener('mousedown',e=>{drag=true;dot.classList.add('drag');e.preventDefault();});
      window.addEventListener('mousemove',e=>{
        if(!drag) return; const r=canvas.getBoundingClientRect();
        const x=(e.clientX-r.left)*1024/r.width, y=(e.clientY-r.top)*1024/r.height;
        k.x=Math.max(0,Math.min(1024,x)); k.y=Math.max(0,Math.min(1024,y));
        dot.style.left=k.x+'px'; dot.style.top=k.y+'px'; draw();
      });
      window.addEventListener('mouseup',()=>{ if(drag){drag=false;dot.classList.remove('drag');} });
      stage.appendChild(dot);
    });
  }

  $('#file').addEventListener('change', ()=>{
    const f=$('#file').files?.[0]; if(!f) return;
    const im=new Image(); im.onload=()=>{ img=im; draw(); placeKp(); }; im.src=URL.createObjectURL(f);
  });
  $('#showKp').addEventListener('click', ()=>{ showKp=!showKp; draw(); placeKp(); });
  $('#clear').addEventListener('click', ()=>{ draw(); }); // (keine Regionen hier)

  $('#random').addEventListener('click', ()=>{
    const ideas=['idle subtle sway','small head nods','walk-in-place soft','dance tiny loop','camera slow dolly in'];
    $('#prompt').value = ($('#prompt').value.trim()? $('#prompt').value+'\n':'') + ideas[Math.floor(Math.random()*ideas.length)];
  });

  // API Helpers
  const pickUrl=o=>o?.url||o?.result?.url||o?.data?.url||null;
  async function postMultipart(endpoint,payload,files){
    const fd=new FormData(); fd.append('payload', new Blob([JSON.stringify(payload)],{type:'application/json'}));
    for(const [n,f] of Object.entries(files||{})){ if(f) fd.append(n,f,f.name||n); }
    const r=await fetch(endpoint,{method:'POST',body:fd}); if(!r.ok) throw new Error(`HTTP ${r.status}`); return await r.json();
  }
  async function pollJob(id,{interval=1000,timeout=10*60*1000}={}){
    const t0=Date.now(); while(true){
      const r=await fetch(`/api/jobs/${id}`); if(!r.ok) throw new Error(`Job ${id}: HTTP ${r.status}`);
      const d=await r.json(); const st=(d.status||d.state||'').toLowerCase();
      if(['succeeded','success','done','finished'].includes(st)) return d;
      if(['failed','error'].includes(st)) throw new Error(d.error||'Job fehlgeschlagen');
      if(Date.now()-t0>timeout) throw new Error('Timeout'); await new Promise(rs=>setTimeout(rs,interval));
    }
  }
  function setBusy(b,msg){ $('#run').disabled=b; hud.textContent=msg||''; }

  $('#run').addEventListener('click', async ()=>{
    if(!img){ alert('Bitte Bild laden.'); return; }
    const mode=$('#mode').value;
    const audio=$('#audio').files?.[0];
    if(mode==='lipsync' && !audio){ alert('Bitte eine Audiodatei für Lip-Sync wählen.'); return; }

    const payload={
      mode, prompt: $('#prompt').value.trim(),
      duration:+$('#dur').value, fps:+$('#fps').value, speed:+$('#speed').value, loop: $('#loop').value==='true',
      kp, canvas_size:{w:canvas.width,h:canvas.height}, preview: $('#preview').value
    };
    try{
      setBusy(true,'Starte Job …');
      const start = await postMultipart('/api/motion/run', payload, {image: $('#file').files?.[0], audio});
      const direct = pickUrl(start); if(direct){ pushResult(direct); setBusy(false,'Fertig (Direkt)'); return; }
      const jobId=start.jobId||start.id||start.job; if(!jobId) throw new Error('Kein jobId');
      setBusy(true,'Warte auf Ergebnis…');
      const job = await pollJob(jobId);
      const url = pickUrl(job); if(!url) throw new Error('Kein Ergebnis-URL');
      pushResult(url); setBusy(false,'Fertig');
    }catch(e){ console.error(e); setBusy(false,'Fehler'); alert('Motion-Fehler: '+(e?.message||e)); }
  });

  function pushResult(url){
    const a=document.createElement('button'); a.className='btn'; a.textContent='Clip '+new Date().toLocaleTimeString();
    const item={url,generated:true,type:'video'}; a.addEventListener('click',()=>openOverlay(item));
    $('#results').prepend(a);
  }
  function openOverlay(item){ if(!item.generated) return; $('#ov-video').src=item.url; $('#ov-dl').href=item.url; $('#ov-dl').download='output.mp4'; $('#ov').style.display='flex'; }
  $('#ov-close').onclick=()=> $('#ov').style.display='none'; $('#ov-close2').onclick=()=> $('#ov').style.display='none';
})();
</script>
</body>
</html>
