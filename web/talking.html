<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="AI Talking Head Studio - Lip-Sync, Voice Cloning, Face Animation">
    <title>Talking – AndioMediaStudio</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22grad%22 x1=%220%%22 y1=%220%%22 x2=%22100%%22 y2=%22100%%22><stop offset=%220%%22 style=%22stop-color:%236aa3ff%22/><stop offset=%22100%%22 style=%22stop-color:%23b884ff%22/></linearGradient></defs><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22url(%23grad)%22/></svg>">
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <header class="header">
        <div class="brand">
            <span class="dot"></span>
            <span>Talking – AndioMediaStudio</span>
            <div class="badge nsfw">💬 Realistic Speech</div>
        </div>
        <nav>
            <a href="index.html">📊 Dashboard</a>
            <a href="create.html">🎨 Create</a>
            <a href="video.html">🎬 Video Lab</a>
            <a href="talking.html" class="active">💬 Talking</a>
            <a href="wardrobe.html">👔 Wardrobe</a>
            <a href="catalog.html">🏪 Store</a>
            <a href="gallery.html">🖼️ Gallery</a>
        </nav>
    </header>

    <main class="wrap">
        <div class="grid">
            <!-- Main Talking Head Panel -->
            <div class="card" style="grid-column: span 8;">
                <div class="flex">
                    <h2>💬 AI Talking Head Studio</h2>
                    <div class="right">
                        <div class="badge success" id="talkingModelStatus">Wav2Lip Ready</div>
                    </div>
                </div>
                
                <div id="progressHost"></div>

                <!-- Talking Head Modes -->
                <div class="talking-modes" style="margin: 20px 0;">
                    <label>🎭 Generation Mode</label>
                    <div class="mode-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <button class="btn mode-btn active" data-mode="lipsync" onclick="selectTalkingMode('lipsync')">
                            🎤 Lip-Sync
                            <small>Sync video to audio</small>
                        </button>
                        <button class="btn mode-btn" data-mode="talking" onclick="selectTalkingMode('talking')">
                            🗣️ Talking Head
                            <small>Animate from photo</small>
                        </button>
                        <button class="btn mode-btn" data-mode="voice_clone" onclick="selectTalkingMode('voice_clone')">
                            🎵 Voice Clone
                            <small>Clone & synthesize voice</small>
                        </button>
                        <button class="btn mode-btn" data-mode="face_swap" onclick="selectTalkingMode('face_swap')">
                            👥 Face Swap
                            <small>Replace face in video</small>
                        </button>
                    </div>
                </div>

                <!-- Text/Audio Input Section -->
                <div class="input-section">
                    <!-- Text Input -->
                    <div class="text-input" id="textInput">
                        <label>📝 Text to Speech</label>
                        <textarea id="speechText" class="input" rows="4" placeholder="Enter the text you want the person to say... Hallo, ich bin ein AI-generierter Avatar und kann jeden Text sprechen!"></textarea>
                        
                        <!-- Voice Settings -->
                        <div class="voice-settings" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">
                            <div>
                                <label>🎵 Voice</label>
                                <select id="voiceSelect" class="input">
                                    <option value="default">Standard Voice</option>
                                    <option value="female_1">Female Voice 1</option>
                                    <option value="male_1">Male Voice 1</option>
                                    <option value="child_1">Child Voice</option>
                                    <option value="custom">Custom Voice</option>
                                </select>
                            </div>
                            <div>
                                <label>⚡ Speed</label>
                                <input id="speechSpeed" class="input" type="range" min="0.5" max="2.0" step="0.1" value="1.0">
                                <div style="text-align: center; font-size: 12px;"><span id="speedValue">1.0x</span></div>
                            </div>
                            <div>
                                <label>🎶 Pitch</label>
                                <input id="speechPitch" class="input" type="range" min="0.5" max="2.0" step="0.1" value="1.0">
                                <div style="text-align: center; font-size: 12px;"><span id="pitchValue">1.0</span></div>
                            </div>
                        </div>

                        <div class="toolbar" style="margin-top: 12px;">
                            <button class="btn secondary" onclick="generateAudio()">🔊 Generate Audio</button>
                            <button class="btn secondary" onclick="playGeneratedAudio()">▶️ Preview</button>
                        </div>
                    </div>

                    <!-- Audio Upload -->
                    <div class="audio-upload" style="margin-top: 16px;">
                        <label>🎤 Or Upload Audio</label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="file" id="audioFile" accept="audio/*" class="input" style="flex: 1;">
                            <button class="btn secondary" onclick="recordAudio()" id="recordBtn">🎙️ Record</button>
                        </div>
                        <div id="audioPreview" style="margin-top: 8px;"></div>
                    </div>
                </div>

                <!-- Media Upload Section -->
                <div class="media-uploads" style="margin-top: 20px;">
                    <div class="card" style="background: var(--glass-bg);">
                        <h3>📁 Media Assets</h3>
                        <div class="upload-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            
                            <!-- Face Image/Video Upload -->
                            <div class="upload-zone" id="faceUpload">
                                <label>👤 Face Source</label>
                                <input type="file" id="faceFile" accept="image/*,video/*" class="input">
                                <div class="upload-preview" id="facePreview"></div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                    Image for photo → video, Video for lip-sync
                                </div>
                            </div>

                            <!-- Reference Video (for face swap) -->
                            <div class="upload-zone" id="referenceUpload" style="display: none;">
                                <label>🎬 Reference Video</label>
                                <input type="file" id="referenceFile" accept="video/*" class="input">
                                <div class="upload-preview" id="referencePreview"></div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                    Target video for face swap
                                </div>
                            </div>

                            <!-- Voice Sample (for cloning) -->
                            <div class="upload-zone" id="voiceSampleUpload" style="display: none;">
                                <label>🎵 Voice Sample</label>
                                <input type="file" id="voiceSampleFile" accept="audio/*" class="input">
                                <div class="upload-preview" id="voiceSamplePreview"></div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                    Clean voice sample (10-30 seconds)
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Generation Controls -->
                <div class="generation-controls" style="margin-top: 20px;">
                    <div class="toolbar">
                        <button class="btn" id="generateTalkingBtn" disabled>
                            🗣️ Generate Talking Head
                        </button>
                        <button class="btn secondary" id="previewModeBtn">
                            👁️ Preview Mode
                        </button>
                        <button class="btn secondary" onclick="enhanceQuality()">
                            ✨ Enhance Quality
                        </button>
                        <button class="btn secondary" onclick="resetTalkingSettings()">
                            🔄 Reset
                        </button>
                    </div>
                </div>

                <!-- Results Preview -->
                <div class="talking-results" id="talkingResults" style="display: none; margin-top: 24px;">
                    <h3>🎯 Generated Talking Heads</h3>
                    <div class="results-grid" id="talkingGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="card" style="grid-column: span 4;">
                <h2>⚙️ Talking Head Settings</h2>

                <!-- Quality Settings -->
                <div style="margin-bottom: 16px;">
                    <label>Quality Preset</label>
                    <select id="talkingQuality" class="input">
                        <option value="FAST">⚡ Fast</option>
                        <option value="BALANCED" selected>⚖️ Balanced</option>
                        <option value="ULTRA">💎 Ultra</option>
                    </select>
                </div>

                <!-- Animation Parameters -->
                <div class="animation-params" style="margin-bottom: 16px;">
                    <label>🎭 Animation Settings</label>
                    <div class="param-grid" style="display: grid; gap: 12px;">
                        <div>
                            <label>Expression Intensity</label>
                            <input id="expressionIntensity" class="input" type="range" min="0.1" max="2.0" step="0.1" value="1.0">
                            <div style="text-align: center; font-size: 12px;"><span id="expressionValue">1.0</span></div>
                        </div>
                        <div>
                            <label>Head Movement</label>
                            <input id="headMovement" class="input" type="range" min="0.0" max="1.0" step="0.1" value="0.3">
                            <div style="text-align: center; font-size: 12px;"><span id="movementValue">0.3</span></div>
                        </div>
                        <div>
                            <label>Eye Blink Rate</label>
                            <input id="blinkRate" class="input" type="range" min="0.1" max="2.0" step="0.1" value="1.0">
                            <div style="text-align: center; font-size: 12px;"><span id="blinkValue">1.0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Options -->
                <div class="advanced-options" style="margin-bottom: 16px;">
                    <details>
                        <summary style="cursor: pointer; padding: 8px; background: var(--glass-bg); border-radius: 8px;">
                            <strong>🔧 Advanced Options</strong>
                        </summary>
                        <div style="padding: 12px; margin-top: 8px;">
                            <div style="margin-bottom: 12px;">
                                <label>
                                    <input type="checkbox" id="faceEnhancement"> Face Enhancement
                                </label>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label>
                                    <input type="checkbox" id="backgroundBlur"> Background Blur
                                </label>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label>
                                    <input type="checkbox" id="stabilization" checked> Video Stabilization
                                </label>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label>Upscale Factor</label>
                                <select id="upscaleFactor" class="input">
                                    <option value="1">Original Size</option>
                                    <option value="2" selected>2x Upscale</option>
                                    <option value="4">4x Upscale</option>
                                </select>
                            </div>
                            <div>
                                <label>Output Format</label>
                                <select id="outputFormat" class="input">
                                    <option value="mp4">MP4 (H.264)</option>
                                    <option value="webm">WebM</option>
                                    <option value="gif">Animated GIF</option>
                                </select>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- Model Selection -->
                <div class="talking-models" style="margin-bottom: 16px;">
                    <h3>🤖 AI Model</h3>
                    <div class="model-selector" id="talkingModelSelector">
                        <div class="loading">Loading talking head models...</div>
                    </div>
                </div>

                <!-- Performance Monitor -->
                <div class="performance-monitor" style="margin-bottom: 16px;">
                    <h4>📊 Performance</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px;">
                        <div>GPU Memory: <span id="gpuMemory">--</span></div>
                        <div>Processing: <span id="processingStatus">Idle</span></div>
                        <div>Queue: <span id="queueLength">0</span></div>
                        <div>Est. Time: <span id="estimatedTime">--</span></div>
                    </div>
                </div>

                <!-- Quick Presets -->
                <div class="quick-presets">
                    <h4>⚡ Quick Presets</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <button class="btn secondary" onclick="applyPreset('natural')">😊 Natural</button>
                        <button class="btn secondary" onclick="applyPreset('expressive')">🎭 Expressive</button>
                        <button class="btn secondary" onclick="applyPreset('subtle')">😌 Subtle</button>
                        <button class="btn secondary" onclick="applyPreset('dramatic')">🎬 Dramatic</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio Recorder Modal -->
        <div class="modal" id="audioRecorderModal" style="display: none;">
            <div class="modal-backdrop" onclick="closeAudioRecorder()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>🎙️ Audio Recorder</h3>
                    <button class="btn secondary" onclick="closeAudioRecorder()">✖️</button>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <div class="recording-visualizer" id="audioVisualizer" style="height: 100px; background: var(--glass-bg); border-radius: 8px; margin: 16px 0; display: flex; align-items: center; justify-content: center;">
                        <div id="visualizerContent">🎤 Click record to start</div>
                    </div>
                    <div class="recording-controls">
                        <button class="btn" id="recordControlBtn" onclick="toggleRecording()">🔴 Start Recording</button>
                        <button class="btn secondary" id="playRecordingBtn" onclick="playRecording()" disabled>▶️ Play</button>
                        <button class="btn secondary" id="saveRecordingBtn" onclick="saveRecording()" disabled>💾 Save</button>
                    </div>
                    <div id="recordingInfo" style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">
                        Duration: <span id="recordingDuration">00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="assets/app.js"></script>
    <script>
        // Enhanced Talking Head Studio
        class TalkingStudio {
            constructor() {
                this.progressManager = new ProgressManager(document);
                this.progressManager.mount();
                this.currentMode = 'lipsync';
                this.uploadedFiles = {};
                this.audioRecorder = null;
                this.recordedAudio = null;
                this.isRecording = false;
                
                this.setupEventListeners();
                this.setupModelSelector();
                this.setupRangeSliders();
                this.selectTalkingMode('lipsync');
            }

            setupEventListeners() {
                // Generation button
                document.getElementById('generateTalkingBtn')?.addEventListener('click', () => {
                    this.generateTalkingHead();
                });

                // File uploads
                document.getElementById('faceFile')?.addEventListener('change', (e) => {
                    this.handleFileUpload(e, 'face', 'facePreview');
                });

                document.getElementById('referenceFile')?.addEventListener('change', (e) => {
                    this.handleFileUpload(e, 'reference', 'referencePreview');
                });

                document.getElementById('voiceSampleFile')?.addEventListener('change', (e) => {
                    this.handleFileUpload(e, 'voiceSample', 'voiceSamplePreview');
                });

                document.getElementById('audioFile')?.addEventListener('change', (e) => {
                    this.handleFileUpload(e, 'audio', 'audioPreview');
                });

                // Preview mode
                document.getElementById('previewModeBtn')?.addEventListener('click', () => {
                    this.previewMode();
                });

                // Text change
                document.getElementById('speechText')?.addEventListener('input', () => {
                    this.updateGenerationButton();
                });
            }

            setupRangeSliders() {
                const sliders = [
                    { input: 'speechSpeed', display: 'speedValue', suffix: 'x' },
                    { input: 'speechPitch', display: 'pitchValue', suffix: '' },
                    { input: 'expressionIntensity', display: 'expressionValue', suffix: '' },
                    { input: 'headMovement', display: 'movementValue', suffix: '' },
                    { input: 'blinkRate', display: 'blinkValue', suffix: '' }
                ];

                sliders.forEach(({ input, display, suffix }) => {
                    const inputEl = document.getElementById(input);
                    const displayEl = document.getElementById(display);
                    
                    if (inputEl && displayEl) {
                        inputEl.addEventListener('input', () => {
                            displayEl.textContent = inputEl.value + suffix;
                        });
                    }
                });
            }

            async setupModelSelector() {
                const container = document.getElementById('talkingModelSelector');
                if (!container) return;

                // Simulate model loading for demo
                container.innerHTML = `
                    <div class="model-card selected" data-model="wav2lip">
                        <div class="model-header">
                            <h4>Wav2Lip</h4>
                            <div class="model-type">Lip-Sync</div>
                        </div>
                        <div class="model-info">
                            <div class="model-group">Talking Model</div>
                            <div class="model-size">299 MB</div>
                        </div>
                        <div class="tags">
                            <span class="tag">lipsync</span>
                            <span class="tag">realtime</span>
                        </div>
                    </div>
                    <div class="model-card" data-model="sadtalker" style="margin-top: 8px;">
                        <div class="model-header">
                            <h4>SadTalker</h4>
                            <div class="model-type">Full Face</div>
                        </div>
                        <div class="model-info">
                            <div class="model-group">Talking Model</div>
                            <div class="model-size">1.2 GB</div>
                        </div>
                        <div class="tags">
                            <span class="tag">talking</span>
                            <span class="tag">emotion</span>
                        </div>
                    </div>
                `;

                // Add click handlers
                container.querySelectorAll('.model-card').forEach(card => {
                    card.addEventListener('click', () => {
                        container.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        const statusElement = document.getElementById('talkingModelStatus');
                        if (statusElement) {
                            statusElement.textContent = `Model: ${card.dataset.model}`;
                        }
                    });
                });
            }

            selectTalkingMode(mode) {
                this.currentMode = mode;
                
                // Update UI
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });

                // Show/hide upload sections
                const referenceUpload = document.getElementById('referenceUpload');
                const voiceSampleUpload = document.getElementById('voiceSampleUpload');
                const textInput = document.getElementById('textInput');

                // Reset visibility
                referenceUpload.style.display = 'none';
                voiceSampleUpload.style.display = 'none';
                textInput.style.display = 'block';

                switch(mode) {
                    case 'lipsync':
                        // Default setup - just face and audio
                        break;
                    case 'talking':
                        // Photo to video - just face and text
                        break;
                    case 'voice_clone':
                        voiceSampleUpload.style.display = 'block';
                        break;
                    case 'face_swap':
                        referenceUpload.style.display = 'block';
                        textInput.style.display = 'none';
                        break;
                }

                this.updateGenerationButton();
            }

            async handleFileUpload(event, type, previewId) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const result = await window.AndioStudio.fileManager.uploadFile(event.target, 'workspace');
                    this.uploadedFiles[type] = result;

                    // Show preview
                    const preview = document.getElementById(previewId);
                    if (preview && result) {
                        if (type === 'audio' || type === 'voiceSample') {
                            // Audio preview
                            preview.innerHTML = `
                                <div class="file-preview" style="margin-top: 8px;">
                                    <audio controls style="width: 100%;">
                                        <source src="${result.url}" type="audio/mpeg">
                                    </audio>
                                    <div class="file-info" style="font-size: 12px; margin-top: 4px;">
                                        ${result.name} (${window.AndioStudio.fileManager.formatFileSize(result.size)})
                                    </div>
                                </div>
                            `;
                        } else if (result.type === 'video') {
                            // Video preview
                            preview.innerHTML = `
                                <div class="file-preview" style="margin-top: 8px;">
                                    <video style="max-width: 100%; max-height: 80px; border-radius: 6px;" muted>
                                        <source src="${result.url}" type="video/mp4">
                                    </video>
                                    <div class="file-info" style="font-size: 12px; margin-top: 4px;">
                                        ${result.name} (${window.AndioStudio.fileManager.formatFileSize(result.size)})
                                    </div>
                                </div>
                            `;
                        } else {
                            // Image preview
                            preview.innerHTML = `
                                <div class="file-preview" style="margin-top: 8px;">
                                    <img src="${result.url}" alt="${result.name}" style="max-width: 100%; max-height: 80px; border-radius: 6px;">
                                    <div class="file-info" style="font-size: 12px; margin-top: 4px;">
                                        ${result.name} (${window.AndioStudio.fileManager.formatFileSize(result.size)})
                                    </div>
                                </div>
                            `;
                        }
                    }

                    window.AndioStudio?.toast?.success(`📁 ${type} uploaded: ${result.name}`);
                    this.updateGenerationButton();

                } catch (error) {
                    window.AndioStudio?.toast?.error(`Upload failed: ${error.message}`);
                }
            }

            updateGenerationButton() {
                const generateBtn = document.getElementById('generateTalkingBtn');
                if (!generateBtn) return;

                const hasRequiredFiles = this.hasRequiredFiles();
                const hasTextOrAudio = document.getElementById('speechText')?.value?.trim() || this.uploadedFiles.audio;

                const canGenerate = hasRequiredFiles && (hasTextOrAudio || this.currentMode === 'face_swap');
                
                generateBtn.disabled = !canGenerate;
                generateBtn.textContent = canGenerate ? 
                    `🗣️ Generate ${this.getModeDisplayName()}` : 
                    '🚫 Missing Requirements';
            }

            hasRequiredFiles() {
                switch(this.currentMode) {
                    case 'lipsync':
                        return this.uploadedFiles.face && (this.uploadedFiles.audio || document.getElementById('speechText')?.value?.trim());
                    case 'talking':
                        return this.uploadedFiles.face;
                    case 'voice_clone':
                        return this.uploadedFiles.face && this.uploadedFiles.voiceSample;
                    case 'face_swap':
                        return this.uploadedFiles.face && this.uploadedFiles.reference;
                    default:
                        return false;
                }
            }

            getModeDisplayName() {
                const modes = {
                    'lipsync': 'Lip-Sync',
                    'talking': 'Talking Head',
                    'voice_clone': 'Voice Clone',
                    'face_swap': 'Face Swap'
                };
                return modes[this.currentMode] || 'Unknown';
            }

            async generateTalkingHead() {
                window.AndioStudio?.toast?.info('🚧 Talking head generation is being implemented - this is a preview interface');
                
                // Simulate generation process
                const jobId = Date.now().toString();
                
                this.progressManager.connect(jobId, {
                    onCompleted: () => {
                        window.AndioStudio?.toast?.success('🗣️ Talking head generation completed!');
                        this.showMockResults();
                    }
                });

                // Simulate progress
                await this.simulateProgress(jobId);
            }

            async simulateProgress(jobId) {
                const steps = ['Loading model...', 'Processing face...', 'Analyzing audio...', 'Generating frames...', 'Encoding video...'];
                
                for (let i = 0; i < steps.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    await this.progressManager.onProgress({
                        status: 'generating',
                        step: i + 1,
                        total: steps.length,
                        text: steps[i],
                        job_id: jobId
                    });
                }

                await this.progressManager.onProgress({
                    status: 'completed',
                    step: steps.length,
                    total: steps.length,
                    text: 'Completed!',
                    job_id: jobId
                });
            }

            showMockResults() {
                const resultsSection = document.getElementById('talkingResults');
                const resultsGrid = document.getElementById('talkingGrid');
                
                if (resultsSection && resultsGrid) {
                    resultsSection.style.display = 'block';
                    
                    resultsGrid.innerHTML = `
                        <div class="result-placeholder" style="background: var(--glass-bg); border: 2px dashed var(--border-primary); border-radius: 12px; padding: 40px; text-align: center; color: var(--text-muted);">
                            <div style="font-size: 48px; margin-bottom: 16px;">🗣️</div>
                            <h4>Generated Talking Head</h4>
                            <p>Your AI-generated talking head video would appear here</p>
                            <div style="margin-top: 16px;">
                                <div class="badge success">Mode: ${this.getModeDisplayName()}</div>
                            </div>
                        </div>
                    `;
                    
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                }
            }

            previewMode() {
                window.AndioStudio?.toast?.info('👁️ Preview mode - generating preview frame');
                
                // Show preview of what the talking head would look like
                const faceFile = this.uploadedFiles.face;
                if (faceFile) {
                    const preview = document.createElement('div');
                    preview.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid var(--border-accent); box-shadow: var(--shadow-lg);">
                            <h3>Preview Mode</h3>
                            <img src="${faceFile.url}" style="max-width: 300px; border-radius: 8px;">
                            <div style="margin-top: 12px; text-align: center;">
                                <button onclick="this.parentElement.parentElement.remove()" class="btn secondary">Close Preview</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(preview);
                }
            }
        }

        // Global helper functions
        window.selectTalkingMode = function(mode) {
            if (window.talkingStudio) {
                window.talkingStudio.selectTalkingMode(mode);
            }
        };

        window.generateAudio = function() {
            const text = document.getElementById('speechText')?.value?.trim();
            if (!text) {
                window.AndioStudio?.toast?.warning('Please enter text to generate audio');
                return;
            }
            
            window.AndioStudio?.toast?.info('🔊 Audio generation would be implemented with TTS service');
            
            // Mock audio generation
            const audioPreview = document.getElementById('audioPreview');
            if (audioPreview) {
                audioPreview.innerHTML = `
                    <div class="generated-audio" style="background: var(--glass-bg); padding: 12px; border-radius: 8px; margin-top: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>🔊 Generated Audio</span>
                            <button class="btn secondary" style="padding: 4px 8px; font-size: 12px;" onclick="playGeneratedAudio()">▶️ Play</button>
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                            Duration: ${Math.round(text.length / 10)}s | Voice: ${document.getElementById('voiceSelect')?.value || 'default'}
                        </div>
                    </div>
                `;
            }
        };

        window.playGeneratedAudio = function() {
            window.AndioStudio?.toast?.info('▶️ Playing generated audio...');
        };

        window.recordAudio = function() {
            document.getElementById('audioRecorderModal').style.display = 'flex';
        };

        window.closeAudioRecorder = function() {
            if (window.talkingStudio?.isRecording) {
                window.talkingStudio.stopRecording();
            }
            document.getElementById('audioRecorderModal').style.display = 'none';
        };

        window.toggleRecording = function() {
            if (window.talkingStudio) {
                if (window.talkingStudio.isRecording) {
                    window.talkingStudio.stopRecording();
                } else {
                    window.talkingStudio.startRecording();
                }
            }
        };

        window.playRecording = function() {
            if (window.talkingStudio?.recordedAudio) {
                window.talkingStudio.recordedAudio.play();
            }
        };

        window.saveRecording = function() {
            if (window.talkingStudio?.recordedAudio) {
                const link = document.createElement('a');
                link.href = window.talkingStudio.recordedAudio.src;
                link.download = 'recorded_audio.wav';
                link.click();
                
                window.AndioStudio?.toast?.success('🎙️ Recording saved');
                closeAudioRecorder();
            }
        };

        window.enhanceQuality = function() {
            window.AndioStudio?.toast?.info('✨ Quality enhancement would upscale and improve the final video');
        };

        window.resetTalkingSettings = function() {
            // Reset all form elements
            const elements = {
                'speechText': '',
                'speechSpeed': 1.0,
                'speechPitch': 1.0,
                'expressionIntensity': 1.0,
                'headMovement': 0.3,
                'blinkRate': 1.0,
                'voiceSelect': 'default',
                'talkingQuality': 'BALANCED'
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value;
                    // Trigger change event to update displays
                    element.dispatchEvent(new Event('input'));
                }
            });

            // Reset checkboxes
            document.getElementById('faceEnhancement').checked = false;
            document.getElementById('backgroundBlur').checked = false;
            document.getElementById('stabilization').checked = true;

            window.AndioStudio?.toast?.info('🔄 Settings reset to defaults');
        };

        window.applyPreset = function(preset) {
            const presets = {
                natural: {
                    expressionIntensity: 0.8,
                    headMovement: 0.2,
                    blinkRate: 1.0
                },
                expressive: {
                    expressionIntensity: 1.5,
                    headMovement: 0.5,
                    blinkRate: 1.2
                },
                subtle: {
                    expressionIntensity: 0.5,
                    headMovement: 0.1,
                    blinkRate: 0.8
                },
                dramatic: {
                    expressionIntensity: 2.0,
                    headMovement: 0.8,
                    blinkRate: 1.5
                }
            };

            const settings = presets[preset];
            if (settings) {
                Object.entries(settings).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = value;
                        element.dispatchEvent(new Event('input'));
                    }
                });

                window.AndioStudio?.toast?.success(`Applied ${preset} preset`);
            }
        };

        // Extend TalkingStudio with recording functionality
        TalkingStudio.prototype.startRecording = async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.audioRecorder = new MediaRecorder(stream);
                this.audioChunks = [];
                
                this.audioRecorder.ondataavailable = (event) => {
                    this.audioChunks.push(event.data);
                };

                this.audioRecorder.onstop = () => {
                    const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    this.recordedAudio = new Audio(audioUrl);
                    
                    // Enable play and save buttons
                    document.getElementById('playRecordingBtn').disabled = false;
                    document.getElementById('saveRecordingBtn').disabled = false;
                };

                this.audioRecorder.start();
                this.isRecording = true;
                this.startTime = Date.now();

                // Update UI
                document.getElementById('recordControlBtn').textContent = '⏹️ Stop Recording';
                document.getElementById('visualizerContent').textContent = '🔴 Recording...';
                
                // Start duration counter
                this.updateRecordingDuration();
                
                window.AndioStudio?.toast?.success('🎙️ Recording started');

            } catch (error) {
                window.AndioStudio?.toast?.error('Failed to access microphone');
                console.error('Recording error:', error);
            }
        };

        TalkingStudio.prototype.stopRecording = function() {
            if (this.audioRecorder && this.isRecording) {
                this.audioRecorder.stop();
                this.audioRecorder.stream.getTracks().forEach(track => track.stop());
                this.isRecording = false;

                // Update UI
                document.getElementById('recordControlBtn').textContent = '🔴 Start Recording';
                document.getElementById('visualizerContent').textContent = '✅ Recording complete';
                
                window.AndioStudio?.toast?.success('🎙️ Recording completed');
            }
        };

        TalkingStudio.prototype.updateRecordingDuration = function() {
            if (this.isRecording) {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                
                document.getElementById('recordingDuration').textContent = `${minutes}:${seconds}`;
                
                setTimeout(() => this.updateRecordingDuration(), 1000);
            }
        };

        // Initialize Talking Studio
        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.talkingStudio = new TalkingStudio();
                console.log('Talking Studio initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Talking Studio:', error);
            }
        });

        // Add talking-specific styles
        const talkingStyles = `
            <style>
                .talking-modes .mode-btn {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    padding: 16px 12px;
                    text-align: center;
                    transition: all 0.3s ease;
                }
                
                .talking-modes .mode-btn.active {
                    background: var(--accent-gradient);
                    color: white;
                    box-shadow: var(--shadow-glow);
                    transform: translateY(-2px);
                }
                
                .talking-modes .mode-btn small {
                    font-size: 11px;
                    opacity: 0.8;
                    margin-top: 4px;
                }
                
                .input-section {
                    background: var(--glass-bg);
                    border: 1px solid var(--border-primary);
                    border-radius: 16px;
                    padding: 20px;
                    margin: 16px 0;
                }
                
                .voice-settings {
                    background: rgba(106, 163, 255, 0.05);
                    border: 1px solid rgba(106, 163, 255, 0.2);
                    border-radius: 12px;
                    padding: 12px;
                }
                
                .upload-zone {
                    background: var(--glass-bg);
                    border: 2px dashed var(--border-primary);
                    border-radius: 12px;
                    padding: 16px;
                    text-align: center;
                    transition: var(--transition-normal);
                }
                
                .upload-zone:hover {
                    border-color: var(--accent-primary);
                    background: rgba(106, 163, 255, 0.05);
                }
                
                .param-grid {
                    background: var(--glass-bg);
                    border: 1px solid var(--border-primary);
                    border-radius: 8px;
                    padding: 12px;
                }
                
                .modal {
                    position: fixed;
                    inset: 0;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(10px);
                }
                
                .modal-backdrop {
                    position: absolute;
                    inset: 0;
                    cursor: pointer;
                }
                
                .modal-content {
                    position: relative;
                    background: var(--bg-card);
                    border: 1px solid var(--border-primary);
                    border-radius: 20px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: var(--shadow-lg);
                }
                
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 16px 24px;
                    border-bottom: 1px solid var(--border-primary);
                    background: var(--glass-bg);
                    border-radius: 20px 20px 0 0;
                }
                
                .modal-body {
                    padding: 24px;
                }
                
                .recording-visualizer {
                    background: linear-gradient(45deg, var(--glass-bg), rgba(106, 163, 255, 0.1));
                    border: 1px solid var(--border-primary);
                    animation: pulse 2s infinite;
                }
                
                .recording-controls {
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                }
                
                .generated-audio {
                    animation: slideIn 0.3s ease-out;
                }
                
                @keyframes slideIn {
                    from { transform: translateY(-10px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                
                .result-placeholder {
                    animation: fadeIn 0.5s ease-out;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; transform: scale(0.95); }
                    to { opacity: 1; transform: scale(1); }
                }
                
                @media (max-width: 768px) {
                    .talking-modes .mode-buttons {
                        grid-template-columns: 1fr 1fr;
                    }
                    
                    .voice-settings {
                        grid-template-columns: 1fr;
                    }
                    
                    .modal-content {
                        max-width: 95%;
                        margin: 20px;
                    }
                }
            </style>
        `;
        
        document.head.insertAdjacentHTML('beforeend', talkingStyles);
    </script>
</body>
</html>