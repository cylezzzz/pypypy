<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Video Studio Â· AndioMediaStudio</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <style>
    :root { --gap: 10px; }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    @media(max-width:1024px){ .split{grid-template-columns:1fr} }
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{cursor:pointer} .chip.active{outline:2px solid var(--accent);border-radius:999px}
    .subtle{color:var(--muted);font-size:12px}
    .panel{display:grid;grid-template-columns:360px 1fr;gap:var(--gap)}
    @media(max-width:1200px){ .panel{grid-template-columns:1fr} }
    .preview-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    @media(max-width:1024px){ .preview-grid{grid-template-columns:1fr} }
    .preview-box{position:relative;min-height:420px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0b0f1a}
    .preview-box h4{position:absolute;top:8px;left:10px;margin:0;font-size:12px;color:#c6c9d4;background:#0f1628;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    .preview-box .pad{padding:48px 12px 12px}
    .preview-box img,.preview-box video,.preview-box canvas{display:block;max-width:100%;max-height:100%;margin:auto}
    .drop{position:relative;border:1px dashed var(--border);border-radius:12px;padding:12px;text-align:center;background:#0f1628}
    .drop input{position:absolute;inset:0;opacity:0;cursor:pointer}
    .toast{position:fixed;bottom:26px;right:26px;background:linear-gradient(180deg,rgba(24,32,54,.95),rgba(14,20,36,.95));border:1px solid var(--border);padding:12px 14px;border-radius:14px;box-shadow:var(--shadow-md);z-index:80}
    .progress{height:8px;background:#101626;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .progress>div{height:100%;width:0;background:var(--accent)}
    /* SFW/NSFW Switch, voll klickbar + tastaturfÃ¤hig */
    .switch{position:relative;width:58px;height:28px;background:#1a2236;border:1px solid var(--border);border-radius:999px;cursor:pointer}
    .switch input{position:absolute;inset:0;opacity:0}
    .knob{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:linear-gradient(180deg,#fff,#cfd6ff);box-shadow:0 2px 8px rgba(0,0,0,.35);transition:left .18s}
    .switch input:checked ~ .knob{ left:32px }
    .switch .labels{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--muted);padding:0 8px;pointer-events:none}
  </style>
</head>
<body>
<script src="assets/data/registry.js"></script>
<script src="assets/app.js"></script>
<script>window.Andio=window.Andio||{}; Andio.injectNavbar?.('video-gen');</script>

<div class="container">
  <h1>Video Studio</h1>

  <div class="panel">
    <!-- ====== STEUERUNG LINKS ====== -->
    <div class="card">
      <h3>1) Modus & Sicherheit</h3>
      <div class="row">
        <div class="toolbar" style="gap:8px">
          <button class="btn mode primary" data-mode="t2v">Text â†’ Video</button>
          <button class="btn mode" data-mode="ti2v">Text+Bild â†’ Video</button>
        </div>
        <label class="switch" title="SFW â†” NSFW" aria-label="SFW oder NSFW" role="switch" aria-checked="false" tabindex="0" style="margin-left:auto">
          <input id="nsfwToggle" type="checkbox"/>
          <div class="knob"></div><div class="labels"><span>SFW</span><span>NSFW</span></div>
        </label>
      </div>

      <!-- Modus-spezifisch -->
      <section data-pane="ti2v" style="display:none;margin-top:10px">
        <label>Referenzbild</label>
        <div class="drop">
          <input id="refImg" type="file" accept="image/*"/>
          <div class="subtle">Bild hier ablegen oder klicken, um auszuwÃ¤hlen</div>
        </div>
      </section>

      <h3 style="margin-top:14px">2) Kategorie & VorschlÃ¤ge</h3>
      <div class="split">
        <div>
          <label>Genre/Motiv</label>
          <select id="genre" class="input"><option value="">â€” Bitte Genre wÃ¤hlen â€”</option></select>
        </div>
        <div>
          <label>Bewegungsstil</label>
          <select id="motionStyle" class="input"></select>
        </div>
      </div>
      <div class="split" style="margin-top:8px">
        <div>
          <label>Kamera</label>
          <select id="camera" class="input"></select>
        </div>
        <div>
          <label>Color-Grade</label>
          <select id="grade" class="input"></select>
        </div>
      </div>
      <div class="subtle" style="margin-top:6px">Schnellstart: Vorschlags-Chip klicken</div>
      <div id="chips" class="chips"></div>

      <hr/>
      <h3>3) Ausgabe</h3>
      <div class="split">
        <div>
          <label>Format</label>
          <select id="format" class="input">
            <option value="16:9" selected>16:9</option>
            <option value="9:16">9:16</option>
            <option value="1:1">1:1</option>
            <option value="2.39:1">2.39:1</option>
          </select>
        </div>
        <div><label>AuflÃ¶sung</label><select id="res" class="input"></select></div>
        <div><label>LÃ¤nge (Sek.)</label><input id="length" type="number" class="input" value="8"/></div>
        <div><label>FPS</label><input id="fps" type="number" class="input" value="24"/></div>
      </div>

      <hr/>
      <h3>4) Modell & Ãœ18</h3>
      <div class="split">
        <div>
          <label class="badge"><input id="smartModel" type="checkbox" checked> Smart Modell</label>
          <select id="model" class="input" disabled></select>
          <div class="subtle" id="modelHint" style="margin-top:6px"></div>
        </div>
        <div id="nsfwBlock" style="display:none">
          <label class="badge"><input id="adultConsent" type="checkbox"> Ãœ18 & Einwilligung bestÃ¤tigt</label>
        </div>
      </div>

      <hr/>
      <div class="toolbar">
        <button id="btnRandom" class="btn primary">ðŸŽ² Zufall</button>
        <button id="render" class="btn">Rendern</button>
        <button id="save" class="btn ok">Download</button>
        <button id="reset" class="btn">Reset</button>
      </div>
    </div>

    <!-- ====== VORSCHAU & PROMPT RECHTS ====== -->
    <div class="card">
      <h3>Vorschau</h3>

      <div class="preview-grid">
        <!-- Quelle -->
        <div class="preview-box">
          <h4>Quelle</h4>
          <div class="pad" id="srcBox">
            <div class="subtle">Text â†’ Video: kein Original nÃ¶tig</div>
          </div>
        </div>
        <!-- Ergebnis -->
        <div class="preview-box">
          <h4>Ergebnis</h4>
          <div class="pad" id="outBox">
            <div class="progress"><div id="progBar"></div></div>
            <div id="resultWrap" style="margin-top:10px"></div>
          </div>
        </div>
      </div>

      <h3 style="margin-top:12px">Prompt</h3>
      <textarea id="promptBox" class="input" rows="3" placeholder="Zufall fÃ¼llt hier automatischâ€¦"></textarea>
      <label style="margin-top:8px;display:block">Negative</label>
      <textarea id="negative" class="input" rows="2" placeholder="Artefakte, Ruckler, Ghosting â€¦"></textarea>
    </div>
  </div>
</div>

<footer>Â© AndioMediaStudio</footer>

<script>
/* ===== SHIMs ===== */
const $ = (s,r=document)=>r.querySelector(s);
const $$= (s,r=document)=>Array.from(r.querySelectorAll(s));
const pm = { set:(p)=>{ const b=$('#progBar'); if(!b) return; b.style.transition='width .25s'; b.style.width=(p||0)+'%'; } };

/* ===== Daten ===== */
const RES_BY_FORMAT = {
  '16:9':['1280Ã—720 (720p)','1920Ã—1080 (1080p)','2560Ã—1440 (1440p)','3840Ã—2160 (4K)'],
  '9:16':['720Ã—1280','1080Ã—1920','1440Ã—2560'],
  '1:1' :['768Ã—768','1024Ã—1024','1536Ã—1536'],
  '2.39:1':['1920Ã—804','4096Ã—1716']
};
const pick=a=>a[Math.floor(Math.random()*a.length)];
let V, VMODELS, mode='t2v', SRC_IMG_URL=null;

/* ===== Switch voll klickbar + Tastatur ===== */
(function wireSwitch(){
  const sw = $('.switch'); const input = $('#nsfwToggle');
  const sync=()=> sw.setAttribute('aria-checked', input.checked?'true':'false');
  sw.addEventListener('click', e=>{ if(e.target!==input){ input.checked=!input.checked; input.dispatchEvent(new Event('change',{bubbles:true})); } sync();});
  sw.addEventListener('keydown', e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); input.checked=!input.checked; input.dispatchEvent(new Event('change',{bubbles:true})); sync();}});
  input.addEventListener('change', sync); sync();
})();

/* ===== Helpers ===== */
function setSel(el, items){ el.innerHTML=(items||[]).map(x=>`<option value="${x.id||x}">${x.name||x}</option>`).join(''); }
function setRes(fmt){ $('#format').value=fmt; setSel($('#res'), RES_BY_FORMAT[fmt]); $('#res').value=RES_BY_FORMAT[fmt][1]||RES_BY_FORMAT[fmt][0]; }
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 1800); }
function wipeOut(){ $('#resultWrap').innerHTML=''; pm.set(0); }
function wipeSrc(){ $('#srcBox').innerHTML='<div class="subtle">Text â†’ Video: kein Original nÃ¶tig</div>'; }
function setMode(m){
  mode=m;
  $$('.btn.mode').forEach(b=>b.classList.toggle('primary', b.dataset.mode===m));
  $$('[data-pane]').forEach(p=> p.style.display = (p.dataset.pane===m) ? 'block' : 'none');
  if(m==='t2v'){ wipeSrc(); }
}

/* ===== Drag&Drop/Upload fÃ¼r ti2v ===== */
(function wireUpload(){
  const input = $('#refImg');
  input?.addEventListener('change', e=>{
    const f = e.target.files?.[0]; if(!f) return;
    if(SRC_IMG_URL) URL.revokeObjectURL(SRC_IMG_URL);
    SRC_IMG_URL = URL.createObjectURL(f);
    const img = new Image(); img.src=SRC_IMG_URL;
    const wrap = document.createElement('div'); wrap.appendChild(img);
    $('#srcBox').innerHTML=''; $('#srcBox').appendChild(wrap);
  });
})();

/* ===== Boot ===== */
async function bootVideo(){
  // Presets/Lexika
  V = await (window.Andio?.presets?.video?.() || mockVideoPresets());
  setSel($('#genre'), [{id:'',name:'â€” Bitte Genre wÃ¤hlen â€”'}, ...V.genres]);
  setSel($('#camera'), V.cameras);
  setSel($('#motionStyle'), V.motions);
  setSel($('#grade'), V.grades);
  setRes('16:9');

  // Vorschlags-Chips
  const chips = featuredChips(V.featured, {nsfw: $('#nsfwToggle').checked, n:16});
  $('#chips').innerHTML = chips.map(c=>`<span class="badge chip">${c}</span>`).join('');
  $$('.chip').forEach(el=>el.addEventListener('click',()=>{
    $$('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active');
    const g = V.genres.find(x=>x.name===el.textContent); if(g){ $('#genre').value=g.id; bindModels(); }
  }));

  // Modelle
  VMODELS = await (window.Andio?.models?.('video',{ nsfw: $('#nsfwToggle').checked }) || mockVideoModels($('#nsfwToggle').checked));
  bindModels();

  // Events
  $('#nsfwToggle').addEventListener('change', async ()=>{
    $('#nsfwBlock').style.display = $('#nsfwToggle').checked ? 'block' : 'none';
    VMODELS = await (window.Andio?.models?.('video',{ nsfw: $('#nsfwToggle').checked }) || mockVideoModels($('#nsfwToggle').checked));
    bindModels();
  });
  $('#genre').addEventListener('change', bindModels);
  $$('.btn.mode').forEach(b=> b.addEventListener('click', ()=> setMode(b.dataset.mode)));
  $('#format').addEventListener('change', ()=> setRes($('#format').value));
  $('#btnRandom').addEventListener('click', randomAll);
  $('#render').addEventListener('click', doRender);
  $('#save').addEventListener('click', doSave);
  $('#reset').addEventListener('click', doReset);
}

function bindModels(){
  const genreId = $('#genre').value;
  const smart = smartPickModel(VMODELS, genreId);
  setSel($('#model'), VMODELS);
  $('#model').disabled = $('#smartModel').checked;
  $('#model').value = $('#smartModel').checked && smart ? smart.id : (VMODELS[0]?.id||'');
  $('#modelHint').textContent = (VMODELS.find(m=>m.id===$('#model').value)||{}).hint || '';
}

function randomAll(){
  const genreId = $('#genre').value;
  if(!genreId){ toast('Bitte zuerst ein Genre wÃ¤hlen.'); return; }
  const nsfw = $('#nsfwToggle').checked;

  // Ausgabe
  const fmtPool = nsfw ? ['9:16','16:9','1:1','2.39:1'] : ['16:9','2.39:1','1:1','9:16'];
  setRes(pick(fmtPool));
  $('#length').value  = Math.floor(6 + Math.random()*6); // 6â€“11s
  $('#fps').value     = pick([24,25,30]);

  // Look
  $('#camera').value      = pick(V.cameras).id||pick(V.cameras);
  $('#motionStyle').value = pick(V.motions).id||pick(V.motions);
  $('#grade').value       = pick(V.grades).id||pick(V.grades);

  // Prompt & Negative
  $('#promptBox').value = randomVideoPrompt(V, { genreId, nsfw });
  $('#negative').value  = (V.negatives?.[nsfw?'nsfw':'sfw']) || 'Artefakte, Ruckler, Ghosting, Kompressionsfehler';

  // Smart Modell
  bindModels();
}

async function doRender(){
  const prompt = $('#promptBox').value.trim();
  if(!prompt){ toast('Bitte Prompt eingeben oder â€žðŸŽ² Zufallâ€œ nutzen.'); return; }
  if($('#nsfwToggle').checked && !$('#adultConsent').checked){
    toast('FÃ¼r NSFW bitte â€žÃœ18 & Einwilligungâ€œ bestÃ¤tigen.'); return;
  }

  const payload = {
    mode,
    prompt,
    negative: $('#negative').value,
    format: $('#format').value, res: $('#res').value,
    length: +$('#length').value, fps: +$('#fps').value,
    model: $('#model').value, smartModel: $('#smartModel').checked,
    look: { genre: $('#genre').value, camera: $('#camera').value, motion: $('#motionStyle').value, grade: $('#grade').value },
    nsfw: $('#nsfwToggle').checked
  };

  pm.set(8);

  try{
    // API bevorzugt
    let url;
    if(Andio?.api?.videoGenerate){
      Andio.Status?.start?.('Video Render', {estMs: 3000 + payload.length*120});
      if(mode==='ti2v' && SRC_IMG_URL){
        payload.sourceImage = SRC_IMG_URL; // optionaler Key fÃ¼r Backends
      }
      url = await Andio.api.videoGenerate(payload); // sollte Video-URL zurÃ¼ckgeben
    }else{
      url = await fallbackThumb(payload); // Canvas-Thumb als Platzhalter
    }

    pm.set(85);
    showResult(url);
    pm.set(100);
    Andio.Status?.done?.('Fertig');
    setTimeout(()=>pm.set(0), 600);
  }catch(err){
    pm.set(0);
    Andio.Status?.error?.('Fehler beim Rendern');
    toast('Fehler: ' + (err?.message||'unbekannt'));
  }
}

function showResult(url){
  const wrap = $('#resultWrap'); wrap.innerHTML='';
  // Wenn es wie eine Videodatei aussieht â†’ Video-Element, sonst Bild
  if(/\.(mp4|webm|mov)(\?|$)/i.test(url)){
    const v=document.createElement('video'); v.controls=true; v.src=url; v.autoplay=true; wrap.appendChild(v);
  }else{
    const img=new Image(); img.src=url; wrap.appendChild(img);
  }
}

function doSave(){
  const vid = $('#resultWrap video');
  const img = $('#resultWrap img');
  if(vid && vid.src){ const a=document.createElement('a'); a.href=vid.src; a.download='video.mp4'; a.click(); return; }
  if(img && img.src){ const a=document.createElement('a'); a.href=img.src; a.download='video_thumb.png'; a.click(); return; }
  toast('Nichts zu speichern.');
}

function doReset(){
  $('#nsfwToggle').checked=false; $('#nsfwBlock').style.display='none';
  setMode('t2v');
  setRes('16:9'); $('#length').value=8; $('#fps').value=24;
  $('#promptBox').value=''; $('#negative').value='';
  $('#smartModel').checked=true; $('#model').disabled=true; bindModels(); wipeOut();
  SRC_IMG_URL && URL.revokeObjectURL(SRC_IMG_URL); SRC_IMG_URL=null; wipeSrc();
}

/* ===== Fallback (ohne Backend): Thumb auf Canvas ===== */
async function fallbackThumb(payload){
  for(const p of [18,32,47,63,78]){ await new Promise(r=>setTimeout(r,160)); pm.set(p); }
  const c=document.createElement('canvas'); c.width=640; c.height=360; const ctx=c.getContext('2d');
  ctx.fillStyle='#0b1220'; ctx.fillRect(0,0,640,360);
  // Quelle (leicht transparent) bei ti2v
  if(payload.mode==='ti2v' && SRC_IMG_URL){
    const img = await loadImage(SRC_IMG_URL);
    const s = Math.min(640/img.width, 360/img.height);
    const w = img.width*s, h = img.height*s;
    ctx.globalAlpha=0.22; ctx.drawImage(img,(640-w)/2,(360-h)/2,w,h); ctx.globalAlpha=1;
  }
  ctx.fillStyle='rgba(255,255,255,.92)'; ctx.font='bold 18px ui-monospace,monospace';
  ctx.fillText(`VIDEO Â· ${payload.mode.toUpperCase()} Â· ${payload.format} ${payload.res}`, 16, 28);
  ctx.font='14px ui-monospace,monospace';
  ctx.fillText(`len=${payload.length}s fps=${payload.fps} model=${payload.model}${payload.smartModel?' (smart)':''}`, 16, 52);
  ctx.fillText((payload.prompt||'').slice(0,60)+'â€¦', 16, 76);
  return c.toDataURL('image/png');
}

function loadImage(url){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=url; }); }

/* ===== Presets/Modelle (Mocks, werden von app.js Ã¼berschrieben) ===== */
function featuredChips(all,{nsfw=false,n=16}={}){ const pool=all.filter(x=> nsfw ? true : !/nsfw|nude|adult/i.test(x)); return shuffle(pool).slice(0,n); }
function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]); }
function smartPickModel(list, genreId){ const exact=list.find(m=>(m.genres||[]).includes(genreId)); return exact || list.find(m=>m.tier==='base') || list[0]; }

async function mockVideoPresets(){
  return {
    genres:[{id:'cin',name:'Cinematic'},{id:'product',name:'Produkt'},{id:'anime',name:'Anime'},{id:'travel',name:'Reise'}],
    cameras:[{id:'dolly',name:'Dolly/Slide'},{id:'handheld',name:'Handheld'},{id:'drone',name:'Drone'},{id:'lockoff',name:'Lock-Off'}],
    motions:[{id:'slowpan',name:'Langsamer Pan'},{id:'parallax',name:'Parallax'},{id:'zoom',name:'Cinematic Zoom'},{id:'walk',name:'Walk-by'}],
    grades:[{id:'neutral',name:'Neutral'},{id:'teal',name:'Teal/Orange'},{id:'bw',name:'S/W'},{id:'warm',name:'Warm'}],
    featured:['Cinematic','Produkt','Anime','Reise','Drone','Parallax','Zoom','Warm','S/W'],
    negatives:{sfw:'Artefakte, Ruckler, Ghosting, Kompressionsfehler', nsfw:'low quality, artifacts, jitter'}
  };
}
async function mockVideoModels(nsfw){
  return [
    {id:'vid-base', name:'VideoGen Base', tier:'base', hint:'Allrounder Â· kurze Clips', genres:['cin','product','travel']},
    {id:'vid-refine', name:'VideoGen Refiner', tier:'refine', hint:'SchÃ¤rft Details, reduziert Ruckler', genres:['cin','product']},
    ...(nsfw ? [{id:'vid-nsfw', name:'Video NSFW+', tier:'addon', hint:'FreizÃ¼gigere Stile', genres:['anime','cin']}] : [])
  ];
}

/* ===== Start ===== */
bootVideo().then(()=>Andio?.polish&&Andio.polish?.());
</script>
</body>
</html>
