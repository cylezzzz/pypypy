<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Video Studio – AndioMediaStudio</title>
  <link rel="icon" type="image/png" href="assets/logo/logo.png"/>
<link rel="stylesheet" href="assets/styles.css"/>
<script src="assets/app.js"></script>
  <style>
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
    .overlay.show{display:flex}
    .modal{background:#111;color:#fff;max-width:90vw;max-height:90vh;width:960px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5);display:flex;flex-direction:column}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #222}
    .modal .body{padding:12px 16px;overflow:auto}
    .modal .body video{max-width:100%;max-height:70vh;border-radius:8px}
    .modal footer{padding:10px 16px;border-top:1px solid #222;display:flex;gap:8px;justify-content:flex-end}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .row > label{min-width:110px;color:#888}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .thumb{cursor:pointer}
    .note{color:#888;font-size:.9em}
    .sep{height:1px;background:#222;margin:12px 0}
  </style>
</head>
<body>
  <script src="/assets/app.js"></script>
  <script>window.Andio && Andio.navbar && Andio.navbar('video-gen');</script>

  <div class="container">
    <h1>Video Studio</h1>
    <p class="note">Text→Video & Bild→Video. Der Player öffnet nur für generierte Clips.</p>

    <div class="grid">
      <div class="card">
        <h3>Generierung</h3>

        <div class="row">
          <label for="v-mode">Modus</label>
          <select id="v-mode">
            <option value="txt2vid">Text → Video</option>
            <option value="img2vid">Bild → Video</option>
          </select>
        </div>

        <div class="row">
          <label for="v-model">Modell</label>
          <select id="v-model"></select>
        </div>

        <div class="row">
          <label for="v-prompt">Prompt</label>
          <textarea id="v-prompt" rows="4" placeholder="Beschreibe die Szene, Bewegung, Stil..."></textarea>
        </div>

        <div class="row">
          <label for="v-dur">Dauer (s)</label>
          <input id="v-dur" type="number" min="1" max="12" value="4" style="max-width:120px"/>
          <label for="v-fps">FPS</label>
          <input id="v-fps" type="number" min="6" max="30" value="12" style="max-width:120px"/>
        </div>

        <div class="sep"></div>

        <div class="row">
          <label for="v-ref">Referenzbild</label>
          <input id="v-ref" type="file" accept="image/*"/>
        </div>

        <div class="row">
          <button id="v-generate">Generieren</button>
          <button id="v-clear" class="secondary">Zurücksetzen</button>
        </div>
      </div>

      <div class="card">
        <h3>Vorschau & Historie</h3>
        <div id="v-preview" class="cards"></div>
      </div>
    </div>
  </div>

  <!-- Overlay Player -->
  <div id="v-overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Player">
      <header>
        <strong id="v-ov-title">Player</strong>
        <button id="v-ov-close" aria-label="Schließen">✕</button>
      </header>
      <div class="body">
        <video id="v-ov-vid" controls style="display:block"></video>
      </div>
      <footer>
        <a id="v-ov-download" class="secondary" download>Download</a>
        <button id="v-ov-close2">Schließen</button>
      </footer>
    </div>
  </div>

  <footer>© AndioMediaStudio</footer>

  <script>
    async function safeAsset(url, fallbackDataUri) {
      if (window.Andio && typeof Andio.safeAsset === 'function') return Andio.safeAsset(url, fallbackDataUri);
      try { const r = await fetch(url,{method:'HEAD'}); if(r.ok) return url; } catch(e){}
      return fallbackDataUri;
    }

    const overlay = (() => {
      const el = document.getElementById('v-overlay');
      const vid = document.getElementById('v-ov-vid');
      const title = document.getElementById('v-ov-title');
      const dl = document.getElementById('v-ov-download');
      const close = ()=>{ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); vid.pause(); };
      document.getElementById('v-ov-close').onclick = close;
      document.getElementById('v-ov-close2').onclick = close;
      el.addEventListener('click', (e)=>{ if(e.target===el) close(); });
      return {
        open: (item) => {
          if (!item || !item.generated) return;
          title.textContent = item.name || 'Player';
          dl.href = item.url; dl.download = item.name || 'output.mp4';
          vid.src = item.url;
          el.classList.add('show'); el.setAttribute('aria-hidden','false');
        }
      };
    })();

    const els = {
      model: document.getElementById('v-model'),
      mode: document.getElementById('v-mode'),
      prompt: document.getElementById('v-prompt'),
      dur: document.getElementById('v-dur'),
      fps: document.getElementById('v-fps'),
      ref: document.getElementById('v-ref'),
      preview: document.getElementById('v-preview'),
      gen: document.getElementById('v-generate'),
      clear: document.getElementById('v-clear'),
    };

    async function loadModels(){
      const opt=(id,l)=>`<option value="${id}">${l}</option>`;
      try{
        const r=await fetch('/api/catalog');
        if(r.ok){
          const d=await r.json();
          const items=(d.installed||d.featured||[]).map(m=>opt(m.id||m.name,'Video: '+(m.name||m.id)));
          els.model.innerHTML = items.join('') || opt('svd-img2vid','Stable Video Diffusion');
          return;
        }
      }catch(e){}
      els.model.innerHTML = opt('svd-img2vid','Stable Video Diffusion');
    }

    function addPreview(obj){
      const card=document.createElement('div');
      card.className='card thumb';
      card.innerHTML=`
        <div class="note">${obj.name||'Output'}</div>
        <video muted loop playsinline></video>
        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button class="secondary btn-open" ${obj.generated?'':'disabled title="Nur für generierte Inhalte"'}>Im Player öffnen</button>
        </div>`;
      card.querySelector('video').src=obj.url;
      card.querySelector('.btn-open').addEventListener('click', ()=>overlay.open(obj));
      els.preview.prepend(card);
    }

    async function onGenerate(){
      if (els.ref.files[0]) {
        // Zeige Referenz als Nicht-generiert
        const url=URL.createObjectURL(els.ref.files[0]);
        const imgCard=document.createElement('div');
        imgCard.className='card';
        imgCard.innerHTML=`<div class="note">Referenzbild</div><img style="max-width:100%"/>`;
        imgCard.querySelector('img').src=url;
        els.preview.prepend(imgCard);
      }
      // Generierter Clip (Platzhalter-URL → später API-Rückgabe einsetzen)
      const genUrl = await safeAsset('/outputs/last_generated.mp4','/assets/placeholders/demo.mp4');
      const ts=new Date().toISOString().replaceAll(':','').slice(0,15);
      addPreview({name:`video_${ts}.mp4`, url:genUrl, type:'video', generated:true});
    }

    els.gen.addEventListener('click', onGenerate);
    els.clear.addEventListener('click', ()=>{ els.prompt.value=''; els.ref.value=''; });

    loadModels().finally(()=>{ window.Andio && Andio.polish && Andio.polish(); });
  </script>
</body>
</html>
