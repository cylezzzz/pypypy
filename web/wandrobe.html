<!DOCTYPE html>
<html lang="de" data-mode="sfw">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AndioMediaStudio – Wandrobe</title>

  <!-- Einheitliche Topbar (global) -->
  <link rel="stylesheet" href="assets/ui.css">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --panel:rgba(255,255,255,.95); --border:rgba(255,255,255,.2);
      --ink:#333; --muted:#666; --hint:#999;
      --brand1:#667eea; --brand2:#764ba2;
    }
    body{
      font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
      min-height:100vh; color:var(--ink);
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
    }
    .container{max-width:1800px;margin:0 auto;padding:20px}
    .card{
      background:var(--panel); border:1px solid var(--border);
      border-radius:20px; box-shadow:0 8px 32px rgba(0,0,0,.1);
      backdrop-filter:blur(10px);
    }
    .header{padding:24px 28px;margin-bottom:18px}
    .header h1{
      font-size:2.1rem;margin:0 0 6px;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .nav{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    .tab{
      background:rgba(255,255,255,.9); color:var(--ink);
      padding:10px 18px;border-radius:999px;text-decoration:none;font-weight:600;
      border:1px solid rgba(0,0,0,.06); transition:.2s ease;
    }
    .tab:hover,.tab.active{color:#fff; background:linear-gradient(135deg,var(--bg1),var(--bg2)); transform:translateY(-1px)}
    /* global mode toggle */
    .modebar{display:flex;justify-content:flex-end;margin:6px 0 18px}
    .modechip{
      display:flex;align-items:center;gap:10px;background:#fff;
      border:1px solid rgba(0,0,0,.08); padding:8px 12px;border-radius:999px;font-weight:700;
    }
    .workspace{display:grid;grid-template-columns:300px 1fr 360px; gap:22px; align-items:start}
    /* Left – slots */
    .slots{padding:18px}
    .slots h3{font-size:1.05rem;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .pillgrp{display:flex;gap:8px;margin-bottom:10px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.08); background:#fff;font-weight:600;cursor:pointer}
    .pill.active{background:rgba(102,126,234,.12);border-color:rgba(102,126,234,.35);color:#3949ab}
    .cat{border:1px solid #e6e6e6;border-radius:12px;overflow:hidden;margin-bottom:12px}
    .cat-h{background:rgba(102,126,234,.1);padding:10px 12px;font-weight:700;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .cat-b{padding:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .item{background:rgba(102,126,234,.06);border:1px solid rgba(102,126,234,.25);border-radius:10px;padding:10px;text-align:center;cursor:pointer;transition:.15s}
    .item:hover{transform:translateY(-1px);background:rgba(102,126,234,.16)}
    .item i{color:var(--brand1);margin-bottom:6px}
    .item .name{font-size:.8rem;font-weight:600}
    /* Middle – canvas */
    .canvas{padding:18px}
    .drop{border:2px dashed #ddd; border-radius:16px; padding:24px; text-align:center; cursor:pointer; transition:.2s;margin-bottom:14px}
    .drop:hover,.drop.dragover{border-color:var(--brand1); background:rgba(102,126,234,.06)}
    .drop i{font-size:1.8rem;color:#ccc;margin-bottom:6px}
    .stage{
      background:
       linear-gradient(45deg,#f8f9fa 25%,transparent 25%),
       linear-gradient(-45deg,#f8f9fa 25%,transparent 25%),
       linear-gradient(45deg,transparent 75%,#f8f9fa 75%),
       linear-gradient(-45deg,transparent 75%,#f8f9fa 75%);
      background-size:20px 20px;background-position:0 0,0 10px,10px -10px,-10px 0;
      border-radius:16px; min-height:520px; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center;
    }
    .model{max-width:100%;max-height:100%;object-fit:contain;border-radius:10px}
    .overlay-layer{position:absolute;inset:0;pointer-events:none}
    .canvas-hint{color:#666;text-align:center}
    .btnrow{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .btn{
      padding:12px 16px;border:none;border-radius:12px;font-weight:700;cursor:pointer;transition:.15s;display:flex;align-items:center;gap:8px
    }
    .btn.primary{color:#fff;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    .btn.ghost{background:rgba(102,126,234,.08);color:var(--brand1);border:1px solid rgba(102,126,234,.3)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(102,126,234,.25)}
    /* Right – tools */
    .tools{padding:18px;max-height:calc(100vh - 200px);overflow:auto}
    .section{background:rgba(102,126,234,.06);border-radius:14px;padding:16px;margin-bottom:14px}
    .title{font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .opt{display:flex;align-items:center;gap:8px;margin:6px 0}
    .opt input[type=checkbox]{accent-color:var(--brand2)}
    .rg{position:relative;margin:10px 0}
    input[type=range]{width:100%;height:6px;border-radius:3px;background:#e0e0e0;outline:none;-webkit-appearance:none}
    input[type=range]::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;background:linear-gradient(135deg,var(--bg1),var(--bg2));box-shadow:0 2px 5px rgba(0,0,0,.25)}
    .val{position:absolute;right:0;top:-20px;background:rgba(102,126,234,.1);padding:2px 8px;border-radius:10px;font-size:.8rem;font-weight:700;color:#3949ab}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .toolbtn{padding:10px;border:1px solid rgba(102,126,234,.25);border-radius:10px;background:#fff;cursor:pointer;text-align:center;font-size:.9rem}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:#fff;font-weight:600}
    /* NSFW visibility */
    .nsfw-only{display:none}
    [data-mode="nsfw"] .nsfw-only{display:block}
    [data-mode="nsfw"] .nsfw-hide{display:none !important}
    @media (max-width:1400px){
      .workspace{grid-template-columns:1fr;gap:18px}
      .tools{max-height:none}
    }
  </style>
</head>
<body data-page="wardrobe" data-mode="sfw">
  <!-- Globale Navbar per Include -->
  <div data-include="navbar"></div>

  <div class="container">
    <div class="header card">
      <h1><i class="fas fa-tshirt"></i> Wandrobe</h1>
      <p style="color:var(--muted)">Virtual Try-On · Style-Transfer · Seam-Aware Compositing</p>
    </div>

    <div class="nav">
      <a class="tab" href="index.html"><i class="fas fa-gauge"></i> Dashboard</a>
      <a class="tab" href="create.html"><i class="fas fa-image"></i> Bildgenerierung</a>
      <a class="tab" href="video.html"><i class="fas fa-video"></i> Video</a>
      <a class="tab active" href="#"><i class="fas fa-tshirt"></i> Wandrobe</a>
      <a class="tab" href="editor.html"><i class="fas fa-edit"></i> Editor</a>
      <a class="tab" href="motion.html"><i class="fas fa-person-running"></i> Motion</a>
    </div>

    <!-- SFW / NSFW global -->
    <div class="modebar">
      <label class="modechip">
        <span id="modeLabel">SFW</span>
        <input id="modeToggle" type="checkbox" style="accent-color:#764ba2"/>
        <span>NSFW</span>
      </label>
    </div>

    <div class="workspace">
      <!-- LEFT: Slots & Library -->
      <aside class="card slots">
        <h3><i class="fas fa-sliders"></i> Slots</h3>
        <div class="pillgrp">
          <button class="pill active" data-slot="top">Top</button>
          <button class="pill" data-slot="bottom">Bottom</button>
          <button class="pill" data-slot="shoes">Schuhe</button>
          <button class="pill" data-slot="acc">Accessoire</button>
        </div>

        <h3 style="margin-top:10px"><i class="fas fa-wardrobe"></i> Outfit-Bibliothek</h3>

        <div class="cat">
          <div class="cat-h" onclick="toggleCat('tops')">Oberteile <i class="fas fa-chevron-down"></i></div>
          <div class="cat-b" id="tops">
            <div class="item" onclick="selectOutfit('tshirt')"><i class="fas fa-shirt"></i><div class="name">T-Shirt</div></div>
            <div class="item" onclick="selectOutfit('hoodie')"><i class="fas fa-hoodie"></i><div class="name">Hoodie</div></div>
            <div class="item" onclick="selectOutfit('blouse')"><i class="fas fa-user-tie"></i><div class="name">Bluse</div></div>
            <div class="item" onclick="selectOutfit('jacket')"><i class="fas fa-vest"></i><div class="name">Jacke</div></div>
          </div>
        </div>

        <div class="cat">
          <div class="cat-h" onclick="toggleCat('bottoms')">Unterteile <i class="fas fa-chevron-down"></i></div>
          <div class="cat-b" id="bottoms" style="display:none">
            <div class="item" onclick="selectOutfit('jeans')"><i class="fas fa-person"></i><div class="name">Jeans</div></div>
            <div class="item" onclick="selectOutfit('skirt')"><i class="fas fa-person-dress"></i><div class="name">Rock</div></div>
            <div class="item" onclick="selectOutfit('shorts')"><i class="fas fa-person-walking"></i><div class="name">Shorts</div></div>
            <div class="item" onclick="selectOutfit('suitpants')"><i class="fas fa-briefcase"></i><div class="name">Anzughose</div></div>
          </div>
        </div>

        <div class="cat">
          <div class="cat-h" onclick="toggleCat('shoes')">Schuhe <i class="fas fa-chevron-down"></i></div>
          <div class="cat-b" id="shoes" style="display:none">
            <div class="item" onclick="selectOutfit('sneaker')"><i class="fas fa-shoe-prints"></i><div class="name">Sneaker</div></div>
            <div class="item" onclick="selectOutfit('heels')"><i class="fas fa-person-dress"></i><div class="name">High Heels</div></div>
            <div class="item" onclick="selectOutfit('boots')"><i class="fas fa-boot"></i><div class="name">Stiefel</div></div>
            <div class="item" onclick="selectOutfit('dressshoes')"><i class="fas fa-shoe-prints"></i><div class="name">Anzugschuhe</div></div>
          </div>
        </div>

        <div class="cat">
          <div class="cat-h" onclick="toggleCat('acc')">Accessoires <i class="fas fa-chevron-down"></i></div>
          <div class="cat-b" id="acc" style="display:none">
            <div class="item" onclick="selectOutfit('hat')"><i class="fas fa-hat-cowboy"></i><div class="name">Hut</div></div>
            <div class="item" onclick="selectOutfit('glasses')"><i class="fas fa-glasses"></i><div class="name">Brille</div></div>
            <div class="item" onclick="selectOutfit('watch')"><i class="fas fa-clock"></i><div class="name">Uhr</div></div>
            <div class="item" onclick="selectOutfit('necklace')"><i class="fas fa-gem"></i><div class="name">Kette</div></div>
          </div>
        </div>

        <!-- NSFW categories -->
        <div class="cat nsfw-only">
          <div class="cat-h" onclick="toggleCat('lingerie')">Lingerie <i class="fas fa-chevron-down"></i></div>
          <div class="cat-b" id="lingerie" style="display:none">
            <div class="item" onclick="selectOutfit('bra')"><i class="fas fa-heart"></i><div class="name">Bra</div></div>
            <div class="item" onclick="selectOutfit('panties')"><i class="fas fa-heart"></i><div class="name">Panties</div></div>
            <div class="item" onclick="selectOutfit('bodysuit')"><i class="fas fa-heart"></i><div class="name">Bodysuit</div></div>
            <div class="item" onclick="selectOutfit('stockings')"><i class="fas fa-socks"></i><div class="name">Stockings</div></div>
          </div>
        </div>

        <div class="cat nsfw-only">
          <div class="cat-h" onclick="toggleCat('underlay')">Naked Underlay <i class="fas fa-chevron-down"></i></div>
          <div class="cat-b" id="underlay" style="display:none">
            <div class="item" onclick="selectOutfit('naked-soft')"><i class="fas fa-circle"></i><div class="name">Soft</div></div>
            <div class="item" onclick="selectOutfit('naked-detailed')"><i class="fas fa-circle"></i><div class="name">Detailed</div></div>
            <div class="item" onclick="selectOutfit('naked-art')"><i class="fas fa-paintbrush"></i><div class="name">Artistic</div></div>
            <div class="item" onclick="selectOutfit('naked-tan')"><i class="fas fa-sun"></i><div class="name">Body Tan</div></div>
          </div>
        </div>
      </aside>

      <!-- MIDDLE: Canvas -->
      <main class="card canvas">
        <div class="drop" onclick="document.getElementById('modelInput').click()"
             ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event)">
          <i class="fas fa-user-plus"></i>
          <h3>Personen-Foto hochladen</h3>
          <p class="canvas-hint">PNG/JPG – Für Try-On mit Slot-Outfits</p>
          <input id="modelInput" type="file" accept="image/*" style="display:none" onchange="loadModel(event)"/>
        </div>

        <div class="stage" id="stage">
          <div class="canvas-hint" id="canvasHint">
            <i class="fas fa-user-circle" style="font-size:3rem;color:#ccc"></i>
            <p style="margin-top:8px;color:#666">Lege ein Foto ab – dann: Slot wählen → Item klicken → Tools rechts einstellen.</p>
            <p class="nsfw-only" style="margin-top:6px;color:#666;font-size:.9rem">Tipp: <em>Coverage</em> & <em>Seam-Blend</em> für saubere Übergänge bei Lingerie/Underlay.</p>
          </div>
          <!-- Layers werden per JS eingesetzt -->
        </div>

        <div class="btnrow">
          <button class="btn ghost" onclick="previewTryOn()"><i class="fas fa-eye"></i> Vorschau</button>
          <button class="btn primary" onclick="applyTryOn()"><i class="fas fa-wand-magic-sparkles"></i> Anwenden</button>
        </div>
      </main>

      <!-- RIGHT: Tools -->
      <aside class="card tools">
        <div class="section">
          <div class="title"><i class="fas fa-wand-magic-sparkles"></i> Qualitäts-Optionen</div>
          <label class="opt"><input type="checkbox" id="seam" checked/>Naht-Übergänge</label>
          <label class="opt"><input type="checkbox" id="edge" checked/>Kanten/Haare-Refine</label>
          <label class="opt"><input type="checkbox" id="shadow" checked/>Kontakt-Schatten</label>
          <label class="opt"><input type="checkbox" id="halo" checked/>Artefakt-Schutz</label>
          <label class="opt"><input type="checkbox" id="superres"/>Detail-Boost</label>
        </div>

        <div class="section">
          <div class="title"><i class="fas fa-ruler-combined"></i> Passform</div>
          <div class="rg">
            <label class="chip">Größe</label>
            <input id="scale" type="range" min="50" max="200" value="100" oninput="bindVal(this,'scaleVal');setScale(this.value)"/>
            <span class="val" id="scaleVal">100%</span>
          </div>
          <div class="rg">
            <label class="chip">Rotation</label>
            <input id="rot" type="range" min="-30" max="30" value="0" oninput="bindVal(this,'rotVal');setRotation(this.value)"/>
            <span class="val" id="rotVal">0°</span>
          </div>
          <div class="rg">
            <label class="chip">Deckkraft</label>
            <input id="alpha" type="range" min="0" max="100" value="100" oninput="bindVal(this,'alphaVal');setAlpha(this.value)"/>
            <span class="val" id="alphaVal">100%</span>
          </div>
          <div style="display:flex;gap:10px;margin-top:8px">
            <button class="toolbtn" onclick="pinMode(true)"><i class="fas fa-thumbtack"></i><br/>Pin-&-Drape</button>
            <button class="toolbtn" onclick="clearPins()"><i class="fas fa-eraser"></i><br/>Pins löschen</button>
            <button class="toolbtn" onclick="autoPins()"><i class="fas fa-wand-magic-sparkles"></i><br/>Auto-Pins</button>
          </div>
        </div>

        <div class="section">
          <div class="title"><i class="fas fa-palette"></i> Farbe & Muster</div>
          <label class="opt"><input type="checkbox" id="colormatch" checked/>Farb-Matching (Hautton/Umgebung)</label>
          <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px" id="swatches"></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <select id="fabric" class="chip" onchange="setFabric(this.value)">
              <option value="auto">Stoff: Auto</option>
              <option value="denim">Denim</option><option value="cotton">Cotton</option>
              <option value="silk">Silk</option><option value="leather">Leather</option>
            </select>
            <select id="refl" class="chip" onchange="setReflection(this.value)">
              <option value="norm">Reflections: Norm</option>
              <option value="low">Low</option><option value="high">High</option>
              <option value="matte">Matte</option>
            </select>
          </div>
        </div>

        <!-- Skin / Flecken / Tan / Sheen -->
        <div class="section">
          <div class="title"><i class="fas fa-droplet"></i> Hautton & „Flecken“</div>
          <div class="rg">
            <label class="chip">Hautton-Blend (Übergang)</label>
            <input id="skinBlend" type="range" min="0" max="100" value="35" oninput="bindVal(this,'skinBlendVal');setSkinBlend(this.value)"/>
            <span class="val" id="skinBlendVal">35%</span>
          </div>
          <div class="rg">
            <label class="chip">Freckles (Sommer-Sprossen)</label>
            <input id="freckles" type="range" min="0" max="100" value="20" oninput="bindVal(this,'frecklesVal');setFreckles(this.value)"/>
            <span class="val" id="frecklesVal">20%</span>
          </div>
          <div class="rg">
            <label class="chip">Tan-Lines (Bikini-Abzeichnung)</label>
            <input id="tan" type="range" min="0" max="100" value="15" oninput="bindVal(this,'tanVal');setTan(this.value)"/>
            <span class="val" id="tanVal">15%</span>
          </div>
          <div class="rg">
            <label class="chip">Skin-Sheen (Glanz)</label>
            <input id="sheen" type="range" min="0" max="100" value="10" oninput="bindVal(this,'sheenVal');setSheen(this.value)"/>
            <span class="val" id="sheenVal">10%</span>
          </div>
          <div class="rg">
            <label class="chip">Blemish-Reduce</label>
            <input id="blemish" type="range" min="0" max="100" value="30" oninput="bindVal(this,'blemishVal');setBlemish(this.value)"/>
            <span class="val" id="blemishVal">30%</span>
          </div>
        </div>

        <!-- NSFW tools -->
        <div class="section nsfw-only">
          <div class="title"><i class="fas fa-user-shield"></i> NSFW Tools</div>
          <div class="rg">
            <label class="chip">Bedeckung (Coverage)</label>
            <input id="coverage" type="range" min="0" max="100" value="70" oninput="bindVal(this,'coverageVal');setCoverage(this.value)"/>
            <span class="val" id="coverageVal">70%</span>
          </div>
          <label class="chip" style="display:block;margin:6px 0 8px">Body-Physics-Profil</label>
          <select id="physics" class="chip" onchange="setPhysics(this.value)">
            <option value="soft">Soft</option><option value="firm">Firm</option><option value="athletic">Athletic</option>
          </select>
          <div class="grid3" style="margin-top:10px">
            <button class="toolbtn" onclick="toggleGarment('top')"><i class="fas fa-eye-slash"></i> Top an/aus</button>
            <button class="toolbtn" onclick="toggleGarment('bottom')"><i class="fas fa-eye-slash"></i> Bottom an/aus</button>
            <button class="toolbtn" onclick="toggleCensor()"><i class="fas fa-ban"></i> Censor</button>
          </div>
        </div>

        <!-- Actions -->
        <div class="section">
          <div class="title"><i class="fas fa-download"></i> Aktionen</div>
          <div class="grid3">
            <button class="toolbtn" onclick="saveOutfit()"><i class="fas fa-save"></i> Speichern</button>
            <button class="toolbtn" onclick="exportOutfit()"><i class="fas fa-file-export"></i> Export</button>
            <button class="toolbtn" onclick="resetAll()"><i class="fas fa-rotate-left"></i> Reset</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Navbar-Loader (muss nach <div data-include="navbar"> kommen) -->
  <script src="assets/include.js"></script>
  <!-- Globaler Overlay-Player für Bilder/Videos -->
  <script src="assets/overlay-player.js"></script>

  <script>
    /* ---------- Mode (SFW/NSFW) ---------- */
    let nsfwMode = localStorage.getItem('andio_mode') || 'sfw';
    let outputBase = nsfwMode === 'nsfw' ? '/outputs/nsfw' : '/outputs/sfw';
    const el = (id)=>document.getElementById(id);

    function applyModeUI(){
      document.documentElement.setAttribute('data-mode', nsfwMode);
      const t=el('modeToggle'); const l=el('modeLabel');
      if(t){ t.checked = (nsfwMode==='nsfw'); }
      if(l){ l.textContent = nsfwMode.toUpperCase(); }
      outputBase = nsfwMode==='nsfw'?'/outputs/nsfw':'/outputs/sfw';
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // swatches
      const cols=['#000','#fff','#F44336','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#03A9F4','#00BCD4','#009688','#4CAF50','#8BC34A','#CDDC39','#FFC107','#FF9800','#795548','#9E9E9E'];
      const box=el('swatches'); if(box){ cols.forEach(c=>{
        const d=document.createElement('div');
        d.style.width='26px';d.style.height='26px';d.style.borderRadius='50%';d.style.border='2px solid rgba(0,0,0,.1)';
        d.style.background=c;d.style.cursor='pointer';
        d.title=c; d.onclick=()=>setColor(c); box.appendChild(d);
      }); }
      // mode
      applyModeUI();
      const mt=el('modeToggle');
      if(mt){ mt.addEventListener('change',()=>{ nsfwMode = mt.checked?'nsfw':'sfw'; localStorage.setItem('andio_mode',nsfwMode); applyModeUI(); }); }
    });

    /* ---------- Slots ---------- */
    document.querySelectorAll('.pill').forEach(p=>{
      p.addEventListener('click',()=>{
        document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        activeSlot = p.dataset.slot;
      });
    });
    function toggleCat(id){
      const b=el(id); const icon=b?.previousElementSibling?.querySelector('i:last-child');
      if(!b) return; const show = b.style.display==='none' || !b.style.display;
      b.style.display = show ? 'grid' : 'none';
      if(icon) icon.className = 'fas fa-chevron-'+(show?'up':'down');
    }

    /* ---------- Canvas / Model ---------- */
    let currentModel=null, activeSlot='top', currentItem=null;
    function dragOver(ev){ ev.preventDefault(); ev.currentTarget.classList.add('dragover'); }
    function dragLeave(ev){ ev.currentTarget.classList.remove('dragover'); }
    function dropFile(ev){ ev.preventDefault(); ev.currentTarget.classList.remove('dragover'); loadFile(ev.dataTransfer.files?.[0]); }
    function loadModel(ev){ loadFile(ev.target.files?.[0]); }
    function loadFile(file){
      if(!file || !file.type.startsWith('image/')) return;
      const r=new FileReader();
      r.onload= e=>{
        currentModel = e.target.result;
        const stage=el('stage');
        stage.innerHTML = `<img id="modelImg" class="model" src="\${currentModel}" alt="Model">
                           <canvas id="overlay" class="overlay-layer"></canvas>
                           <canvas id="censor" class="overlay-layer"></canvas>`;
      };
      r.readAsDataURL(file);
    }

    function selectOutfit(type){
      currentItem = type;
      if(el('modelImg')) applyPreviewTint();
    }

    /* ---------- Tools (Bindings) ---------- */
    function bindVal(r, spanId){ const v = r.id==='rot'? \`\${r.value}°\` : \`\${r.value}\${r.id==='alpha'||r.id==='scale'?'%':''}\`; el(spanId).textContent = v; }
    function setScale(v){ const img=el('modelImg'); if(img) img.style.transform = \`scale(\${v/100}) rotate(\${el('rot').value}deg)\`; }
    function setRotation(v){ const img=el('modelImg'); if(img) img.style.transform = \`scale(\${el('scale').value/100}) rotate(\${v}deg)\`; }
    function setAlpha(v){ const img=el('modelImg'); if(img) img.style.opacity = v/100; }
    function setColor(hex){ /* apply to garment layer */ }
    function setFabric(v){} function setReflection(v){}
    function pinMode(on){ /* enable pin interactions */ }
    function clearPins(){} function autoPins(){}

    // Skin / „Flecken“
    function setSkinBlend(v){} function setFreckles(v){} function setTan(v){} function setSheen(v){} function setBlemish(v){}

    // NSFW
    function setCoverage(v){} function setPhysics(v){} function toggleGarment(slot){}
    let censorOn=false;
    function toggleCensor(){
      censorOn=!censorOn;
      const c=el('censor'); if(!c) return; const ctx=c.getContext('2d'); c.width=c.offsetWidth; c.height=c.offsetHeight; ctx.clearRect(0,0,c.width,c.height);
      if(censorOn){ ctx.fillStyle='rgba(0,0,0,.85)'; const h=c.height; const w=c.width; ctx.fillRect(w*.32,h*.42,w*.36,h*.06); ctx.fillRect(w*.35,h*.62,w*.3,h*.06); }
    }

    function applyPreviewTint(){
      const stage=el('stage'); stage.style.boxShadow='inset 0 0 0 9999px rgba(102,126,234,.08)';
      setTimeout(()=>stage.style.boxShadow='none',220);
    }

    // ⬇️ Vorschau nutzt den GLOBALEN OVERLAY-PLAYER
    function previewTryOn(){
      if(!currentModel){ alert('Bitte Foto laden.'); return; }
      if(!currentItem){ alert('Bitte Outfit wählen.'); return; }
      openOverlay({
        kind:'image',
        src: currentModel,
        name: 'Preview · ' + currentItem,
        date: new Date().toISOString(),
        format: 'PNG',
        nsfw: (nsfwMode==='nsfw'),
        gen: 'Wardrobe'
      });
    }

    function applyTryOn(){
      if(!currentModel || !currentItem){ alert('Bitte Foto & Outfit wählen.'); return; }
      alert('Try-On angewendet (Demo).');
    }

    function resetAll(){
      ['scale','rot','alpha','skinBlend','freckles','tan','sheen','blemish','coverage'].forEach(id=>{
        const def={scale:100,rot:0,alpha:100,skinBlend:35,freckles:20,tan:15,sheen:10,blemish:30,coverage:70}[id];
        const ctl = el(id); if(!ctl) return;
        ctl.value=def;
        const lbl={rot:'rotVal',alpha:'alphaVal',scale:'scaleVal',skinBlend:'skinBlendVal',freckles:'frecklesVal',tan:'tanVal',sheen:'sheenVal',blemish:'blemishVal',coverage:'coverageVal'}[id];
        bindVal(ctl, lbl);
      });
      const img=el('modelImg'); if(img){ img.style.transform=''; img.style.opacity='1'; }
    }

    // Speichern/Export – pfadabhängig SFW/NSFW
    function saveOutfit(){
      if(!currentModel){ alert('Kein Bild.'); return; }
      const path = \`\${outputBase}/wardrobe/\${Date.now()}_tryon.png\`;
      alert('Gespeichert nach:\\n' + path);
    }
    function exportOutfit(){
      if(!currentModel){ alert('Kein Bild.'); return; }
      const path = \`\${outputBase}/exports/\${Date.now()}_wardrobe.png\`;
      alert('Export nach:\\n' + path);
    }
  </script>
</body>
</html>
