<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wardrobe – AndioMediaStudio</title>
<link rel="stylesheet" href="assets/styles.css"/>
<style>
  .page-grid{display:grid;grid-template-columns:320px 1fr 380px;gap:12px}
  .card{background:#1112;border:1px solid #333;border-radius:12px;padding:12px}
  .grid{display:grid;gap:8px}
  .grid-2{grid-template-columns:1fr 1fr}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .canvas-wrap{position:relative;aspect-ratio:1/1;background:#000;border-radius:12px;overflow:hidden}
  .canvas-wrap canvas{width:100%;height:100%;display:block}
  .badge{padding:2px 6px;border-radius:8px;background:#222;border:1px solid #444;font-size:12px}
  .prompt-item{border:1px dashed #444;border-radius:10px;padding:8px}
  .list{display:flex;flex-direction:column;gap:8px;max-height:42vh;overflow:auto}
  .hud{font-size:.9em;opacity:.9}
</style>
</head>
<body>
<script src="assets/app.js"></script>
<script>window.Andio?.navbar?.('wardrobe');</script>

<div class="container">
  <h1>Wardrobe</h1>
  <div class="page-grid">
    <aside class="card">
      <h3>Quelle & Optionen</h3>
      <div class="grid">
        <label class="row"><span class="badge">Bild laden</span><input id="file" type="file" accept="image/*"/></label>
        <div class="grid grid-2">
          <label>Inhalt
            <select id="content"><option value="sfw">SFW</option><option value="nsfw">NSFW</option></select>
          </label>
          <label>Stil-Preset
            <select id="preset">
              <option value="realistic">Realistisch</option>
              <option value="fashion">Fashion</option>
              <option value="street">Street</option>
              <option value="glamour">Glamour</option>
              <option value="nude">Nackt (Consent nötig)</option>
            </select>
          </label>
        </div>

        <details id="consent" class="card" style="display:none">
          <summary>NSFW-Bestätigung</summary>
          <label><input type="checkbox" id="age"/> Ich bin 18+.</label>
          <label><input type="checkbox" id="rights"/> Rechte am Bild vorhanden.</label>
          <label><input type="checkbox" id="law"/> Nutzung legal & privat.</label>
        </details>

        <label>Globale Tweaks <input id="tweaks" placeholder="Farben, Stoffe, Accessoires, Licht…"/></label>
        <div class="row">
          <button id="random">Random</button>
          <button id="apply" class="primary">Ausführen</button>
          <span id="hud" class="hud"></span>
        </div>
        <div class="row">
          <span class="badge">Auto-Maske <input id="autoMask" type="checkbox" checked></span>
          <span class="badge">Pose beibehalten <input id="keepPose" type="checkbox" checked></span>
          <span class="badge">Falten/Physik <input id="clothPhys" type="checkbox"></span>
        </div>
      </div>
    </aside>

    <main class="card">
      <div class="row" style="margin-bottom:6px">
        <button data-tool="rect" class="active">Rechteck</button>
        <button data-tool="ellipse">Ellipse</button>
        <button id="clearSel" class="secondary">Auswahlen löschen</button>
      </div>
      <div class="canvas-wrap" id="stage">
        <canvas id="imgCanvas" width="1024" height="1024"></canvas>
      </div>
    </main>

    <aside class="card">
      <h3>Bereiche</h3>
      <div id="areas" class="list"></div>

      <details class="card" style="margin-top:8px">
        <summary>Freier Prompt (optional)</summary>
        <textarea id="free" rows="4" placeholder="Zusätzliche globale Anweisungen…"></textarea>
      </details>

      <div class="card" style="margin-top:8px">
        <h3>Ergebnisse</h3>
        <div id="results" class="list"></div>
      </div>
    </aside>
  </div>
</div>

<footer>© AndioMediaStudio</footer>

<div id="ov" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000">
  <div style="background:#111;max-width:90vw;max-height:90vh;border-radius:12px;padding:12px;border:1px solid #222;display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Player</strong><button id="ov-close">✕</button></div>
    <img id="ov-img" alt="Bild" style="max-width:86vw;max-height:72vh;border-radius:8px"/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><a id="ov-dl" class="secondary" download>Download</a><button id="ov-close2">Schließen</button></div>
  </div>
</div>

<script>
(()=> {
  const $=s=>document.querySelector(s);
  const hud=$('#hud');
  const canvas=$('#imgCanvas'), ctx=canvas.getContext('2d'), stage=$('#stage');
  let img=null, dragging=false, start=null, tool='rect';
  const sels=[]; // {id,type,x,y,w,h,form:{piece,action,what,material,color,style}}

  function draw(){
    ctx.clearRect(0,0,1024,1024);
    if(img) ctx.drawImage(img,0,0,1024,1024);
    ctx.strokeStyle='#2b5fd9'; ctx.setLineDash([6,4]); ctx.lineWidth=2;
    sels.forEach(s=> ctx.strokeRect(s.x,s.y,s.w,s.h));
  }
  function nextId(){ return sels.length? Math.max(...sels.map(s=>s.id))+1 : 1; }
  function addArea(s){
    const host=$('#areas');
    const d=document.createElement('div'); d.className='prompt-item';
    d.innerHTML=`
      <strong>#${s.id}</strong>
      <div class="grid grid-2">
        <label>Teil
          <select data-k="piece">
            <option value="top">Oberteil</option><option value="bottom">Unterteil</option>
            <option value="dress">Kleid</option><option value="underwear">Unterwäsche</option>
            <option value="accessory">Accessoire</option><option value="nude">Nackt</option>
          </select>
        </label>
        <label>Aktion
          <select data-k="action">
            <option value="replace">Ersetzen</option><option value="add">Hinzufügen</option>
            <option value="remove">Entfernen</option><option value="recolor">Umfärben</option>
            <option value="nude">Nackt</option>
          </select>
        </label>
      </div>
      <input data-k="what" placeholder="Was? (z. B. rote Satinbluse)"/>
      <div class="grid grid-2">
        <input data-k="material" placeholder="Material (Satin, Denim, Lace)"/>
        <input data-k="color" placeholder="Farbe (rot, schwarz, creme)"/>
      </div>
      <input data-k="style" placeholder="Stil/Hinweise (Figurbetont, weiche Falten …)"/>
    `;
    s.form = s.form || {piece:'top',action:'replace',what:'',material:'',color:'',style:''};
    ['piece','action','what','material','color','style'].forEach(k=>{
      const el=d.querySelector(`[data-k="${k}"]`); el.value=s.form[k]||''; el.addEventListener('input',()=>s.form[k]=el.value); el.addEventListener('change',()=>s.form[k]=el.value);
    });
    host.appendChild(d);
  }

  $('#content').addEventListener('change', e=> $('#consent').style.display = e.target.value==='nsfw' ? '' : 'none');
  const consentOK = ()=> $('#content').value!=='nsfw' || ($('#age').checked && $('#rights').checked && $('#law').checked);

  $('#file').addEventListener('change', ()=>{
    const f=$('#file').files?.[0]; if(!f) return;
    const im=new Image(); im.onload=()=>{ img=im; draw(); }; im.src=URL.createObjectURL(f);
  });

  stage.addEventListener('mousedown', e=>{
    if(!img) return;
    dragging=true; const r=canvas.getBoundingClientRect(); start={x:e.clientX-r.left,y:e.clientY-r.top};
  });
  stage.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
    draw(); ctx.strokeStyle='#2b5fd9'; ctx.setLineDash([6,4]); ctx.strokeRect(start.x,start.y,x-start.x,y-start.y);
  });
  stage.addEventListener('mouseup', e=>{
    if(!dragging) return; dragging=false;
    const r=canvas.getBoundingClientRect(); const x1=Math.min(start.x,e.clientX-r.left), y1=Math.min(start.y,e.clientY-r.top);
    const w=Math.abs(e.clientX-r.left-start.x), h=Math.abs(e.clientY-r.top-start.y); if(w<6||h<6) return;
    const sel={id:nextId(),type:tool,x:x1,y:y1,w,h}; sels.push(sel); draw(); addArea(sel);
  });
  document.querySelectorAll('button[data-tool]').forEach(b=> b.addEventListener('click',()=>{ document.querySelectorAll('button[data-tool]').forEach(x=>x.classList.remove('active')); b.classList.add('active'); tool=b.dataset.tool; }));
  $('#clearSel').addEventListener('click', ()=>{ sels.splice(0,sels.length); draw(); $('#areas').innerHTML=''; });

  $('#random').addEventListener('click', ()=>{
    const ideas=['Seidenbluse mit Schleife','Lederjacke','Jeans high-waist','Bodycon Kleid','Spitzen-BH', 'Nackt (Studio-Licht)'];
    const r = ideas[Math.floor(Math.random()*ideas.length)];
    $('#free').value = ($('#free').value.trim() ? $('#free').value+'\n' : '') + r;
    if(!sels.length){ const sel={id:nextId(),type:'rect',x:300,y:300,w:400,h:420}; sels.push(sel); addArea(sel); draw(); }
  });

  // API helpers
  const pickUrl = (o)=> o?.url || o?.result?.url || o?.data?.url || null;
  async function postMultipart(endpoint, payload, files){
    const fd=new FormData(); fd.append('payload', new Blob([JSON.stringify(payload)], {type:'application/json'}));
    for(const [name,file] of Object.entries(files||{})){ if(file) fd.append(name,file,file.name||name); }
    const r=await fetch(endpoint,{method:'POST',body:fd}); if(!r.ok) throw new Error(`HTTP ${r.status}`); return await r.json();
  }
  async function pollJob(id,{interval=1000,timeout=10*60*1000}={}){
    const t0=Date.now(); while(true){
      const r=await fetch(`/api/jobs/${id}`); if(!r.ok) throw new Error(`Job ${id}: HTTP ${r.status}`);
      const d=await r.json(); const st=(d.status||d.state||'').toLowerCase();
      if(['succeeded','success','done','finished'].includes(st)) return d;
      if(['failed','error'].includes(st)) throw new Error(d.error||'Job fehlgeschlagen');
      if(Date.now()-t0>timeout) throw new Error('Timeout');
      await new Promise(rs=>setTimeout(rs,interval));
    }
  }
  function setBusy(b,msg){ $('#apply').disabled=b; $('#clearSel').disabled=b; hud.textContent=msg||''; }

  $('#apply').addEventListener('click', async ()=>{
    if(!img){ alert('Bitte Bild laden.'); return; }
    if(!consentOK()){ alert('Bitte NSFW-Bestätigungen setzen.'); return; }
    const file=$('#file').files?.[0];
    const payload={
      content: $('#content').value,
      stylePreset: $('#preset').value,
      tweaks: $('#tweaks').value.trim(),
      autoMask: $('#autoMask').checked, keepPose: $('#keepPose').checked, clothPhys: $('#clothPhys').checked,
      freePrompt: $('#free').value.trim(),
      areas: sels.map(s=>({ id:s.id, tool:s.type, geom:{x:s.x,y:s.y,w:s.w,h:s.h}, form:s.form||{} })),
      canvas_size:{w:canvas.width,h:canvas.height}
    };
    try{
      setBusy(true,'Starte Job …');
      const start=await postMultipart('/api/wardrobe/apply', payload, {image:file});
      const direct=pickUrl(start); if(direct){ pushResult(direct); setBusy(false,'Fertig (Direkt)'); return; }
      const jobId=start.jobId||start.id||start.job; if(!jobId) throw new Error('Kein jobId');
      setBusy(true,'Warte auf Ergebnis…');
      const job=await pollJob(jobId);
      const url=pickUrl(job); if(!url) throw new Error('Kein Ergebnis-URL');
      pushResult(url); setBusy(false,'Fertig');
    }catch(e){ console.error(e); setBusy(false,'Fehler'); alert('Wardrobe-Fehler: '+(e?.message||e)); }
  });

  function pushResult(url){ const a=document.createElement('button'); a.className='btn'; a.textContent='Result '+new Date().toLocaleTimeString(); const item={url,generated:true}; a.addEventListener('click',()=>openOverlay(item)); $('#results').prepend(a); }
  function openOverlay(item){ if(!item.generated) return; $('#ov-img').src=item.url; $('#ov-dl').href=item.url; $('#ov-dl').download='output.png'; $('#ov').style.display='flex'; }
  $('#ov-close').onclick=()=> $('#ov').style.display='none'; $('#ov-close2').onclick=()=> $('#ov').style.display='none';
})();
</script>
</body>
</html>
