<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wardrobe – AndioMediaStudio</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <style>
    .page-grid{display:grid;grid-template-columns:320px 1fr 380px;gap:12px}
    .card{background:#1112;border:1px solid #333;border-radius:12px;padding:12px}
    .grid{display:grid;gap:8px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{padding:2px 6px;border-radius:8px;background:#222;border:1px solid #444;font-size:12px}
    .canvas-wrap{position:relative;aspect-ratio:1/1;background:#000;border-radius:12px;overflow:hidden}
    .canvas-wrap canvas{width:100%;height:100%;display:block}
    .list{display:flex;flex-direction:column;gap:8px;max-height:42vh;overflow:auto}
    .prompt-item{border:1px dashed #444;border-radius:10px;padding:8px}
    .prompt-item h4{margin:0 0 6px 0;font-size:13px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .toolbar button.active{outline:2px solid #66f}
    small.hint{opacity:.8}
  </style>
</head>
<body>
  <script src="assets/app.js"></script>
  <script>window.Andio?.navbar?.('wardrobe');</script>

  <div class="container">
    <h1>Wardrobe</h1>
    <div class="page-grid">
      <!-- LINKS: Quelle & globale Optionen -->
      <aside class="card">
        <h3>Quelle & Optionen</h3>
        <div class="grid">
          <label class="row">
            <span class="badge">Bild laden</span>
            <input id="fileInput" type="file" accept="image/*"/>
          </label>

          <div class="grid grid-2">
            <label>Inhalt
              <select id="contentSelect">
                <option value="sfw">SFW</option>
                <option value="nsfw">NSFW</option>
              </select>
            </label>
            <label>Stil-Preset
              <select id="stylePreset">
                <option value="realistic">Realistisch / Studio</option>
                <option value="fashion">Fashion Editorial</option>
                <option value="street">Street / Urban</option>
                <option value="glamour">Glamour</option>
              </select>
            </label>
          </div>

          <details id="nsfwConsent" class="card" style="border-style:solid;display:none">
            <summary>NSFW-Bestätigung (erforderlich für z. B. „Nackt“)</summary>
            <label><input type="checkbox" id="ageOk"/> Ich bin 18+.</label>
            <label><input type="checkbox" id="rightsOk"/> Rechte am Bild vorhanden.</label>
            <label><input type="checkbox" id="lawOk"/> Nutzung legal & privat.</label>
          </details>

          <div class="grid">
            <label>Allgemeine Anpassungen
              <input id="tweaks" placeholder="z. B. Farben/Material, Accessoires, Licht"/>
            </label>
          </div>

          <div class="row">
            <button id="btnRandom">Random</button>
            <button id="btnDetect" title="Auto-Erkennung von Kleidung/Körperform">Erkennen</button>
            <button id="btnApply" class="primary">Ausführen</button>
          </div>

          <div class="row">
            <span class="badge">Auto-Maske <input type="checkbox" id="autoMask" checked></span>
            <span class="badge">Pose beibehalten <input type="checkbox" id="keepPose" checked></span>
            <span class="badge">Falten/Physik <input type="checkbox" id="clothPhys"></span>
          </div>
          <small class="hint">„Ausführen“ startet die KI. Oben rechts zeigt der Job-HUD **Stage, % und ETA**.</small>
        </div>
      </aside>

      <!-- MITTE: Canvas & Werkzeuge -->
      <main class="card">
        <div class="toolbar">
          <button data-tool="rect" class="active">Rechteck</button>
          <button data-tool="ellipse">Ellipse</button>
          <button data-tool="lasso">Lasso</button>
          <button data-tool="brush">Pinsel</button>
          <button id="btnClearSel">Auswahlen löschen</button>
          <span class="badge">Zoom: Strg + Mausrad</span>
        </div>
        <div class="canvas-wrap">
          <canvas id="wardrobeCanvas" width="1024" height="1024" aria-label="Vorschau"></canvas>
          <canvas id="maskCanvas" width="1024" height="1024" style="position:absolute;inset:0;pointer-events:none"></canvas>
        </div>
      </main>

      <!-- RECHTS: Bereiche (mit Kategorie & Was/Wie) + Ergebnisse -->
      <aside class="card">
        <h3>Markierte Bereiche (Kleidung)</h3>
        <div id="areas" class="list"></div>

        <div class="row" style="margin-top:6px">
          <button id="btnAddAreaFromCategory">Bereich aus Kategorie hinzufügen</button>
        </div>

        <details open class="card" style="margin-top:10px">
          <summary>Freier Prompt (optional – ohne Filter)</summary>
          <textarea id="freePrompt" rows="5" placeholder="Zusätzliche Anweisungen, die global gelten sollen."></textarea>
        </details>

        <div class="card" style="margin-top:10px">
          <h3>Ergebnisse</h3>
          <div id="results" class="list"></div>
        </div>
      </aside>
    </div>
  </div>

  <footer>© AndioMediaStudio</footer>

  <script>
  (()=> {
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));

    // === State ===
    const state = {
      img:null,
      selections:[], // [{id,type,geom,final,..., form:{piece,action,what,material,color,style}}]
      content:'sfw'
    };

    // === Canvas & Annotator ===
    const canvas = $('#wardrobeCanvas'), maskCanvas = $('#maskCanvas');
    const ctx = canvas.getContext('2d');
    const annot = Andio.tools.attachAnnotator(canvas, maskCanvas, (sels)=>{
      state.selections = sels;
      ensureFormsForSelections();
      renderAreas();
    });

    function drawImage(){
      ctx.clearRect(0,0,1024,1024);
      if (state.img) ctx.drawImage(state.img,0,0,1024,1024);
    }

    // Datei laden
    $('#fileInput').addEventListener('change', ()=>{
      const f = $('#fileInput').files?.[0]; if(!f) return;
      const img = new Image();
      img.onload = ()=>{ state.img=img; drawImage(); annot.markImageLoaded(); };
      img.src = URL.createObjectURL(f);
    });

    // Tools
    $$('.toolbar button[data-tool]').forEach(b=>{
      b.addEventListener('click', ()=>{
        $$('.toolbar button[data-tool]').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        annot.setTool(b.dataset.tool);
      });
    });
    $('#btnClearSel').addEventListener('click', ()=>{ annot.reset(); state.selections=[]; renderAreas(); });

    // Inhalt / NSFW
    const nsfw = $('#nsfwConsent');
    $('#contentSelect').addEventListener('change', e=>{
      state.content = e.target.value;
      nsfw.style.display = state.content==='nsfw' ? 'block' : 'none';
    });
    const consentOk = ()=> state.content!=='nsfw' || ($('#ageOk').checked && $('#rightsOk').checked && $('#lawOk').checked);

    // Random – ergänzt sinnvolle Beispiele
    $('#btnRandom').addEventListener('click', ()=>{
      const kind = $('#contentSelect').value;
      const idea = Andio.randomPrompt('wardrobe', kind) || '';
      const cur = $('#freePrompt').value.trim();
      $('#freePrompt').value = cur ? (cur+'\n'+idea) : idea;

      // Falls noch keine Auswahl, lege eine zentrale an
      if (!state.selections.length){
        annot.state.selections.push({id:1,type:'rect',x:256,y:256,w:512,h:512,final:true});
        state.selections = annot.state.selections;
        ensureFormsForSelections();
        renderAreas(); annot.draw();
      }
    });

    // Auto-Erkennung (Hook)
    $('#btnDetect').addEventListener('click', async ()=>{
      if(!state.img){ alert('Bitte Bild laden.'); return; }
      const {hud} = await Andio.startJobWithHUD('Wardrobe: Erkennung', async ()=>{
        if (Andio.api?.wardrobeDetectStart) return await Andio.api.wardrobeDetectStart();
        return {jobId:'demo_'+Date.now()};
      });
      setTimeout(async ()=>{
        if (Andio.api?.wardrobeDetectFinish){
          const res = await Andio.api.wardrobeDetectFinish();
          alert('Erkennung: '+JSON.stringify(res));
        } else {
          alert('Demo-Erkennung: Oberteil=Bluse, Unterteil=Jeans, Körperform=Mittel');
        }
      }, 200);
    });

    // Bereiche-Formulare sicherstellen
    function ensureFormsForSelections(){
      state.selections.forEach(sel=>{
        sel.form = sel.form || {
          piece: 'oberteil',
          action: 'replace',
          what: '',
          material: '',
          color: '',
          style: ''
        };
      });
    }

    // Bereiche rendern (+ Kategorie/Was/Wie)
    function renderAreas(){
      const host = $('#areas'); host.innerHTML='';
      state.selections.forEach(sel=>{
        const d = document.createElement('div');
        d.className = 'prompt-item';
        d.innerHTML = `
          <h4>Bereich #${sel.id} <span class="badge">${sel.type}</span></h4>
          <div class="grid grid-2">
            <label>Kleidung
              <select data-k="piece">
                <option value="oberteil">Oberteil</option>
                <option value="unterteil">Unterteil</option>
                <option value="kleid">Kleid</option>
                <option value="schuhe">Schuhe</option>
                <option value="accessoires">Accessoires</option>
                <option value="schmuck">Schmuck</option>
                <option value="nude">Nackt (18+)</option>
              </select>
            </label>
            <label>Aktion
              <select data-k="action">
                <option value="keep">Behalten</option>
                <option value="replace">Ersetzen</option>
                <option value="remove">Entfernen</option>
              </select>
            </label>
          </div>
          <div class="grid">
            <label>Was / Wie (Beschreibung)
              <input data-k="what" placeholder="z. B. Lederjacke, schwarz, tailliert; oder ‚Träger entfernen‘"/>
            </label>
          </div>
          <div class="grid grid-3">
            <label>Material
              <input data-k="material" placeholder="z. B. Leder, Seide, Baumwolle"/>
            </label>
            <label>Farbe
              <input data-k="color" placeholder="z. B. schwarz, cremeweiß"/>
            </label>
            <label>Stil
              <input data-k="style" placeholder="z. B. elegant, street, glamour"/>
            </label>
          </div>
        `;
        // Werte zuweisen
        d.querySelector('[data-k="piece"]').value = sel.form.piece;
        d.querySelector('[data-k="action"]').value = sel.form.action;
        d.querySelector('[data-k="what"]').value = sel.form.what;
        d.querySelector('[data-k="material"]').value = sel.form.material;
        d.querySelector('[data-k="color"]').value = sel.form.color;
        d.querySelector('[data-k="style"]').value = sel.form.style;

        // Änderungen zurück in State
        d.querySelectorAll('[data-k]').forEach(inp=>{
          inp.addEventListener('input', ()=>{
            const k = inp.dataset.k, v = inp.value;
            sel.form[k] = v;

            // Wenn „Nackt“ gewählt wird → NSFW erzwingen
            if (k==='piece' && v==='nude'){
              $('#contentSelect').value = 'nsfw';
              state.content = 'nsfw';
              $('#nsfwConsent').style.display = 'block';
            }
          });
        });

        host.appendChild(d);
      });

      if (!state.selections.length){
        const empty = document.createElement('div');
        empty.className='prompt-item';
        empty.innerHTML = `<i>Noch keine markierten Bereiche. Markiere mit <b>Rechteck / Ellipse / Lasso / Pinsel</b> die Kleidung, die du ändern willst.</i>`;
        host.appendChild(empty);
      }
    }

    // Schnellbereich aus Kategorie (ohne Zeichnen)
    $('#btnAddAreaFromCategory').addEventListener('click', ()=>{
      const id = (state.selections?.length||0)+1;
      // mittig platzieren
      const sel = {id, type:'rect', x:256, y:256, w:512, h:512, final:true};
      annot.state.selections.push(sel);
      state.selections = annot.state.selections;
      ensureFormsForSelections();
      renderAreas(); annot.draw();
    });

    // Ausführen (mit Job-HUD & optionalem Backend)
    $('#btnApply').addEventListener('click', async ()=>{
      if(!state.img){ alert('Bitte Bild laden.'); return; }
      if(!consentOk()){ alert('Bitte NSFW-Bestätigungen setzen.'); return; }

      const payload = {
        content: state.content,
        style: $('#stylePreset').value,
        tweaks: $('#tweaks').value,
        autoMask: $('#autoMask').checked,
        keepPose: $('#keepPose').checked,
        clothPhys: $('#clothPhys').checked,
        prompt: $('#freePrompt').value,
        selections: state.selections.map(s=>({
          id:s.id, type:s.type,
          // Geometrie mit
          x:s.x, y:s.y, w:s.w, h:s.h, points:s.points,
          form: s.form
        }))
      };

      const {hud} = await Andio.startJobWithHUD('Wardrobe: Anwenden', async ()=>{
        if (Andio.api?.wardrobeApplyStart){
          return await Andio.api.wardrobeApplyStart(payload); // -> {jobId}
        }
        return {jobId:'demo_'+Date.now()};
      });

      // Ergebnis holen (Demo oder echter Finish-Call)
      setTimeout(async ()=>{
        try{
          let out=null;
          if (Andio.api?.wardrobeApplyFinish){
            out = await Andio.api.wardrobeApplyFinish(); // -> {files:[{url,type,name,generated:true}]}
          } else {
            out = {files:[{url:'assets/placeholders/wardrobe_result.jpg', type:'image', name:'wardrobe.jpg', generated:true}]};
          }
          addResults(out.files||[]);
        }catch(e){ console.error(e); }
      }, 250);
    });

    function addResults(files){
      const list = $('#results');
      files.forEach(f=>{
        const card = document.createElement('div');
        card.className='prompt-item';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <b>${f.name||'Output'}</b>
            <span class="badge">${(f.type||'image').toUpperCase()}</span>
          </div>
          ${f.type==='video'
            ? `<video src="${f.url}" data-generated="${!!f.generated}" controls muted playsinline style="max-width:100%"></video>`
            : `<img src="${f.url}" data-generated="${!!f.generated}" alt="Ergebnis" style="max-width:100%"/>`
          }
        `;
        list.prepend(card);
      });
    }

    // Init
    drawImage(); renderAreas();
  })();
  </script>

  <script>window.Andio?.polish?.();</script>
</body>
</html>
