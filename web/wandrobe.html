<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wardrobe · AndioMediaStudio</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <style>
    /* kleines Marker-Element für Objekt-Position */
    .pos-marker{position:absolute; width:12px; height:12px; border-radius:50%;
      background:radial-gradient(circle, rgba(255,255,255,.95) 0 35%, rgba(102,163,255,.9) 36% 65%, transparent 66%);
      box-shadow:0 0 12px rgba(102,163,255,.55); pointer-events:none; transform:translate(-50%,-50%); z-index:4}
    .mask-tools .seg{display:flex; gap:8px; align-items:center}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(140,160,210,.25)}
  </style>
</head>
<body>
<script src="assets/app.js"></script>
<script>
  // robust: unterstützt beide Versionen deines app.js (injectNavbar oder navbar)
  if (window.Andio?.injectNavbar) Andio.injectNavbar('wardrobe');
  else if (window.Andio?.navbar) Andio.navbar('wardrobe');
</script>

<div class="container">
  <h1>Wardrobe</h1>

  <div class="grid cols-2">
    <!-- LINKES PANEL: Workflow & Parameter -->
    <div class="card">
      <h3>Workflow</h3>

      <!-- Step 1: Quelle -->
      <section>
        <div class="pill">
          <strong>1) Quelle</strong><span class="badge">Bild laden</span>
        </div>
        <div class="grid cols-2" style="margin-top:10px">
          <div>
            <label>Bild-Datei</label>
            <input id="file" type="file" accept="image/*" class="input"/>
            <small class="badge" style="margin-top:6px">Drag & Drop ins Vorschaufenster möglich</small>
          </div>
          <div>
            <label>Auto-Segmentierung</label>
            <div class="seg">
              <label class="pill"><input id="segCloth" type="checkbox"> Kleidung</label>
              <label class="pill"><input id="segPerson" type="checkbox"> Person</label>
            </div>
            <small class="help">Wenn aktiv, nutzt der Server (falls verfügbar) passende Masken (z. B. Cloth-/Person-Segmentation).</small>
          </div>
        </div>
      </section>
      <hr/>

      <!-- Step 2: Modus -->
      <section>
        <div class="pill">
          <strong>2) Modus</strong><span class="badge">Bearbeitungsart wählen</span>
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn mode primary" data-mode="clothing">Clothing Edit</button>
          <button class="btn mode" data-mode="objects">Object Insert</button>
          <button class="btn mode" data-mode="style">Style Transfer</button>
        </div>

        <!-- Clothing -->
        <div data-pane="clothing" style="margin-top:12px">
          <div class="grid cols-2">
            <div>
              <label>Outfit-Preset</label>
              <select id="outfit" class="input">
                <option>Casual</option>
                <option>Business</option>
                <option>Sport</option>
                <option>Abendkleid</option>
                <option>Streetwear</option>
              </select>
            </div>
            <div>
              <label>Farbe</label>
              <div class="row">
                <input id="colorText" class="input" placeholder="z. B. Schwarz, Navy, Weinrot"/>
                <input id="colorPick" type="color" value="#111111" style="width:56px;height:42px;border:0;border-radius:10px"/>
              </div>
            </div>
            <div>
              <label>Material</label>
              <select id="material" class="input">
                <option>Baumwolle</option><option>Leder</option><option>Seide</option><option>Denim</option><option>Leinen</option>
              </select>
            </div>
            <div>
              <label>Passform</label>
              <select id="fit" class="input">
                <option>Regulär</option><option>Eng</option><option>Oversized</option>
              </select>
            </div>
            <div>
              <label>Abdeckung</label>
              <input id="coverage" type="range" min="0" max="100" value="70"/>
              <small class="help">Wie stark alte Kleidung überdeckt/ersetzt wird.</small>
            </div>
            <div>
              <label>Realismus</label>
              <input id="realism" type="range" min="0" max="10" value="8"/>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <label class="pill"><input id="useMask" type="checkbox"> Maskenwerkzeug nutzen</label>
          </div>
        </div>

        <!-- Objects -->
        <div data-pane="objects" style="display:none; margin-top:12px">
          <div class="grid cols-2">
            <div>
              <label>Objekt / Accessoire</label>
              <input id="obj" class="input" placeholder="z. B. Halskette, Hut, Armband, Tattoo"/>
            </div>
            <div>
              <label>Stärke</label>
              <input id="strength" type="range" min="0" max="1" step="0.05" value="0.65"/>
            </div>
            <div>
              <label>Größe</label>
              <input id="scale" type="range" min="0.1" max="3" step="0.05" value="1"/>
            </div>
            <div>
              <label>Rotation</label>
              <input id="rotation" type="range" min="-180" max="180" step="1" value="0"/>
            </div>
          </div>
          <small class="badge" style="margin-top:6px">Tipp: Klicke in die Vorschau, um die Position zu setzen.</small>
        </div>

        <!-- Style -->
        <div data-pane="style" style="display:none; margin-top:12px">
          <div class="grid cols-2">
            <div>
              <label>Stil</label>
              <select id="style" class="input">
                <option>Realistic</option><option>Cinematic</option><option>Analog Film</option><option>Anime</option><option>Illustration</option>
              </select>
            </div>
            <div>
              <label>Denoise</label>
              <input id="denoise" type="range" min="0" max="1" step="0.05" value="0.35"/>
            </div>
            <div>
              <label>Style-Stärke</label>
              <input id="styleStrength" type="range" min="0" max="1" step="0.05" value="0.6"/>
            </div>
          </div>
        </div>
      </section>
      <hr/>

      <!-- Step 3: Parameter -->
      <section>
        <div class="pill">
          <strong>3) Parameter</strong><span class="badge">Modell & Qualität</span>
        </div>
        <div class="grid cols-2" style="margin-top:10px">
          <div>
            <label>Modell</label>
            <select id="model" class="input">
              <option>sdxl-real</option>
              <option>realvis</option>
              <option>anime-v4</option>
            </select>
          </div>
          <div>
            <label>NSFW-Modus</label>
            <select id="nsfw" class="input">
              <option value="off">Off</option>
              <option value="soft">Soft</option>
              <option value="artistic">Artistic</option>
            </select>
          </div>
          <div>
            <label>Schritte (Steps)</label>
            <input id="steps" type="number" value="28" class="input"/>
          </div>
          <div>
            <label>Guidance</label>
            <input id="guidance" type="number" step="0.1" value="7.5" class="input"/>
          </div>
          <div>
            <label>Seed</label>
            <input id="seed" type="number" placeholder="leer = zufällig" class="input"/>
          </div>
        </div>
      </section>
      <hr/>

      <!-- Step 4: Aktionen -->
      <section>
        <div class="pill">
          <strong>4) Ausführen</strong><span class="badge">Generieren & Speichern</span>
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button id="btn-apply" class="btn primary">Anwenden / Generieren</button>
          <button id="btn-save" class="btn ok">Download</button>
          <button id="btn-reset" class="btn">Zurücksetzen</button>
        </div>
      </section>
    </div>

    <!-- RECHTES PANEL: Vorschau + Werkzeuge -->
    <div class="card">
      <h3>Vorschau</h3>
      <div id="preview" class="preview" style="min-height:420px">
        <div class="progress"><div></div></div>
        <!-- mask tools schwebend -->
        <div class="mask-tools" id="maskTools" style="display:none">
          <button id="mt-draw"   class="btn">Pinsel</button>
          <button id="mt-erase"  class="btn">Radierer</button>
          <input  id="mt-size"   type="range" min="6" max="64" value="24" />
          <input  id="mt-feather"type="range" min="0" max="40" value="8" />
          <button id="mt-invert" class="btn">Invert</button>
          <button id="mt-clear"  class="btn">Clear</button>
          <button id="mt-toggle" class="btn">Maske zeigen/verbergen</button>
          <button id="mt-export" class="btn">Maske exportieren (PNG)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>© AndioMediaStudio</footer>

<script>
/* =============== Hilfsobjekte =============== */
const {$, $$, Progress} = window.Andio || {};
const pm = new Progress($('#preview'));
let mode = 'clothing';
let clickPos = null;       // normierte Position (0..1), nur für Objects
let mask;                  // MaskCanvas-Instanz
let maskVisible = true;
let lastImageURL = null;

/* =============== Einfache Masken-Canvas =============== */
class MaskCanvas {
  constructor(container){
    this.container = container;
    this.canvas = document.createElement('canvas');
    this.canvas.className = 'mask';
    this.ctx = this.canvas.getContext('2d');
    this.brush = { size: 24, feather: 8, mode: 'draw' }; // draw|erase
    this.visible = true;
    this._active = false;
    container.appendChild(this.canvas);
    this.resize();
    window.addEventListener('resize', ()=>this.resize());
    this.canvas.addEventListener('mousedown', (e)=>this.start(e));
    window.addEventListener('mousemove', (e)=>this.move(e));
    window.addEventListener('mouseup', ()=>this.stop());
  }
  resize(){
    const r = this.container.getBoundingClientRect();
    this.canvas.width = Math.max(1, r.width);
    this.canvas.height = Math.max(1, r.height);
  }
  rel(e){
    const b = this.canvas.getBoundingClientRect();
    return { x: e.clientX - b.left, y: e.clientY - b.top };
  }
  start(e){ this._active = true; this.draw(e); }
  move(e){ if(!this._active) return; this.draw(e); }
  stop(){ this._active = false; }
  draw(e){
    const {x,y} = this.rel(e);
    const g = this.ctx.createRadialGradient(x, y, Math.max(1, this.brush.size - this.brush.feather), x, y, this.brush.size);
    const col = (this.brush.mode === 'draw') ? 'rgba(255,255,255,1)' : 'rgba(0,0,0,1)';
    g.addColorStop(0, col);
    g.addColorStop(1, 'rgba(255,255,255,0)');
    this.ctx.globalCompositeOperation = (this.brush.mode === 'draw') ? 'source-over' : 'destination-out';
    this.ctx.fillStyle = g;
    this.ctx.beginPath();
    this.ctx.arc(x, y, this.brush.size, 0, Math.PI*2);
    this.ctx.fill();
  }
  setSize(s){ this.brush.size = s; }
  setFeather(f){ this.brush.feather = f; }
  setMode(m){ this.brush.mode = m; }
  clear(){ this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); }
  invert(){
    const img = this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);
    const d = img.data;
    for(let i=0;i<d.length;i+=4){ d[i]=255-d[i]; d[i+1]=255-d[i+1]; d[i+2]=255-d[i+2]; /* keep alpha */ }
    this.ctx.putImageData(img,0,0);
  }
  toggle(){
    this.visible = !this.visible;
    this.canvas.style.opacity = this.visible ? '0.6' : '0.0';
    this.canvas.style.pointerEvents = this.visible ? 'auto' : 'none';
  }
  toDataURL(){ return this.canvas.toDataURL('image/png'); }
}

/* =============== UI BINDINGS =============== */
function setMode(m){
  mode = m;
  $$('.mode').forEach(b => b.classList.toggle('primary', b.dataset.mode===m));
  $$('[data-pane]').forEach(p => p.style.display = (p.dataset.pane===m) ? 'block' : 'none');
  // Maskentools nur im Clothing-Modus optional sichtbar
  updateMaskToolsVisibility();
}

function updateMaskToolsVisibility(){
  const tools = $('#maskTools');
  const wantMask = $('#useMask')?.checked;
  tools.style.display = (mode==='clothing' && wantMask) ? 'flex' : 'none';
  if(mode==='clothing' && wantMask && !mask){ mask = new MaskCanvas($('#preview')); }
  if(!(mode==='clothing' && wantMask) && mask){ mask.canvas.remove(); mask = null; }
}

$$('.mode').forEach(b => b.addEventListener('click', ()=> setMode(b.dataset.mode)));
$('#useMask')?.addEventListener('change', updateMaskToolsVisibility);

// Masken-Buttons
$('#mt-draw').addEventListener('click', ()=> mask?.setMode('draw'));
$('#mt-erase').addEventListener('click', ()=> mask?.setMode('erase'));
$('#mt-size').addEventListener('input', e => mask?.setSize(+e.target.value));
$('#mt-feather').addEventListener('input', e => mask?.setFeather(+e.target.value));
$('#mt-invert').addEventListener('click', ()=> mask?.invert());
$('#mt-clear').addEventListener('click',  ()=> mask?.clear());
$('#mt-toggle').addEventListener('click', ()=> mask?.toggle());
$('#mt-export').addEventListener('click', ()=>{
  if(!mask) return;
  const a = document.createElement('a');
  a.href = mask.toDataURL();
  a.download = 'wardrobe_mask.png';
  a.click();
});

// Datei laden (auch per Drag & Drop)
function putImage(url){
  lastImageURL = url;
  let img = $('#preview img');
  if(!img){ img = document.createElement('img'); $('#preview').appendChild(img); }
  img.src = url;
}
$('#file').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  putImage(URL.createObjectURL(f));
});
$('#preview').addEventListener('dragover', e=>{ e.preventDefault(); });
$('#preview').addEventListener('drop', e=>{
  e.preventDefault();
  const f = e.dataTransfer.files?.[0]; if(f && f.type.startsWith('image')) putImage(URL.createObjectURL(f));
});

// Positionsmarker bei Object-Insert
const marker = document.createElement('div');
marker.className = 'pos-marker'; marker.style.display = 'none';
$('#preview').appendChild(marker);

$('#preview').addEventListener('click', (e)=>{
  if(mode!=='objects') return;
  const r = e.currentTarget.getBoundingClientRect();
  const x = (e.clientX - r.left) / r.width;
  const y = (e.clientY - r.top)  / r.height;
  clickPos = { x:+x.toFixed(4), y:+y.toFixed(4) };
  marker.style.display = 'block';
  marker.style.left = (x*100)+'%';
  marker.style.top  = (y*100)+'%';
});

// Farbe synchronisieren (Text <-> Picker)
$('#colorPick').addEventListener('input', e => $('#colorText').value = e.target.value);
$('#colorText').addEventListener('change', e => { try{ $('#colorPick').value = e.target.value; }catch(_){} });

/* =============== GENERIEREN (Demo + Payload) =============== */
function assemblePayload(){
  const payload = {
    mode,
    model: $('#model').value,
    nsfw: $('#nsfw').value,                   // off|soft|artistic
    steps: +$('#steps').value,
    guidance: +$('#guidance').value,
    seed: $('#seed').value ? +$('#seed').value : Math.floor(Math.random()*1e9),
    segmentation: {
      cloth: !!$('#segCloth').checked,
      person: !!$('#segPerson').checked
    },
    image: lastImageURL || null
  };
  if(mode==='clothing'){
    payload.clothing = {
      preset: $('#outfit').value,
      color: $('#colorText').value || $('#colorPick').value,
      material: $('#material').value,
      fit: $('#fit').value,
      coverage: +$('#coverage').value,
      realism: +$('#realism').value,
      mask: (mask ? mask.toDataURL() : null)
    };
  } else if(mode==='objects'){
    payload.objects = {
      name: $('#obj').value,
      strength: +$('#strength').value,
      scale: +$('#scale').value,
      rotation: +$('#rotation').value,
      position: clickPos
    };
  } else if(mode==='style'){
    payload.style = {
      preset: $('#style').value,
      denoise: +$('#denoise').value,
      strength: +$('#styleStrength').value
    };
  }
  return payload;
}

async function demoRender(payload){
  await pm.fake(2000);
  const c = document.createElement('canvas'); c.width = 640; c.height = 360;
  const ctx = c.getContext('2d');
  // Hintergrund & Overlay
  ctx.fillStyle = '#0b1220'; ctx.fillRect(0,0,640,360);
  ctx.fillStyle = 'rgba(255,255,255,.92)';
  ctx.font = 'bold 18px ui-monospace,monospace';
  ctx.fillText(`WARDROBE · ${payload.mode}`, 16, 28);
  ctx.font = '14px ui-monospace,monospace';
  ctx.fillText(`model=${payload.model} · nsfw=${payload.nsfw} · seed=${payload.seed}`, 16, 52);
  if(payload.mode==='clothing'){
    const c1 = payload.clothing;
    ctx.fillText(`preset=${c1.preset} color=${c1.color} fit=${c1.fit}`, 16, 76);
    ctx.fillText(`coverage=${c1.coverage} realism=${c1.realism}`, 16, 96);
  } else if(payload.mode==='objects'){
    const o = payload.objects;
    ctx.fillText(`obj=${o.name} strength=${o.strength} scale=${o.scale} rot=${o.rotation}`, 16, 76);
    ctx.fillText(`pos=${JSON.stringify(o.position)}`, 16, 96);
  } else if(payload.mode==='style'){
    const s = payload.style;
    ctx.fillText(`style=${s.preset} denoise=${s.denoise} strength=${s.strength}`, 16, 76);
  }
  const url = c.toDataURL('image/png');
  let img = $('#preview img'); if(!img){ img = document.createElement('img'); $('#preview').appendChild(img); }
  img.src = url;
  return url;
}

/* =============== Buttons =============== */
$('#btn-apply').addEventListener('click', async ()=>{
  const payload = assemblePayload();
  // Falls eine Andio-API existiert, könntest du hier auf echtes Backend schicken:
  // if (window.Andio?.API?.createJob) { await Andio.API.createJob(payload); ... }
  await demoRender(payload);
});

$('#btn-save').addEventListener('click', ()=>{
  const img = $('#preview img'); if(!img){ return alert('Nichts zu speichern.'); }
  const a = document.createElement('a'); a.href = img.src; a.download = 'wardrobe_result.png'; a.click();
});

$('#btn-reset').addEventListener('click', ()=>{
  // UI-Reset (einfach gehalten)
  $('#colorText').value = ''; $('#colorPick').value = '#111111';
  $('#fit').value = 'Regulär'; $('#coverage').value = 70; $('#realism').value = 8;
  $('#obj').value = ''; $('#strength').value = 0.65; $('#scale').value = 1; $('#rotation').value = 0;
  $('#style').value = 'Realistic'; $('#denoise').value = 0.35; $('#styleStrength').value = 0.6;
  $('#steps').value = 28; $('#guidance').value = 7.5; $('#seed').value = '';
  $('#segCloth').checked = false; $('#segPerson').checked = false;
  $('#useMask').checked = false; updateMaskToolsVisibility();
  clickPos = null; marker.style.display = 'none';
  const img = $('#preview img'); if(img) img.remove();
  if(lastImageURL) URL.revokeObjectURL(lastImageURL); lastImageURL = null;
});

/* Initial-Modus */
setMode('clothing');
</script>

<script>
  // polishes (Glass, Hover, Tilt, Ripple, Reveal) – falls in deinem app.js vorhanden
  if (window.Andio?.polish) Andio.polish();
</script>
</body>
</html>
